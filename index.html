<!DOCTYPE html>
<!-- saved from url=(0066)file:///Users/traecott/Downloads/simplifi-command-center-v8_4.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simpli.fi ‚Äî Command Center</title>
<link href="./Simpli.fi ‚Äî Command Center-V11_files/css2" rel="stylesheet">
<style>
:root {
  --bg:#000;--surface:#0d0d0d;--s2:#111;--s3:#161616;--s4:#1a1a1a;
  --b:#1e1e1e;--b2:#2a2a2a;--b3:#333;
  --white:#fff;--text:#e0e0e0;--t2:#888;--t3:#444;--t4:#2a2a2a;
  --green:#3dff9a;--red:#ff3d3d;--yellow:#ffd24d;--blue:#4da6ff;--purple:#b06dff;
  --mono:'DM Mono',monospace;--sans:'DM Sans',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{font-size:17px;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
.app{display:flex;min-height:100vh;}

/* SIDEBAR */
.sidebar{width:200px;background:var(--surface);border-right:1px solid var(--b);position:fixed;left:0;top:0;bottom:0;z-index:200;display:flex;flex-direction:column;overflow-y:auto;}
.logo{padding:18px 16px 14px;border-bottom:1px solid var(--b);}
.logo-name{font-family:var(--mono);font-size:.9rem;color:var(--white);letter-spacing:.04em;}
.logo-sub{font-family:var(--mono);font-size:.55rem;color:var(--t3);margin-top:2px;text-transform:uppercase;letter-spacing:.12em;}
.nav{flex:1;padding:8px 0;}
.ng{padding:10px 16px 3px;font-family:var(--mono);font-size:.52rem;color:var(--t3);text-transform:uppercase;letter-spacing:.14em;}
.ni{display:flex;align-items:center;gap:8px;padding:7px 16px;cursor:pointer;font-size:.78rem;color:var(--t2);border-left:2px solid transparent;transition:all .1s;}
.ni:hover{color:var(--white);background:var(--s2);}
.ni.active{color:var(--white);border-left-color:var(--white);background:var(--s2);}
.ni-icon{font-size:.8rem;width:14px;text-align:center;flex-shrink:0;}
.nb{margin-left:auto;background:var(--white);color:#000;font-family:var(--mono);font-size:.55rem;padding:1px 5px;border-radius:6px;}
.sfoot{padding:10px 16px;border-top:1px solid var(--b);}
.clock{font-family:var(--mono);font-size:.9rem;color:var(--t2);}
.clock-sub{font-family:var(--mono);font-size:.55rem;color:var(--t3);margin-top:1px;}

/* MAIN */
.main{margin-left:200px;flex:1;}
.topbar{padding:14px 26px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;background:var(--surface);position:sticky;top:0;z-index:100;}
.tb-l{display:flex;flex-direction:column;gap:2px;}
.tb-title{font-family:var(--mono);font-size:.9rem;color:var(--white);}
.tb-sub{font-family:var(--mono);font-size:.55rem;color:var(--t3);}
.tb-r{display:flex;gap:6px;align-items:center;}
.content{padding:22px 26px;}
.page{display:none;}
.page.active{display:block;animation:fi .2s ease;}
@keyframes fi{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

/* BUTTONS */
.btn{padding:5px 12px;border-radius:3px;font-family:var(--mono);font-size:.68rem;cursor:pointer;border:1px solid var(--b2);background:var(--s2);color:var(--text);transition:all .1s;white-space:nowrap;}
.btn:hover{border-color:var(--white);color:var(--white);}
.btn-w{background:var(--white);color:#000;border-color:var(--white);}
.btn-w:hover{background:#ddd;border-color:#ddd;color:#000;}
.btn-sm{padding:3px 8px;font-size:.62rem;}
.btn-danger{border-color:var(--red);color:var(--red);}
.btn-danger:hover{background:var(--red);color:#000;}
.btn-green{border-color:var(--green);color:var(--green);}
.btn-green:hover{background:var(--green);color:#000;}

/* STATS */
.sg{display:grid;gap:10px;margin-bottom:18px;}
.s4{grid-template-columns:repeat(4,1fr);}
.s3{grid-template-columns:repeat(3,1fr);}
.s5{grid-template-columns:repeat(5,1fr);}
.s6{grid-template-columns:repeat(6,1fr);}
.s2g{grid-template-columns:repeat(2,1fr);}
.stat{background:var(--surface);border:1px solid var(--b);border-radius:4px;padding:12px 14px;}
.sl{font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;}
.sv{font-family:var(--mono);font-size:1.4rem;color:var(--white);}
.ss{font-size:.7rem;color:var(--t2);margin-top:3px;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--b);border-radius:4px;overflow:hidden;margin-bottom:18px;}
.ch{padding:10px 14px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;background:var(--s2);}
.ct{font-family:var(--mono);font-size:.75rem;color:var(--white);}
.cb{padding:12px 14px;}

/* TABLE */
.tbl{background:var(--surface);border:1px solid var(--b);border-radius:4px;overflow:hidden;margin-bottom:18px;}
.tbl table{width:100%;border-collapse:collapse;}
.tbl th{padding:8px 12px;text-align:left;font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;border-bottom:1px solid var(--b);background:var(--s2);}
.tbl td{padding:9px 12px;font-size:.78rem;border-bottom:1px solid var(--b);vertical-align:middle;}
.tbl tr:last-child td{border-bottom:none;}
.tbl tr:hover td{background:var(--s2);cursor:pointer;}

/* BADGE */
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:2px;font-family:var(--mono);font-size:.57rem;white-space:nowrap;}
.bdot{width:4px;height:4px;border-radius:50%;}
.s-cold{border:1px solid #2a2a2a;color:#555;}
.s-attempted{border:1px solid #3a3000;color:var(--yellow);}
.s-warm{border:1px solid #3a2000;color:#ff9933;}
.s-followup{border:1px solid #003040;color:var(--blue);}
.s-proposal{border:1px solid #2a0050;color:var(--purple);}
.s-revision{border:1px solid #400030;color:#ff77bb;}
.s-table{border:1px solid #003322;color:var(--green);}
.s-hold{border:1px solid #2a2a2a;color:#666;}
.s-won{border:1px solid #003322;color:var(--green);}
.s-lost{border:1px solid #400000;color:var(--red);}
.s-active{border:1px solid #003322;color:var(--green);}
.s-agency{border:1px solid #3a2000;color:#ff9933;}
.cold-f{font-family:var(--mono);font-size:.57rem;color:var(--red);border:1px solid #400000;padding:1px 5px;border-radius:2px;}

/* FILTERS / SEARCH */
.filters{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap;}
.filt{padding:3px 9px;border-radius:2px;font-family:var(--mono);font-size:.6rem;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--t2);transition:all .1s;}
.filt:hover{border-color:var(--white);color:var(--white);}
.filt.active{background:var(--white);color:#000;border-color:var(--white);}
.search{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--b);border-radius:3px;padding:6px 11px;margin-bottom:10px;}
.search input{background:none;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:.75rem;width:100%;}
.search input::placeholder{color:var(--t3);}

/* FORMS */
.fg{display:flex;flex-direction:column;gap:4px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.fgrid .full{grid-column:1/-1;}
.fl{font-family:var(--mono);font-size:.55rem;color:var(--t2);text-transform:uppercase;letter-spacing:.08em;}
.fi,.fs,.fta{background:var(--s2);border:1px solid var(--b2);border-radius:3px;padding:6px 9px;color:var(--text);font-family:var(--mono);font-size:.75rem;outline:none;width:100%;transition:border-color .1s;}
.fi:focus,.fs:focus,.fta:focus{border-color:var(--white);}
.fs option{background:var(--s2);}
.fta{resize:vertical;min-height:65px;line-height:1.5;}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--b2);border-radius:6px;width:540px;max-width:96vw;max-height:92vh;overflow-y:auto;animation:mIn .15s ease;}
.modal.wide{width:660px;}
.modal.xwide{width:820px;}
@keyframes mIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.mh{padding:14px 18px 11px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;}
.mt{font-family:var(--mono);font-size:.85rem;color:var(--white);}
.mc{background:none;border:none;color:var(--t2);cursor:pointer;font-size:.95rem;padding:2px 6px;}
.mc:hover{color:var(--white);}
.mb{padding:14px 18px;}
.mf{padding:10px 18px;border-top:1px solid var(--b);display:flex;justify-content:flex-end;gap:7px;}

/* PRIORITY / TODO */
.pri{display:flex;align-items:flex-start;gap:9px;padding:8px 0;border-bottom:1px solid var(--b);}
.pri:last-child{border-bottom:none;}
.pri-n{font-family:var(--mono);font-size:.62rem;color:var(--t3);min-width:18px;}
.pri-info{flex:1;}
.pri-name{font-size:.8rem;color:var(--white);}
.pri-reason{font-size:.7rem;color:var(--t2);margin-top:1px;}
.pri-act{font-family:var(--mono);font-size:.55rem;padding:2px 6px;border-radius:2px;flex-shrink:0;}
.pa-call{border:1px solid #003322;color:var(--green);}
.pa-prop{border:1px solid #3a2000;color:#ff9933;}
.pa-fu{border:1px solid #003040;color:var(--blue);}
.todo-item{display:flex;align-items:flex-start;gap:9px;padding:9px 0;border-bottom:1px solid var(--b);}
.todo-item:last-child{border-bottom:none;}
.tcb{width:14px;height:14px;border:1px solid var(--b3);border-radius:2px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:1px;}
.tcb.checked{background:var(--white);border-color:var(--white);}
.tcb.checked::after{content:'‚úì';font-size:.55rem;color:#000;font-weight:700;}
.ttxt{font-size:.79rem;flex:1;line-height:1.4;}
.ttxt.done{text-decoration:line-through;color:var(--t3);}
.tmeta{font-family:var(--mono);font-size:.58rem;color:var(--t3);margin-top:2px;}
.ttag{padding:1px 5px;border-radius:2px;font-family:var(--mono);font-size:.55rem;}
.tt-cold{border:1px solid #003322;color:var(--green);}
.tt-prop{border:1px solid #2a0050;color:var(--purple);}
.tt-man{border:1px solid var(--b2);color:#555;}
.tt-auto{border:1px solid #3a2000;color:#ff9933;}
.tt-meet{border:1px solid #003040;color:var(--blue);}

/* AGENCY TREE */
.ab{background:var(--surface);border:1px solid var(--b);border-radius:4px;margin-bottom:8px;overflow:hidden;}
.ar{padding:11px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
.ar:hover{background:var(--s2);}
.ach{border-top:1px solid var(--b);background:var(--s2);display:none;}
.acr{display:flex;align-items:center;gap:9px;padding:8px 14px 8px 26px;border-bottom:1px solid var(--b);font-size:.78rem;}
.acr:last-child{border-bottom:none;}
.acc{width:9px;height:9px;border-left:1px solid var(--b2);border-bottom:1px solid var(--b2);border-radius:0 0 0 3px;flex-shrink:0;margin-top:-4px;}
.chev{font-family:var(--mono);font-size:.6rem;color:var(--t3);transition:transform .15s;}
.chev.open{transform:rotate(90deg);}

/* AI BOX */
.ai-box{background:var(--s2);border:1px solid var(--b2);border-radius:3px;padding:10px 12px;margin-top:10px;}
.ai-l{font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:7px;}
.ai-out{font-family:var(--mono);font-size:.72rem;color:var(--t2);line-height:1.7;white-space:pre-wrap;}
.tcursor{display:inline-block;width:2px;height:11px;background:var(--white);margin-left:2px;animation:blink 1s infinite;vertical-align:middle;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* INTEGRATION STEPS */
.step{display:flex;gap:9px;padding:9px 11px;background:var(--s2);border:1px solid var(--b);border-radius:3px;margin-bottom:7px;}
.sn{font-family:var(--mono);font-size:.62rem;color:var(--white);background:var(--s4);border:1px solid var(--b2);width:18px;height:18px;border-radius:2px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sn.done{background:var(--white);color:#000;}
.sb{flex:1;}
.st-title{font-family:var(--mono);font-size:.72rem;color:var(--white);margin-bottom:2px;}
.st-desc{font-size:.73rem;color:var(--t2);line-height:1.5;}
.st-desc code{font-family:var(--mono);font-size:.65rem;background:var(--s4);padding:1px 4px;border-radius:2px;}

/* EMPTY */
.empty{text-align:center;padding:30px 20px;color:var(--t3);font-family:var(--mono);font-size:.72rem;}

/* TOAST */
.toast{position:fixed;bottom:18px;right:18px;background:var(--surface);border:1px solid var(--b2);border-left:2px solid var(--white);border-radius:3px;padding:9px 13px;font-family:var(--mono);font-size:.72rem;color:var(--text);z-index:900;transform:translateY(50px);opacity:0;transition:all .22s;max-width:260px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.err{border-left-color:var(--red);}
.toast.ok{border-left-color:var(--green);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUDGET & FORECAST ‚Äî FULLY CUSTOM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.budget-wrap{overflow-x:auto;border:1px solid var(--b);border-radius:4px;background:var(--surface);}
.budget-table{border-collapse:collapse;min-width:100%;}
.budget-table th{padding:7px 10px;font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid var(--b);border-right:1px solid var(--b);background:var(--s2);text-align:right;white-space:nowrap;}
.budget-table th.left{text-align:left;}
.budget-table th.group-prog{background:#0a1a0a;color:var(--green);border-bottom:2px solid var(--green);}
.budget-table th.group-omni{background:#0a0a1a;color:var(--blue);border-bottom:2px solid var(--blue);}
.budget-table th.group-total{background:#1a1a0a;color:var(--yellow);border-bottom:2px solid var(--yellow);}
.budget-table td{padding:6px 10px;font-family:var(--mono);font-size:.72rem;border-bottom:1px solid var(--b);border-right:1px solid var(--b);text-align:right;vertical-align:middle;}
.budget-table td.left{text-align:left;}
.budget-table td:last-child,.budget-table th:last-child{border-right:none;}
.budget-table tr:hover td{background:var(--s2);}
.budget-table tr.section-header td{background:var(--s4);font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;padding:4px 10px;}
.budget-table tr.total-row td{background:var(--s2);color:var(--white);font-weight:500;border-top:1px solid var(--b2);}
.budget-table tr.margin-row td{background:#050f05;color:var(--green);}
.budget-table tr.commission-row td{background:#050505;color:var(--yellow);}
.budget-table tr.grand-row td{background:var(--s4);color:var(--white);font-weight:500;}
.bi{background:transparent;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:.72rem;text-align:right;width:72px;padding:1px 3px;}
.bi:focus{background:var(--s4);border:1px solid var(--b2);border-radius:2px;}
.bi::placeholder{color:var(--t4);}
.month-tab-row{display:flex;overflow-x:auto;border-bottom:1px solid var(--b);background:var(--s2);}
.mtab{padding:8px 14px;font-family:var(--mono);font-size:.62rem;cursor:pointer;color:var(--t3);border-bottom:2px solid transparent;white-space:nowrap;transition:all .1s;flex-shrink:0;}
.mtab:hover{color:var(--text);}
.mtab.active{color:var(--white);border-bottom-color:var(--white);}
.prod-tag{display:inline-block;padding:1px 5px;border-radius:2px;font-family:var(--mono);font-size:.55rem;margin:1px 2px;}
.pt-prog{background:#0a1a0a;color:var(--green);border:1px solid #1a3a1a;}
.pt-omni{background:#0a0a1a;color:var(--blue);border:1px solid #1a1a3a;}
.status-chip{font-family:var(--mono);font-size:.57rem;padding:2px 6px;border-radius:2px;}
.sc-active{border:1px solid #003322;color:var(--green);}
.sc-pending{border:1px solid #3a3000;color:var(--yellow);}
.sc-paused{border:1px solid #400000;color:var(--red);}

/* REPORT TABLE */
.rpt-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--b);}
.rpt-row:last-child{border-bottom:none;}

/* UPLOAD */
.upload-zone{border:1px dashed var(--b2);border-radius:3px;padding:22px;text-align:center;cursor:pointer;font-family:var(--mono);font-size:.72rem;color:var(--t3);}
.upload-zone:hover{border-color:var(--white);color:var(--white);}

/* SCROLL UTIL */
.sx{overflow-x:auto;}

/* PRODUCT LEGEND */
.prod-legend{display:flex;gap:16px;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--b);background:var(--s2);}
.pl-group{display:flex;flex-direction:column;gap:4px;}
.pl-label{font-family:var(--mono);font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;margin-bottom:2px;}
.pl-tags{display:flex;gap:4px;flex-wrap:wrap;}

/* INLINE SETTINGS */
.rate-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--b);}
.rate-row:last-child{border-bottom:none;}
.rate-label{font-family:var(--mono);font-size:.68rem;color:var(--t2);flex:1;}
.rate-input{background:var(--s2);border:1px solid var(--b2);border-radius:3px;padding:4px 8px;color:var(--text);font-family:var(--mono);font-size:.72rem;width:80px;text-align:right;outline:none;}
.rate-input:focus{border-color:var(--white);}
</style>
</head>
<body>

<div class="app">

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-name">SIMPLI.FI</div>
    <div class="logo-sub">Command Center</div>
  </div>
  <div class="nav">
    <div class="ng">Overview</div>
    <div class="ni" onclick="nav(&#39;digest&#39;)"><span class="ni-icon">‚òÄ</span>Morning Digest</div>
    <div class="ni" onclick="nav(&#39;todos&#39;)"><span class="ni-icon">‚òê</span>To-Dos<span class="nb" id="nb-td" style="">4</span></div>
    <div class="ng">Pipeline</div>
    <div class="ni" onclick="nav(&#39;pipeline&#39;)"><span class="ni-icon">‚óà</span>Pipeline</div>
    <div class="ni active" onclick="nav(&#39;contacts&#39;)"><span class="ni-icon">‚óé</span>Contacts</div>
    <div class="ni" onclick="nav(&#39;agencies&#39;)"><span class="ni-icon">‚óá</span>Agencies</div>
    <div class="ng">Finance</div>
    <div class="ni" onclick="nav(&#39;accounts&#39;)"><span class="ni-icon">‚óâ</span>Account Hub<span class="nb" id="nb-acct" style="display:none">0</span></div>
    <div class="ni" onclick="nav(&#39;budget&#39;)"><span class="ni-icon">$</span>Budget &amp; Forecast</div>
    <div class="ng">Growth</div>
    <div class="ni" onclick="nav(&#39;prospects&#39;)"><span class="ni-icon">+</span>Prospecting</div>
    <div class="ni" onclick="nav(&#39;reports&#39;)"><span class="ni-icon">‚äû</span>Client Reports</div>
    <div class="ni" onclick="nav(&#39;proposal&#39;)"><span class="ni-icon">üìÑ</span>Proposal Builder</div>
    <div class="ng">Intelligence</div>
    <div class="ni" onclick="nav(&#39;kb&#39;)"><span class="ni-icon">‚ú¶</span>AI Assistant</div>
    <div class="ng">Settings</div>
    <div class="ni" onclick="nav(&#39;integrations&#39;)"><span class="ni-icon">‚úâ</span>Smart Inbox<span class="nb" id="nb-inbox" style="display:none">0</span></div>
    <div class="ni" onclick="nav(&#39;settings&#39;)"><span class="ni-icon">‚öô</span>Settings</div>
  </div>
  <div class="sfoot">
    <div class="clock" id="clock">10:16 PM</div>
    <div class="clock-sub" id="clock-sub">Thu, Feb 19</div>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">

<!-- DIGEST -->
<div class="page" id="page-digest">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">Morning Digest</div><div class="tb-sub" id="d-date">Thursday, February 19, 2026</div></div>
    <div class="tb-r">
      <button class="btn" onclick="previewBriefing()">‚úâ Briefing Email</button>
      <button class="btn btn-w" onclick="refreshAll()">‚Ü∫ Refresh</button>
    </div>
  </div>
  <div class="content">
    <div class="sg s4">
      <div class="stat"><div class="sl">Active Pipeline</div><div class="sv" id="ds-active">4</div><div class="ss">open opportunities</div></div>
      <div class="stat"><div class="sl">Proposals Out</div><div class="sv" id="ds-prop">1</div><div class="ss">awaiting response</div></div>
      <div class="stat"><div class="sl">Gone Cold</div><div class="sv" id="ds-cold" style="color:var(--red)">1</div><div class="ss">7+ days silent</div></div>
      <div class="stat"><div class="sl">Open To-Dos</div><div class="sv" id="ds-todos" style="color:var(--yellow)">4</div><div class="ss">need action</div></div>
    </div>
    <!-- Month budget snapshot in digest -->
    <div class="sg s4" style="margin-bottom:18px;">
      <div class="stat"><div class="sl" id="d-month-label">February</div><div class="sv" id="ds-month-total" style="color:var(--white)">$108,400</div><div class="ss">on the books</div></div>
      <div class="stat"><div class="sl">Monthly Commission</div><div class="sv" id="ds-month-comm" style="color:var(--green)">$6,911</div><div class="ss">projected</div></div>
      <div class="stat"><div class="sl">Annual Contracted</div><div class="sv" id="ds-annual" style="color:var(--white)">$1,911,450</div><div class="ss">total 2026</div></div>
      <div class="stat"><div class="sl">Annual Commission</div><div class="sv" id="ds-annual-comm" style="color:var(--green)">$130,243</div><div class="ss">projected</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;">
      <div class="card"><div class="ch"><span class="ct">Priority Contacts</span><span style="font-family:var(--mono);font-size:.55rem;color:var(--t3)">action today</span></div><div class="cb" id="dg-pri"><div class="pri" onclick="openDetail(&#39;c2&#39;)" style="cursor:pointer"><div class="pri-n">01</div><div class="pri-info"><div class="pri-name">Sandra Lee ‚Äî Knoxville Injury Law</div><div class="pri-reason">At the Table ¬∑ 1d ago</div></div><div class="pri-act pa-call">CALL</div></div><div class="pri" onclick="openDetail(&#39;c1&#39;)" style="cursor:pointer"><div class="pri-n">02</div><div class="pri-info"><div class="pri-name">Mike Harrison ‚Äî Harrison Chevrolet</div><div class="pri-reason">Proposal Sent ¬∑ 3d ago</div></div><div class="pri-act pa-prop">ACTION</div></div><div class="pri" onclick="openDetail(&#39;c4&#39;)" style="cursor:pointer"><div class="pri-n">03</div><div class="pri-info"><div class="pri-name">Amy Chen ‚Äî Chen Realty Group</div><div class="pri-reason">Follow-Up Scheduled ¬∑ 2d ago</div></div><div class="pri-act pa-fu">ACTION</div></div></div></div>
      <div class="card"><div class="ch"><span class="ct">Gone Cold</span><span style="font-family:var(--mono);font-size:.55rem;color:var(--red)">7+ days</span></div><div class="cb" id="dg-cold"><div class="pri" onclick="openDetail(&#39;c3&#39;)" style="cursor:pointer"><div class="pri-n">01</div><div class="pri-info"><div class="pri-name">Tom Park ‚Äî Park HVAC Services</div><div class="pri-reason">Warm ¬∑ 9d silent</div></div><div class="pri-act pa-call">RE-ENGAGE</div></div></div></div>
    </div>
    <div class="card"><div class="ch"><span class="ct">Open To-Dos</span><button class="btn btn-sm" onclick="nav(&#39;todos&#39;)">See All</button></div><div class="cb" id="dg-td"><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t1&#39;)"></div><div><div class="ttxt">Send revised proposal to Harrison Chevrolet</div><div class="tmeta"><span class="ttag tt-auto">PROPOSAL</span></div></div></div><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t2&#39;)"></div><div><div class="ttxt">Re-engage Tom Park (Park HVAC) ‚Äî 9 days cold</div><div class="tmeta"><span class="ttag tt-auto">COLD</span></div></div></div><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t3&#39;)"></div><div><div class="ttxt">Follow up ‚Äî Amy Chen (Chen Realty)</div><div class="tmeta"><span class="ttag tt-auto">FOLLOWUP</span></div></div></div><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t4&#39;)"></div><div><div class="ttxt">Prepare Q1 commission summary</div><div class="tmeta"><span class="ttag tt-man">MANUAL</span></div></div></div></div></div>
  </div>
</div>

<!-- TODOS -->
<div class="page" id="page-todos">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">To-Do List</div><div class="tb-sub">auto-generated + manual tasks</div></div>
    <div class="tb-r"><button class="btn" onclick="runAutoTodos()">‚ü≥ Auto-Check</button><button class="btn btn-w" onclick="openAddTodo()">+ Add</button></div>
  </div>
  <div class="content">
    <div class="filters" id="td-filters">
      <button class="filt active" onclick="filtTd(&#39;all&#39;,this)">All</button>
      <button class="filt" onclick="filtTd(&#39;open&#39;,this)">Open</button>
      <button class="filt" onclick="filtTd(&#39;auto&#39;,this)">Auto-Generated</button>
      <button class="filt" onclick="filtTd(&#39;manual&#39;,this)">Manual</button>
      <button class="filt" onclick="filtTd(&#39;done&#39;,this)">Completed</button>
    </div>
    <div class="card"><div class="cb" id="td-list" style="padding:0 14px;"><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t1&#39;)"></div><div style="flex:1"><div class="ttxt ">Send revised proposal to Harrison Chevrolet</div><div class="tmeta"><span class="ttag tt-auto">PROPOSAL</span> ¬∑ Mike Harrison</div></div><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="toggleTodo(&#39;t1&#39;)">‚úì</button><button class="btn btn-sm btn-danger" onclick="deleteTodo(&#39;t1&#39;)">‚úï</button></div></div><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t2&#39;)"></div><div style="flex:1"><div class="ttxt ">Re-engage Tom Park (Park HVAC) ‚Äî 9 days cold</div><div class="tmeta"><span class="ttag tt-auto">COLD</span> ¬∑ Tom Park</div></div><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="toggleTodo(&#39;t2&#39;)">‚úì</button><button class="btn btn-sm btn-danger" onclick="deleteTodo(&#39;t2&#39;)">‚úï</button></div></div><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t3&#39;)"></div><div style="flex:1"><div class="ttxt ">Follow up ‚Äî Amy Chen (Chen Realty)</div><div class="tmeta"><span class="ttag tt-auto">FOLLOWUP</span> ¬∑ Amy Chen</div></div><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="toggleTodo(&#39;t3&#39;)">‚úì</button><button class="btn btn-sm btn-danger" onclick="deleteTodo(&#39;t3&#39;)">‚úï</button></div></div><div class="todo-item"><div class="tcb " onclick="toggleTodo(&#39;t4&#39;)"></div><div style="flex:1"><div class="ttxt ">Prepare Q1 commission summary</div><div class="tmeta"><span class="ttag tt-man">MANUAL</span></div></div><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="toggleTodo(&#39;t4&#39;)">‚úì</button><button class="btn btn-sm btn-danger" onclick="deleteTodo(&#39;t4&#39;)">‚úï</button></div></div></div></div>
  </div>
</div>

<!-- PIPELINE -->
<div class="page" id="page-pipeline">
  <div class="topbar"><div class="tb-l"><div class="tb-title">Pipeline</div></div><div class="tb-r"><button class="btn btn-w" onclick="openAddContact()">+ Add Contact</button></div></div>
  <div class="content">
    <div class="filters" id="pf">
      <button class="filt active" onclick="filtPipe(&#39;all&#39;,this)">All</button>
      <button class="filt" onclick="filtPipe(&#39;Cold&#39;,this)">Cold</button>
      <button class="filt" onclick="filtPipe(&#39;Attempted Contact&#39;,this)">Attempted</button>
      <button class="filt" onclick="filtPipe(&#39;Warm&#39;,this)">Warm</button>
      <button class="filt" onclick="filtPipe(&#39;Follow-Up Scheduled&#39;,this)">Follow-Up</button>
      <button class="filt" onclick="filtPipe(&#39;Proposal Sent&#39;,this)">Proposal</button>
      <button class="filt" onclick="filtPipe(&#39;At the Table&#39;,this)">At Table</button>
      <button class="filt" onclick="filtPipe(&#39;Closed Won&#39;,this)">Won</button>
    </div>
    <div class="search"><span style="color:var(--t3)">‚åï</span><input type="text" placeholder="Search..." id="pq" oninput="renderPipe()"></div>
    <div class="tbl"><table><thead><tr><th>Contact / Company</th><th>Vertical</th><th>Stage</th><th>Last Contact</th><th>Follow-Up</th><th>Status</th></tr></thead><tbody id="pipe-tb"><tr onclick="openDetail(&#39;c1&#39;)" style="cursor:pointer"><td><div style="color:var(--white)">Mike Harrison</div><div style="font-size:.7rem;color:var(--t2)">Harrison Chevrolet</div></td><td style="color:var(--t2)">Automotive</td><td><span class="badge s-proposal"><span class="bdot" style="background:currentColor;opacity:.6"></span>Proposal Sent</span></td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">Feb 16</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">‚Äî</td><td><span style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">OK</span></td></tr><tr onclick="openDetail(&#39;c2&#39;)" style="cursor:pointer"><td><div style="color:var(--white)">Sandra Lee</div><div style="font-size:.7rem;color:var(--t2)">Knoxville Injury Law</div></td><td style="color:var(--t2)">Legal</td><td><span class="badge s-table"><span class="bdot" style="background:currentColor;opacity:.6"></span>At the Table</span></td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">Feb 18</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">‚Äî</td><td><span style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">OK</span></td></tr><tr onclick="openDetail(&#39;c3&#39;)" style="cursor:pointer"><td><div style="color:var(--white)">Tom Park</div><div style="font-size:.7rem;color:var(--t2)">Park HVAC Services</div></td><td style="color:var(--t2)">Home Services</td><td><span class="badge s-warm"><span class="bdot" style="background:currentColor;opacity:.6"></span>Warm</span></td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">Feb 10</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">‚Äî</td><td><span class="cold-f">COLD</span></td></tr><tr onclick="openDetail(&#39;c4&#39;)" style="cursor:pointer"><td><div style="color:var(--white)">Amy Chen</div><div style="font-size:.7rem;color:var(--t2)">Chen Realty Group</div></td><td style="color:var(--t2)">Real Estate</td><td><span class="badge s-followup"><span class="bdot" style="background:currentColor;opacity:.6"></span>Follow-Up Scheduled</span></td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">Feb 17</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">‚Äî</td><td><span style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">OK</span></td></tr></tbody></table></div>
  </div>
</div>

<!-- CONTACTS -->
<div class="page active" id="page-contacts">
  <div class="topbar"><div class="tb-l"><div class="tb-title">All Contacts</div><div class="tb-sub" id="contacts-count">4 contacts</div></div><div class="tb-r">
    <button class="btn" onclick="openImportCSV()">‚Üë Import CSV</button>
    <button class="btn btn-w" onclick="openAddContact()">+ Add</button>
  </div></div>
  <div class="content">
    <div class="search"><span style="color:var(--t3)">‚åï</span><input type="text" placeholder="Search name, company, stage..." id="cq" oninput="renderContacts()"></div>
    <div class="tbl"><table><thead><tr><th>Name</th><th>Company</th><th>Phone</th><th>Email</th><th>Vertical</th><th>Stage</th><th></th></tr></thead><tbody id="con-tb"><tr><td style="color:var(--white)">Mike Harrison</td><td style="color:var(--t2)">Harrison Chevrolet</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">(865) 555-0101</td><td style="font-size:.73rem;color:var(--t2)">mharrison@harrisonchev.com</td><td style="color:var(--t2)">Automotive</td><td><span class="badge s-proposal"><span class="bdot" style="background:currentColor;opacity:.6"></span>Proposal Sent</span></td><td><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="openDetail(&#39;c1&#39;)">View</button><button class="btn btn-sm" onclick="openLog(&#39;c1&#39;)">Log</button><button class="btn btn-sm btn-danger" onclick="deleteContactInline(&#39;c1&#39;)">‚úï</button></div></td></tr><tr><td style="color:var(--white)">Sandra Lee</td><td style="color:var(--t2)">Knoxville Injury Law</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">(865) 555-0202</td><td style="font-size:.73rem;color:var(--t2)">slee@kxlaw.com</td><td style="color:var(--t2)">Legal</td><td><span class="badge s-table"><span class="bdot" style="background:currentColor;opacity:.6"></span>At the Table</span></td><td><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="openDetail(&#39;c2&#39;)">View</button><button class="btn btn-sm" onclick="openLog(&#39;c2&#39;)">Log</button><button class="btn btn-sm btn-danger" onclick="deleteContactInline(&#39;c2&#39;)">‚úï</button></div></td></tr><tr><td style="color:var(--white)">Tom Park</td><td style="color:var(--t2)">Park HVAC Services</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">(865) 555-0303</td><td style="font-size:.73rem;color:var(--t2)">tpark@parkhvac.com</td><td style="color:var(--t2)">Home Services</td><td><span class="badge s-warm"><span class="bdot" style="background:currentColor;opacity:.6"></span>Warm</span></td><td><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="openDetail(&#39;c3&#39;)">View</button><button class="btn btn-sm" onclick="openLog(&#39;c3&#39;)">Log</button><button class="btn btn-sm btn-danger" onclick="deleteContactInline(&#39;c3&#39;)">‚úï</button></div></td></tr><tr><td style="color:var(--white)">Amy Chen</td><td style="color:var(--t2)">Chen Realty Group</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">(865) 555-0606</td><td style="font-size:.73rem;color:var(--t2)">achen@chenrealty.com</td><td style="color:var(--t2)">Real Estate</td><td><span class="badge s-followup"><span class="bdot" style="background:currentColor;opacity:.6"></span>Follow-Up Scheduled</span></td><td><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="openDetail(&#39;c4&#39;)">View</button><button class="btn btn-sm" onclick="openLog(&#39;c4&#39;)">Log</button><button class="btn btn-sm btn-danger" onclick="deleteContactInline(&#39;c4&#39;)">‚úï</button></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- AGENCIES -->
<div class="page" id="page-agencies">
  <div class="topbar"><div class="tb-l"><div class="tb-title">Agencies &amp; Child Orgs</div></div><div class="tb-r"><button class="btn btn-w" onclick="openAddAgency()">+ Add Agency</button></div></div>
  <div class="content">
    <div class="sg s3"><div class="stat"><div class="sl">Active Partners</div><div class="sv" id="ags1">3</div></div><div class="stat"><div class="sl">Child Clients</div><div class="sv" id="ags2">4</div></div><div class="stat"><div class="sl">In Pitch</div><div class="sv" id="ags3">1</div></div></div>
    <div id="ag-tree"><div class="ab"><div class="ar" onclick="toggleAg(&#39;mltqxuqeyh09y20qgx&#39;)"><div style="flex:1"><div style="color:var(--white);font-weight:500">Lions Creative</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2);margin-top:1px">Dillon Murphy ¬∑ Last: Feb 19</div></div><div style="display:flex;align-items:center;gap:6px"><span class="badge s-agency"><span class="bdot" style="background:currentColor;opacity:.6"></span>Agency Partner</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">1 clients</span><button class="btn btn-sm" onclick="event.stopPropagation();openAddChild(&#39;mltqxuqeyh09y20qgx&#39;)">+ Client</button><button class="btn btn-sm" onclick="event.stopPropagation();openEditAg(&#39;mltqxuqeyh09y20qgx&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteAgency(&#39;mltqxuqeyh09y20qgx&#39;)">‚úï</button><span class="chev" id="chev-mltqxuqeyh09y20qgx">‚ñ∂</span></div></div><div class="ach" id="ach-mltqxuqeyh09y20qgx" style="display:none"><div class="acr"><div class="acc"></div><div style="flex:1"><div style="color:var(--white)">GM Management</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Maurice ¬∑ Restaurant ¬∑ ‚Äî</div></div><div style="display:flex;gap:4px;align-items:center"><span class="badge s-active"><span class="bdot" style="background:currentColor;opacity:.6"></span>Active</span><button class="btn btn-sm" onclick="openEditCh(&#39;mltqxuqeyh09y20qgx&#39;,&#39;mltr0u9ncet71tvhfk&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="delCh(&#39;mltqxuqeyh09y20qgx&#39;,&#39;mltr0u9ncet71tvhfk&#39;)">‚úï</button></div></div></div></div><div class="ab"><div class="ar" onclick="toggleAg(&#39;a1&#39;)"><div style="flex:1"><div style="color:var(--white);font-weight:500">Dickson Media Events</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2);margin-top:1px">Lisa Monroe ¬∑ (865) 555-0404 ¬∑ Last: Feb 14 ¬∑ $15,000/mo</div></div><div style="display:flex;align-items:center;gap:6px"><span class="badge s-agency"><span class="bdot" style="background:currentColor;opacity:.6"></span>Agency Partner</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">2 clients</span><button class="btn btn-sm" onclick="event.stopPropagation();openAddChild(&#39;a1&#39;)">+ Client</button><button class="btn btn-sm" onclick="event.stopPropagation();openEditAg(&#39;a1&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteAgency(&#39;a1&#39;)">‚úï</button><span class="chev" id="chev-a1">‚ñ∂</span></div></div><div class="ach" id="ach-a1" style="display:none"><div class="acr"><div class="acc"></div><div style="flex:1"><div style="color:var(--white)">Guardian Foundation Repair</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Bob Harris ¬∑ Home Services ¬∑ $9,000/mo</div></div><div style="display:flex;gap:4px;align-items:center"><span class="badge s-active"><span class="bdot" style="background:currentColor;opacity:.6"></span>Active</span><button class="btn btn-sm" onclick="openEditCh(&#39;a1&#39;,&#39;ch1&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="delCh(&#39;a1&#39;,&#39;ch1&#39;)">‚úï</button></div></div><div class="acr"><div class="acc"></div><div style="flex:1"><div style="color:var(--white)">Knox Smile Dental</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Dr. Amy Foster ¬∑ Healthcare ¬∑ $1,800/mo</div></div><div style="display:flex;gap:4px;align-items:center"><span class="badge s-active"><span class="bdot" style="background:currentColor;opacity:.6"></span>Active</span><button class="btn btn-sm" onclick="openEditCh(&#39;a1&#39;,&#39;ch2&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="delCh(&#39;a1&#39;,&#39;ch2&#39;)">‚úï</button></div></div></div></div><div class="ab"><div class="ar" onclick="toggleAg(&#39;a2&#39;)"><div style="flex:1"><div style="color:var(--white);font-weight:500">Stone &amp; Co Marketing</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2);margin-top:1px">Brad Stone ¬∑ (865) 555-0707 ¬∑ Last: Feb 9 ¬∑ $8,000/mo</div></div><div style="display:flex;align-items:center;gap:6px"><span class="badge s-agency"><span class="bdot" style="background:currentColor;opacity:.6"></span>Agency Partner</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">1 clients</span><button class="btn btn-sm" onclick="event.stopPropagation();openAddChild(&#39;a2&#39;)">+ Client</button><button class="btn btn-sm" onclick="event.stopPropagation();openEditAg(&#39;a2&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteAgency(&#39;a2&#39;)">‚úï</button><span class="chev" id="chev-a2">‚ñ∂</span></div></div><div class="ach" id="ach-a2" style="display:none"><div class="acr"><div class="acc"></div><div style="flex:1"><div style="color:var(--white)">East TN Auto Spa</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Dave Mullins ¬∑ Automotive ¬∑ $1,200/mo</div></div><div style="display:flex;gap:4px;align-items:center"><span class="badge s-active"><span class="bdot" style="background:currentColor;opacity:.6"></span>Active</span><button class="btn btn-sm" onclick="openEditCh(&#39;a2&#39;,&#39;ch3&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="delCh(&#39;a2&#39;,&#39;ch3&#39;)">‚úï</button></div></div></div></div><div class="ab"><div class="ar" onclick="toggleAg(&#39;a3&#39;)"><div style="flex:1"><div style="color:var(--white);font-weight:500">Ridge Digital Media</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2);margin-top:1px">Karen Webb ¬∑ (865) 555-0808 ¬∑ Last: Feb 10</div></div><div style="display:flex;align-items:center;gap:6px"><span class="badge s-warm"><span class="bdot" style="background:currentColor;opacity:.6"></span>Warm</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">0 clients</span><button class="btn btn-sm" onclick="event.stopPropagation();openAddChild(&#39;a3&#39;)">+ Client</button><button class="btn btn-sm" onclick="event.stopPropagation();openEditAg(&#39;a3&#39;)">Edit</button><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteAgency(&#39;a3&#39;)">‚úï</button><span class="chev" id="chev-a3">‚ñ∂</span></div></div><div class="ach" id="ach-a3" style="display:none"><div style="padding:10px 14px 10px 24px;font-family:var(--mono);font-size:.63rem;color:var(--t3)">No clients yet.</div></div></div></div>
  </div>
</div>

<!-- ACCOUNT HUB -->
<div class="page" id="page-accounts">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">Account Hub</div><div class="tb-sub">IOs, pacing, billing, commission ‚Äî one place per client</div></div>
    <div class="tb-r">
      <button class="btn" onclick="openNewAccount()">+ New Account</button>
      <button class="btn btn-w" onclick="pasteInboxEmails()">‚ú¶ Paste Emails ‚Üí Analyze</button>
    </div>
  </div>
  <div class="content">

    <!-- ACCOUNT LIST (left) + DETAIL (right) -->
    <div style="display:grid;grid-template-columns:280px 1fr;gap:14px;align-items:start;">

      <!-- ACCOUNT LIST -->
      <div>
        <div class="card" style="padding:0;">
          <div style="padding:10px 12px;border-bottom:1px solid var(--border);display:flex;gap:6px;">
            <input class="fi" id="acct-search" placeholder="Search accounts..." style="flex:1;font-size:.75rem;" oninput="renderAccountList()">
          </div>
          <div id="acct-list" style="max-height:calc(100vh - 180px);overflow-y:auto;"></div>
        </div>
      </div>

      <!-- ACCOUNT DETAIL -->
      <div id="acct-detail">
        <div class="card" style="text-align:center;padding:40px;color:var(--t3);">
          <div style="font-size:2rem;margin-bottom:12px;">‚óâ</div>
          <div style="font-family:var(--mono);font-size:.75rem;">Select an account to view details</div>
          <div style="font-size:.72rem;margin-top:8px;">or click <strong style="color:var(--white)">+ New Account</strong> to get started</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ACCOUNT HUB MODALS -->
<!-- New/Edit Account Modal -->
<!-- CSV IMPORT MODAL -->
<div class="overlay" id="m-import-csv">
  <div class="modal" style="max-width:680px;">
    <div class="mh"><div class="mt">‚Üë Import Contacts from CSV</div><button class="mc" onclick="closeM(&#39;m-import-csv&#39;)">‚úï</button></div>
    <div class="mb">

      <!-- STEP 1: Upload -->
      <div id="csv-step-1">
        <p style="font-size:.8rem;color:var(--t2);line-height:1.7;margin-bottom:12px;">Works with exports from <strong style="color:var(--white)">Seamless AI, LinkedIn, ZoomInfo, Apollo, HubSpot, Salesforce</strong>, or any spreadsheet. Column names don't need to match exactly ‚Äî the importer figures it out.</p>
        <div id="csv-drop-zone" onclick="document.getElementById(&#39;csv-file-input&#39;).click()" style="border:2px dashed var(--border);border-radius:8px;padding:32px;text-align:center;cursor:pointer;transition:border-color .2s;" onmouseover="this.style.borderColor=&#39;var(--white)&#39;" onmouseout="this.style.borderColor=&#39;var(--border)&#39;">
          <div style="font-size:1.5rem;margin-bottom:8px;">üìÇ</div>
          <div style="font-size:.82rem;color:var(--white);margin-bottom:4px;">Click to select a CSV file</div>
          <div style="font-size:.72rem;color:var(--t3);">or drag and drop here</div>
        </div>
        <input type="file" id="csv-file-input" accept=".csv,.tsv,.txt" style="display:none;" onchange="handleCSVFile(this)">
        <div style="margin-top:10px;">
          <div style="font-family:var(--mono);font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">Or paste CSV text directly</div>
          <textarea class="fta" id="csv-paste-text" style="min-height:80px;font-family:var(--mono);font-size:.7rem;" placeholder="Paste CSV content here... (include header row)"></textarea>
          <button class="btn btn-sm" style="margin-top:6px;" onclick="parseCSVFromPaste()">Parse Pasted CSV</button>
        </div>
      </div>

      <!-- STEP 2: Column Mapping -->
      <div id="csv-step-2" style="display:none;">
        <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;">Step 2 ‚Äî Confirm Column Mapping</div>
        <p style="font-size:.75rem;color:var(--t2);margin-bottom:10px;">The importer auto-detected these mappings. Adjust any that look wrong, then click Import.</p>
        <div id="csv-mapping-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;"></div>
        <div style="padding:10px;background:var(--s2);border-radius:4px;margin-bottom:12px;">
          <div style="font-family:var(--mono);font-size:.6rem;color:var(--yellow);margin-bottom:6px;">PREVIEW ‚Äî First 3 rows</div>
          <div id="csv-preview" style="font-size:.7rem;color:var(--t2);overflow-x:auto;"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div id="csv-import-status" style="font-family:var(--mono);font-size:.7rem;color:var(--t3);flex:1;"></div>
          <label style="display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--t2);cursor:pointer;">
            <input type="checkbox" id="csv-skip-dupes" checked="" style="accent-color:var(--white);"> Skip duplicates (same name + company)
          </label>
        </div>
      </div>

      <!-- STEP 3: Results -->
      <div id="csv-step-3" style="display:none;">
        <div id="csv-import-results"></div>
      </div>

    </div>
    <div class="mf" id="csv-modal-footer">
      <button class="btn" onclick="closeM(&#39;m-import-csv&#39;);resetCSVImport()">Cancel</button>
      <button class="btn btn-w" id="csv-import-btn" onclick="runCSVImport()" style="display:none;">‚Üë Import Contacts</button>
    </div>
  </div>
</div>

<!-- ENRICH CONTACT MODAL -->
<div class="overlay" id="m-enrich">
  <div class="modal" style="max-width:520px;">
    <div class="mh"><div class="mt">‚ú¶ AI Enrich Contact</div><button class="mc" onclick="closeM(&#39;m-enrich&#39;)">‚úï</button></div>
    <div class="mb">
      <div id="enrich-contact-info" style="margin-bottom:14px;padding:10px;background:var(--s2);border-radius:4px;font-size:.8rem;color:var(--white);"></div>
      <div id="enrich-status" style="font-size:.78rem;color:var(--t2);margin-bottom:10px;">Click Enrich to search for missing contact information.</div>
      <div id="enrich-results" style="display:none;">
        <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">‚ú¶ AI Found ‚Äî Review Before Saving</div>
        <div class="fgrid" id="enrich-fields"></div>
        <div style="margin-top:10px;padding:8px;background:rgba(255,180,0,.08);border:1px solid rgba(255,180,0,.2);border-radius:4px;font-size:.7rem;color:var(--t3);">‚ö† AI-enriched data is a best guess based on public info. Always verify before using for outreach.</div>
      </div>
      <input type="hidden" id="enrich-contact-id">
    </div>
    <div class="mf">
      <button class="btn" onclick="closeM(&#39;m-enrich&#39;)">Cancel</button>
      <button class="btn btn-w" onclick="runEnrich()">‚ú¶ Enrich with AI</button>
      <button class="btn btn-w" id="enrich-save-btn" onclick="saveEnrichedContact()" style="display:none;">‚úì Save Changes</button>
    </div>
  </div>
</div><div class="mh"><div class="mt" id="m-account-title">New Account</div><button class="mc" onclick="closeM(&#39;m-account&#39;)">‚úï</button></div><div class="mb"><div class="fgrid">
  <div class="fg"><label class="fl">Client / Advertiser Name *</label><input class="fi" id="ac-name"></div>
  <div class="fg"><label class="fl">Billing Org ID</label><input class="fi" id="ac-orgid" placeholder="e.g. 558440"></div>
  <div class="fg"><label class="fl">Primary Contact</label><input class="fi" id="ac-contact" placeholder="Name"></div>
  <div class="fg"><label class="fl">Contact Email</label><input class="fi" id="ac-email" type="email"></div>
  <div class="fg"><label class="fl">Contact Phone</label><input class="fi" id="ac-phone"></div>
  <div class="fg"><label class="fl">Vertical</label><select class="fs" id="ac-vertical"><option>Automotive</option><option>Legal</option><option>QSR / Restaurant</option><option>Multi-Location Franchise</option><option>Medical / Healthcare</option><option>Insurance</option><option>Tourism / Events</option><option>Home Services</option><option>Retail</option><option>Real Estate</option><option>Finance / Banking</option><option>Other</option></select></div>
  <div class="fg"><label class="fl">Relationship Start Date</label><input class="fi" id="ac-start" type="date"></div>
  <div class="fg"><label class="fl">Status</label><select class="fs" id="ac-status"><option value="active">Active</option><option value="pending">Pending</option><option value="paused">Paused</option><option value="churned">Churned</option></select></div>
  <div class="fg full"><label class="fl">Notes</label><textarea class="fta" id="ac-notes" style="min-height:60px;"></textarea></div>
</div><input type="hidden" id="ac-id"></div><div class="mf"><button class="btn" onclick="closeM(&#39;m-account&#39;)">Cancel</button><button class="btn btn-w" onclick="saveAccount()">Save Account</button></div></main></div>

<!-- New IO Modal -->
<div class="overlay" id="m-io"><div class="modal" style="max-width:620px;"><div class="mh"><div class="mt" id="m-io-title">Add Insertion Order</div><button class="mc" onclick="closeM(&#39;m-io&#39;)">‚úï</button></div><div class="mb">
  <div class="fgrid">
    <div class="fg"><label class="fl">IO Type</label><select class="fs" id="io-type" onchange="renderIOTypeHint()"><option value="open">Open IO (Credit Limit)</option><option value="campaign">Campaign IO (Exact Budget)</option></select></div>
    <div class="fg"><label class="fl">Order Name</label><input class="fi" id="io-name" placeholder="e.g. F Street Annual Open IO"></div>
    <div class="fg"><label class="fl">Total IO Value / Credit Limit</label><input class="fi" id="io-total" placeholder="75000" type="number"></div>
    <div class="fg"><label class="fl">IO Date (signed)</label><input class="fi" id="io-date" type="date"></div>
    <div class="fg"><label class="fl">Campaign Start</label><input class="fi" id="io-start" type="date"></div>
    <div class="fg"><label class="fl">Campaign End</label><input class="fi" id="io-end" type="date"></div>
    <div class="fg"><label class="fl">DocuSign / Reference ID</label><input class="fi" id="io-docid" placeholder="Optional"></div>
    <div class="fg"><label class="fl">Status</label><select class="fs" id="io-status"><option value="active">Active</option><option value="pending">Pending Signature</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select></div>
  </div>
  <div id="io-type-hint" style="margin:8px 0;padding:8px 10px;background:var(--s2);border-radius:4px;font-size:.72rem;color:var(--t2);"></div>
  <!-- Tactic Lines -->
  <div style="margin-top:12px;">
    <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Tactic Line Items</div>
    <div id="io-lines"></div>
    <button class="btn btn-sm" onclick="addIOLine()" style="margin-top:6px;">+ Add Tactic Line</button>
  </div>
  <input type="hidden" id="io-acct-id">
  <input type="hidden" id="io-id">
</div><div class="mf"><button class="btn" onclick="closeM(&#39;m-io&#39;)">Cancel</button><button class="btn btn-w" onclick="saveIO()">Save IO</button></div></div></div>

<!-- Paste Emails Modal -->
<div class="overlay" id="m-paste-inbox"><div class="modal" style="max-width:640px;"><div class="mh"><div class="mt">‚ú¶ Paste Emails ‚Üí AI Analysis</div><button class="mc" onclick="closeM(&#39;m-paste-inbox&#39;)">‚úï</button></div><div class="mb">
  <p style="font-size:.78rem;color:var(--t2);margin-bottom:10px;line-height:1.6;">Copy emails from Gmail (select all text, Ctrl+C) and paste them below. You can paste multiple emails at once ‚Äî separate them with a blank line or "---". The AI will read through everything, identify clients, flag urgent items, create to-dos, and update account history.</p>
  <textarea class="fta" id="paste-inbox-text" style="min-height:200px;" placeholder="Paste email text here... You can paste multiple emails at once."></textarea>
  <div id="paste-inbox-result" style="display:none;margin-top:10px;"></div>
</div><div class="mf"><button class="btn" onclick="closeM(&#39;m-paste-inbox&#39;)">Cancel</button><button class="btn btn-w" onclick="runPasteInboxAI()">‚ú¶ Analyze Emails</button></div></div></div>

<!-- Monthly Actuals Modal -->
<div class="overlay" id="m-actuals"><div class="modal" style="max-width:580px;"><div class="mh"><div class="mt" id="m-actuals-title">Log Monthly Actuals</div><button class="mc" onclick="closeM(&#39;m-actuals&#39;)">‚úï</button></div><div class="mb">
  <div class="fgrid" style="margin-bottom:10px;">
    <div class="fg"><label class="fl">Month</label><select class="fs" id="act-month"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select></div>
    <div class="fg"><label class="fl">Year</label><input class="fi" id="act-year" value="2026" type="number"></div>
  </div>
  <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Programmatic (from Looker)</div>
  <div class="fgrid" style="margin-bottom:12px;">
    <div class="fg"><label class="fl">Total Gross Spend</label><input class="fi" id="act-prog-gross" placeholder="0" type="number"></div>
    <div class="fg"><label class="fl">Revenue Raw (Net)</label><input class="fi" id="act-prog-net" placeholder="0" type="number"></div>
    <div class="fg full"><label class="fl">Paste Looker row (optional ‚Äî auto-fills above)</label><input class="fi" id="act-looker-paste" placeholder="e.g. Friendship Automotive Group  $26,431.85  $14,077.88  53%" oninput="parseLookerPaste()"></div>
  </div>
  <div style="font-family:var(--mono);font-size:.6rem;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Omni / Social (manual ‚Äî not in Looker)</div>
  <div id="act-omni-lines"></div>
  <button class="btn btn-sm" onclick="addActualOmniLine()" style="margin-top:6px;border-color:var(--blue);color:var(--blue);">+ Add Omni Tactic</button>
  <div style="margin-top:14px;padding:10px;background:var(--s2);border-radius:4px;">
    <div style="font-family:var(--mono);font-size:.6rem;color:var(--yellow);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">Commission Preview</div>
    <div id="act-comm-preview" style="font-size:.8rem;color:var(--white);"></div>
  </div>
  <input type="hidden" id="act-acct-id">
</div><div class="mf"><button class="btn" onclick="closeM(&#39;m-actuals&#39;)">Cancel</button><button class="btn btn-w" onclick="saveActuals()">Save Actuals</button></div></div></div>

<!-- BUDGET & FORECAST -->
<div class="page" id="page-budget">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">Budget &amp; Forecast 2026</div><div class="tb-sub">fully customizable ‚Äî edit any cell, add/remove clients and products</div></div>
    <div class="tb-r">
      <button class="btn" onclick="addBudgetClient()">+ Add Client</button>
      <button class="btn btn-green" onclick="saveBudgetData()">‚Üì Save</button>
    </div>
  </div>
  <div class="content">
    <!-- Annual Summary -->
    <div class="sg s5" style="margin-bottom:16px;">
      <div class="stat"><div class="sl">Annual Contracted</div><div class="sv" id="b-annual" style="color:var(--white)">$1,911,450</div><div class="ss">all products</div></div>
      <div class="stat"><div class="sl">YTD Billed</div><div class="sv" id="b-ytd" style="color:var(--white)">$214,050</div><div class="ss">thru this month</div></div>
      <div class="stat"><div class="sl">Annual Commission</div><div class="sv" id="b-comm" style="color:var(--green)">$130,243</div></div>
      <div class="stat"><div class="sl">Pending Revenue</div><div class="sv" id="b-pending" style="color:var(--yellow)">$62,500</div><div class="ss">not yet confirmed</div></div>
      <div class="stat"><div class="sl">Annual Bonus</div><div class="sv" id="b-bonus" style="color:var(--yellow)">$2,000</div><div class="ss"><input class="rate-input" id="bonus-input" value="2000" onchange="renderBudget()" style="width:70px;font-size:.7rem;"></div></div>
    </div>

    <!-- Product Legend -->
    <div class="card" style="margin-bottom:16px;">
      <div class="prod-legend">
        <div class="pl-group">
          <div class="pl-label" style="color:var(--green)">Programmatic</div>
          <div class="pl-tags" id="prog-tags"><span class="prod-tag pt-prog">CTV</span><span class="prod-tag pt-prog">Display</span><span class="prod-tag pt-prog">OLV</span><span class="prod-tag pt-prog">Native</span><span class="prod-tag pt-prog">Audio</span></div>
        </div>
        <div class="pl-group">
          <div class="pl-label" style="color:var(--blue)">Omni / Social</div>
          <div class="pl-tags" id="omni-tags"><span class="prod-tag pt-omni">SEM</span><span class="prod-tag pt-omni">LSA</span><span class="prod-tag pt-omni">YouTube</span><span class="prod-tag pt-omni">YouTube TV</span><span class="prod-tag pt-omni">Netflix</span><span class="prod-tag pt-omni">DOOH</span></div>
        </div>
      </div>
    </div>

    <!-- Month Tabs + Table -->
    <div class="card" style="padding:0;overflow:hidden;">
      <div class="month-tab-row" id="budget-tabs"><div class="mtab " onclick="switchBudgetMonth(0)">Jan</div><div class="mtab active" onclick="switchBudgetMonth(1)">Feb</div><div class="mtab " onclick="switchBudgetMonth(2)">Mar</div><div class="mtab " onclick="switchBudgetMonth(3)">Apr</div><div class="mtab " onclick="switchBudgetMonth(4)">May</div><div class="mtab " onclick="switchBudgetMonth(5)">Jun</div><div class="mtab " onclick="switchBudgetMonth(6)">Jul</div><div class="mtab " onclick="switchBudgetMonth(7)">Aug</div><div class="mtab " onclick="switchBudgetMonth(8)">Sep</div><div class="mtab " onclick="switchBudgetMonth(9)">Oct</div><div class="mtab " onclick="switchBudgetMonth(10)">Nov</div><div class="mtab " onclick="switchBudgetMonth(11)">Dec</div></div>
      <div class="budget-wrap">
        <table class="budget-table" id="budget-tbl"><div style="font-family:var(--mono);font-size:.65rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin:0 0 6px;">‚ñ∏ Active / Signed ‚Äî February</div><div class="tbl-wrap" style="margin-bottom:20px;"></div><thead><tr><th class="left" style="min-width:200px;position:sticky;left:0;background:var(--s2);">Client</th><th class="left">Status</th><th class="group-prog">CTV</th><th class="group-prog">Display</th><th class="group-prog">OLV</th><th class="group-prog">Native</th><th class="group-prog">Audio</th><th class="group-prog">Prog Total</th><th class="group-omni">SEM</th><th class="group-omni">LSA</th><th class="group-omni">YouTube</th><th class="group-omni">YouTube TV</th><th class="group-omni">Netflix</th><th class="group-omni">DOOH</th><th class="group-omni">Omni Total</th><th class="group-total">Grand Total</th><th class="group-total">Margin</th><th class="group-total">Commission</th></tr></thead><tbody><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">All American Mattress</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b1&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b1&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-paused">paused</span></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b1&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Apex Bank</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b2&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b2&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="4350" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$4,350</td><td><input class="bi" value="12000" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b2&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">$12,000</td><td style="color:var(--yellow);font-weight:500">$16,350</td><td style="color:var(--t2);">$6,810</td><td style="color:var(--green);">$817</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Clearwater Plumbing</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b3&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b3&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-paused">paused</span></td><td><input class="bi" value="950" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$950</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b3&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">$950</td><td style="color:var(--t2);">$570</td><td style="color:var(--green);">$68</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Delnero Group</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b4&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b4&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="4100" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$4,100</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="2000" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b4&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">$2,000</td><td style="color:var(--yellow);font-weight:500">$6,100</td><td style="color:var(--t2);">$3,160</td><td style="color:var(--green);">$379</td></tr><tr><td class="left" style="position:sticky;left:0;background:var(--s2);font-weight:600;"><span id="bgchev-b5" onclick="toggleBudgetGroup(&#39;b5&#39;)" style="cursor:pointer;margin-right:6px;font-size:.8rem;display:inline-block;width:14px;">‚ñ∂</span><span style="color:var(--blue);">Dickson Media Group</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b5&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b5&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:700;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:700;">‚Äî</td><td style="color:var(--yellow);font-weight:700">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Echo Trace AI</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b6&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b6&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b6&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Friendship Auto</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b7&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b7&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="26500" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$26,500</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b7&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">$26,500</td><td style="color:var(--t2);">$15,900</td><td style="color:var(--green);">$1908</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">F Street Investments</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b8&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b8&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="2500" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$2,500</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b8&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">$2,500</td><td style="color:var(--t2);">$1,500</td><td style="color:var(--green);">$180</td></tr><tr><td class="left" style="position:sticky;left:0;background:var(--s2);font-weight:600;"><span id="bgchev-b9" onclick="toggleBudgetGroup(&#39;b9&#39;)" style="cursor:pointer;margin-right:6px;font-size:.8rem;display:inline-block;width:14px;">‚ñ∂</span><span style="color:var(--blue);">Guardian Foundation Repair</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b9&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b9&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:700;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:700;">‚Äî</td><td style="color:var(--yellow);font-weight:700">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;background:var(--s2);font-weight:600;"><span id="bgchev-b10" onclick="toggleBudgetGroup(&#39;b10&#39;)" style="cursor:pointer;margin-right:6px;font-size:.8rem;display:inline-block;width:14px;">‚ñ∂</span><span style="color:var(--blue);">The Jenkins Agency</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b10&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b10&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:700;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:700;">‚Äî</td><td style="color:var(--yellow);font-weight:700">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Knoxville Wholesale Furniture</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b12&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b12&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="23000" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$23,000</td><td><input class="bi" value="12000" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b12&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">$12,000</td><td style="color:var(--yellow);font-weight:500">$35,000</td><td style="color:var(--t2);">$18,000</td><td style="color:var(--green);">$2160</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">OEB Law</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b13&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b13&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b13&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;background:var(--s2);font-weight:600;"><span id="bgchev-b14" onclick="toggleBudgetGroup(&#39;b14&#39;)" style="cursor:pointer;margin-right:6px;font-size:.8rem;display:inline-block;width:14px;">‚ñ∂</span><span style="color:var(--blue);">Lions Creative</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b14&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b14&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:500;">‚Äî</td><td style="color:var(--green);font-weight:700;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--blue);font-weight:700;">‚Äî</td><td style="color:var(--yellow);font-weight:700">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">McGuire Roofing</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b15&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b15&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="2500" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$2,500</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b15&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">$2,500</td><td style="color:var(--t2);">$1,500</td><td style="color:var(--green);">$180</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">ZC Productions</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b18&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b18&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-active">active</span></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="1600" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">$1,600</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b18&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">$1,600</td><td style="color:var(--t2);">$960</td><td style="color:var(--green);">$115</td></tr></tbody><tfoot><tr class="total-row"><td class="left" colspan="2" style="position:sticky;left:0;background:var(--s2);">TOTAL ‚Äî February</td><td style="color:var(--green);">$57,050</td><td style="color:var(--green);">$4,350</td><td style="color:var(--green);">$2,500</td><td style="color:var(--green);">$1,600</td><td style="color:var(--green);">‚Äî</td><td style="color:var(--green);font-weight:700;">$65,500</td><td style="color:var(--blue);">$24,000</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">$2,000</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);font-weight:700;">$26,000</td><td style="color:var(--yellow);font-weight:700;">$91,500</td><td style="color:var(--t2);">$48,400</td><td style="color:var(--green);font-weight:700;">$5808</td></tr></tfoot><div style="font-family:var(--mono);font-size:.65rem;color:var(--yellow);text-transform:uppercase;letter-spacing:.1em;margin:8px 0 6px;">‚óå Pending ‚Äî Proposals Out</div><div class="tbl-wrap"></div><thead><tr><th class="left" style="min-width:200px;position:sticky;left:0;background:var(--s2);">Client</th><th class="left">Status</th><th class="left" style="color:var(--yellow);">Close %</th><th style="color:var(--yellow);">Weighted</th><th class="group-prog">CTV</th><th class="group-prog">Display</th><th class="group-prog">OLV</th><th class="group-prog">Native</th><th class="group-prog">Audio</th><th class="group-prog">Prog Total</th><th class="group-omni">SEM</th><th class="group-omni">LSA</th><th class="group-omni">YouTube</th><th class="group-omni">YouTube TV</th><th class="group-omni">Netflix</th><th class="group-omni">DOOH</th><th class="group-omni">Omni Total</th><th class="group-total">Grand Total</th><th class="group-total">Margin</th><th class="group-total">Commission</th></tr></thead><tbody><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Josh Hemphill State Farm</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b11&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b11&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-pending">pending</span></td><td><input class="bi" style="width:50px;color:var(--yellow);" value="50" onchange="updateClosePct(&#39;b11&#39;,this.value)">%</td><td style="color:var(--yellow);">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b11&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Scott Adams</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b16&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b16&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-pending">pending</span></td><td><input class="bi" style="width:50px;color:var(--yellow);" value="50" onchange="updateClosePct(&#39;b16&#39;,this.value)">%</td><td style="color:var(--yellow);">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b16&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr><tr><td class="left" style="position:sticky;left:0;"><span style="display:inline-block;width:20px;"></span><span style="color:var(--white);">Oak Ridge Nissan</span> <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(&#39;b17&#39;)">‚úé</button> <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(&#39;b17&#39;)">‚úï</button></td><td class="left"><span class="status-chip sc-pending">pending</span></td><td><input class="bi" style="width:50px;color:var(--yellow);" value="50" onchange="updateClosePct(&#39;b17&#39;,this.value)">%</td><td style="color:var(--yellow);">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;prog&#39;,&#39;CTV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;prog&#39;,&#39;Display&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;prog&#39;,&#39;OLV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;prog&#39;,&#39;Native&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;prog&#39;,&#39;Audio&#39;,1,this.value)"></td><td style="color:var(--green);font-weight:500;">‚Äî</td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;omni&#39;,&#39;SEM&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;omni&#39;,&#39;LSA&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;omni&#39;,&#39;YouTube&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;omni&#39;,&#39;YouTube TV&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;omni&#39;,&#39;Netflix&#39;,1,this.value)"></td><td><input class="bi" value="" placeholder="‚Äî" onchange="updateBudgetCell(&#39;b17&#39;,&#39;omni&#39;,&#39;DOOH&#39;,1,this.value)"></td><td style="color:var(--blue);font-weight:500;">‚Äî</td><td style="color:var(--yellow);font-weight:500">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);">‚Äî</td></tr></tbody><tfoot><tr class="total-row"><td class="left" colspan="2" style="position:sticky;left:0;background:var(--s2);">TOTAL ‚Äî February</td><td colspan="2" style="color:var(--yellow);font-weight:600;">Wtd: ‚Äî</td><td style="color:var(--green);">‚Äî</td><td style="color:var(--green);">‚Äî</td><td style="color:var(--green);">‚Äî</td><td style="color:var(--green);">‚Äî</td><td style="color:var(--green);">‚Äî</td><td style="color:var(--green);font-weight:700;">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);">‚Äî</td><td style="color:var(--blue);font-weight:700;">‚Äî</td><td style="color:var(--yellow);font-weight:700;">‚Äî</td><td style="color:var(--t2);">‚Äî</td><td style="color:var(--green);font-weight:700;">$0</td></tr></tfoot></table>
      </div>
    </div>

    <!-- Commission + Annual breakdown -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px;">
      <div class="card"><div class="ch"><span class="ct">Commission ‚Äî <span id="comm-month-label">February</span></span></div><div class="cb" id="comm-breakdown" style="padding:0 14px;"><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Knoxville Wholesale Furniture</span><span style="color:var(--green)">$2160</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Friendship Auto</span><span style="color:var(--green)">$1908</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Apex Bank</span><span style="color:var(--green)">$817</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">The Jenkins Agency</span><span style="color:var(--green)">$756</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Delnero Group</span><span style="color:var(--green)">$379</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Guardian Foundation Repair</span><span style="color:var(--green)">$255</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">F Street Investments</span><span style="color:var(--green)">$180</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">McGuire Roofing</span><span style="color:var(--green)">$180</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">ZC Productions</span><span style="color:var(--green)">$115</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Dickson Media Group</span><span style="color:var(--green)">$92</span></div><div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">Clearwater Plumbing</span><span style="color:var(--green)">$68</span></div><div style="display:flex;justify-content:space-between;padding:8px 0;font-family:var(--mono);font-size:.78rem;font-weight:500"><span style="color:var(--white)">TOTAL</span><span style="color:var(--green)">$6911</span></div></div></div>
      <div class="card"><div class="ch"><span class="ct">Annual Commission Projection</span></div><div class="cb" id="annual-proj" style="padding:0 14px;"><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Jan</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:51.444384449244055%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$6860</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Feb</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:51.826853851691865%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$6911</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Mar</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:100%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$13334</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Apr</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:93.79049676025917%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$12506</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">May</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:89.37634989200866%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$11918</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Jun</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:89.37634989200866%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$11918</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Jul</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:89.37634989200866%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$11918</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Aug</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:79.22516198704105%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$10564</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Sep</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:79.22516198704105%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$10564</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Oct</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:79.22516198704105%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$10564</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Nov</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:79.22516198704105%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$10564</span></div></div><div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">Dec</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:79.65712742980563%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$10622</span></div></div><div style="display:flex;justify-content:space-between;padding:8px 0;font-family:var(--mono);font-size:.78rem;font-weight:500"><span style="color:var(--white)">ANNUAL + BONUS</span><span style="color:var(--green)">$130243</span></div></div></div>
    </div>

    <!-- Rate Settings -->
    <div class="card" style="margin-top:16px;">
      <div class="ch"><span class="ct">Rate Settings</span><span style="font-family:var(--mono);font-size:.55rem;color:var(--t3)">adjust margin and commission rates</span></div>
      <div class="cb">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;">
          <div class="fg"><label class="fl">Prog. Margin %</label><input class="fi" id="r-prog-margin" value="60" placeholder="60" onchange="renderBudget()"></div>
          <div class="fg"><label class="fl">Prog. Commission %</label><input class="fi" id="r-prog-comm" value="12" placeholder="12" onchange="renderBudget()"></div>
          <div class="fg"><label class="fl">Omni Margin %</label><input class="fi" id="r-omni-margin" value="35" placeholder="35" onchange="renderBudget()"></div>
          <div class="fg"><label class="fl">Omni Commission %</label><input class="fi" id="r-omni-comm" value="12" placeholder="12" onchange="renderBudget()"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PROSPECTS -->
<div class="page" id="page-prospects">
  <div class="topbar"><div class="tb-l"><div class="tb-title">Prospecting</div><div class="tb-sub">Knoxville ‚Äî Meta Ad intelligence</div></div><div class="tb-r"><button class="btn" onclick="runScrubber()">‚ü≥ Run Scrubber</button><button class="btn btn-w" onclick="openAddContact(&#39;Cold&#39;)">+ Manual Add</button></div></div>
  <div class="content">
    <div class="card" style="overflow:hidden;">
      <div class="ch"><span class="ct">Meta Ad Library ‚Äî Knoxville, TN</span><span id="scrub-ts" style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">Not yet run</span></div>
      <div id="prospect-feed"></div>
    </div>
  </div>
</div>

<!-- REPORTS -->
<div class="page" id="page-reports">
  <div class="topbar"><div class="tb-l"><div class="tb-title">Client Reports</div><div class="tb-sub">upload PDF ‚Üí AI formats ‚Üí send</div></div></div>
  <div class="content">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
      <div>
        <div style="font-family:var(--mono);font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:7px;">Upload Simpli.fi PDF</div>
        <div class="upload-zone" onclick="document.getElementById(&#39;pdf-up&#39;).click()"><div style="font-size:1.3rem;margin-bottom:5px;">‚äû</div>Click to upload PDF export<div style="font-size:.6rem;color:var(--t3);margin-top:3px;">PDF only</div></div>
        <input type="file" id="pdf-up" accept=".pdf" style="display:none" onchange="handlePdf(this)">
        <div id="pdf-st" style="display:none;font-family:var(--mono);font-size:.68rem;color:var(--green);margin-top:7px;"></div>
      </div>
      <div>
        <div style="font-family:var(--mono);font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:7px;">Select &amp; Send</div>
        <div style="display:flex;flex-direction:column;gap:9px;">
          <div class="fg"><label class="fl">Client</label><select class="fs" id="rpt-cl"><option value="">Choose...</option><option value="mltr0u9ncet71tvhfk">GM Management (Lions Creative)</option><option value="ch1">Guardian Foundation Repair (Dickson Media Events)</option><option value="ch2">Knox Smile Dental (Dickson Media Events)</option><option value="ch3">East TN Auto Spa (Stone &amp; Co Marketing)</option></select></div>
          <div class="fg"><label class="fl">Report Period</label><input class="fi" id="rpt-per" placeholder="Week of Feb 17, 2026"></div>
          <button class="btn btn-w" onclick="genReport()">‚úâ Generate &amp; Send</button>
        </div>
      </div>
    </div>
    <div style="font-family:var(--mono);font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:7px;">Report Clients</div>
    <div class="card"><div id="rpt-list" style="padding:0;"><div class="rpt-row"><div><div style="color:var(--white)">Guardian Foundation Repair</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Dickson Media Events ¬∑ bob@guardianfr.com</div></div><div style="display:flex;align-items:center;gap:9px"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t3)">Weekly ‚Äî Mondays</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">Last: Feb 12</span><button class="btn btn-sm btn-w" onclick="quickSend(&#39;r1&#39;)">Send Now</button></div></div><div class="rpt-row"><div><div style="color:var(--white)">Knox Smile Dental</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Dickson Media Events ¬∑ afoster@knoxsmile.com</div></div><div style="display:flex;align-items:center;gap:9px"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t3)">Weekly ‚Äî Mondays</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">Last: Feb 12</span><button class="btn btn-sm btn-w" onclick="quickSend(&#39;r2&#39;)">Send Now</button></div></div><div class="rpt-row"><div><div style="color:var(--white)">East TN Auto Spa</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">Stone &amp; Co Marketing ¬∑ dave@etnauto.com</div></div><div style="display:flex;align-items:center;gap:9px"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t3)">Weekly ‚Äî Fridays</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">Last: Feb 16</span><button class="btn btn-sm btn-w" onclick="quickSend(&#39;r3&#39;)">Send Now</button></div></div></div></div>
    <div id="rpt-prev" style="display:none;margin-top:14px;"></div>
  </div>
</div>

<!-- INTEGRATIONS -->
<div class="page" id="page-integrations">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">Smart Inbox</div><div class="tb-sub" id="inbox-status-bar">Connect Gmail to get started</div></div>
    <div class="tb-r" id="inbox-topbar-btns">
      <button class="btn" id="btn-gmail-connect" onclick="gmailConnect()" style="border-color:#ea4335;color:#ea4335;">‚¨° Connect Gmail</button>
      <button class="btn btn-w" id="btn-inbox-scan" onclick="gmailScan()" style="display:none;">‚Ü∫ Scan Inbox</button>
      <button class="btn" id="btn-gmail-disconnect" onclick="gmailDisconnect()" style="display:none;border-color:var(--t3);color:var(--t3);">Disconnect</button>
    </div>
  </div>
  <div class="content">

    <!-- SETUP BANNER (shown before connect) -->
    <div id="inbox-setup-banner" class="card" style="border-color:#ea4335;margin-bottom:14px;">
      <div class="ch"><span class="ct" style="color:#ea4335;">‚¨° Gmail Connection Required</span></div>
      <div class="cb">
        <p style="font-size:.8rem;color:var(--t2);line-height:1.7;margin-bottom:12px;">This tab reads your Gmail inbox and uses AI to surface urgent items, update client history, and create to-dos ‚Äî automatically. <strong style="color:var(--white)">Requires a real URL to work</strong> (Gmail OAuth won't run from a local file). If you see errors after clicking Connect, follow the hosting steps below.</p>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:12px;">
          <div style="font-family:var(--mono);font-size:.65rem;color:var(--yellow);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;">üöÄ GitHub Pages Setup (5 minutes, free forever)</div>
          <div style="font-size:.78rem;color:var(--t2);line-height:2;">
            <div><span style="color:var(--white);font-weight:600;">1.</span> Go to <strong style="color:#58a6ff">github.com</strong> ‚Üí Sign up (free) or log in</div>
            <div><span style="color:var(--white);font-weight:600;">2.</span> Click <strong style="color:var(--white)">New repository</strong> ‚Üí name it <code style="background:var(--s2);padding:1px 5px;border-radius:3px">simplifi-crm</code> ‚Üí set to <strong>Public</strong> ‚Üí Create</div>
            <div><span style="color:var(--white);font-weight:600;">3.</span> Click <strong style="color:var(--white)">uploading an existing file</strong> ‚Üí drag and drop your HTML file ‚Üí Commit</div>
            <div><span style="color:var(--white);font-weight:600;">4.</span> Go to <strong>Settings ‚Üí Pages</strong> ‚Üí Source: <strong>Deploy from a branch</strong> ‚Üí Branch: <strong>main</strong> ‚Üí Save</div>
            <div><span style="color:var(--white);font-weight:600;">5.</span> Your URL will be: <code style="background:var(--s2);padding:1px 5px;border-radius:3px">https://[your-username].github.io/simplifi-crm/simplifi-command-center-v7.html</code></div>
            <div><span style="color:var(--white);font-weight:600;">6.</span> Enter that URL below, then click Connect Gmail</div>
          </div>
        </div>
        <div class="fgrid">
          <div class="fg"><label class="fl">Google Client ID <span style="color:var(--t3);font-size:.6rem">(from Google Cloud Console ‚Äî see instructions below)</span></label><input class="fi" id="gmail-client-id" placeholder="xxxx.apps.googleusercontent.com" oninput="saveIntSettings()"></div>
          <div class="fg"><label class="fl">Your Gmail Address</label><input class="fi" id="gmail-address" placeholder="you@gmail.com" oninput="saveIntSettings()"></div>
        </div>
        <details style="margin-top:10px;">
          <summary style="font-family:var(--mono);font-size:.65rem;color:var(--blue);cursor:pointer;letter-spacing:.05em;">‚ñ∏ How to get a Google Client ID (2 minutes)</summary>
          <div style="font-size:.75rem;color:var(--t2);line-height:2;padding:10px 0;">
            <div>1. Go to <strong style="color:#58a6ff">console.cloud.google.com</strong> ‚Üí Create a new project (name it anything)</div>
            <div>2. Search <strong>Gmail API</strong> ‚Üí Enable it</div>
            <div>3. Go to <strong>APIs &amp; Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí OAuth 2.0 Client ID</strong></div>
            <div>4. Application type: <strong>Web application</strong></div>
            <div>5. Authorized JavaScript origins: add your GitHub Pages URL (e.g. <code style="background:var(--s2);padding:1px 4px;border-radius:3px">https://yourusername.github.io</code>)</div>
            <div>6. Copy the <strong>Client ID</strong> and paste it above</div>
            <div>7. Go to <strong>OAuth consent screen</strong> ‚Üí Add your Gmail as a test user</div>
          </div>
        </details>
      </div>
    </div>

    <!-- URGENT ALERTS (populated after scan) -->
    <div id="inbox-urgent" style="display:none;margin-bottom:14px;">
      <div style="font-family:var(--mono);font-size:.65rem;color:var(--red);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">üî¥ Urgent ‚Äî Needs Immediate Attention</div>
      <div id="inbox-urgent-list"></div>
    </div>

    <!-- INBOX ANALYSIS FEED -->
    <div id="inbox-feed-wrap" style="display:none;">
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:14px;align-items:start;">

        <!-- EMAIL FEED -->
        <div>
          <div class="card">
            <div class="ch">
              <span class="ct">Inbox Analysis</span>
              <span id="inbox-email-count" style="font-family:var(--mono);font-size:.6rem;color:var(--t3);margin-left:8px;"></span>
              <div style="margin-left:auto;display:flex;gap:6px;">
                <button class="btn btn-sm" onclick="filterInbox(&#39;all&#39;)" id="if-all" style="border-color:var(--white);color:var(--white)">All</button>
                <button class="btn btn-sm" onclick="filterInbox(&#39;urgent&#39;)" id="if-urgent">Urgent</button>
                <button class="btn btn-sm" onclick="filterInbox(&#39;client&#39;)" id="if-client">Clients</button>
                <button class="btn btn-sm" onclick="filterInbox(&#39;internal&#39;)" id="if-internal">Internal</button>
              </div>
            </div>
            <div class="cb" style="padding:0;">
              <div id="inbox-email-list" style="max-height:600px;overflow-y:auto;"></div>
            </div>
          </div>
        </div>

        <!-- SIDEBAR: AI SUMMARY + ACTIONS -->
        <div>
          <div class="card" style="margin-bottom:12px;">
            <div class="ch"><span class="ct">‚ú¶ AI Daily Summary</span><button class="btn btn-sm" onclick="generateInboxSummary()" style="margin-left:auto">Refresh</button></div>
            <div class="cb">
              <div id="inbox-ai-summary" style="font-size:.78rem;color:var(--t2);min-height:80px;line-height:1.7;">Run a scan to generate your summary.</div>
            </div>
          </div>
          <div class="card" style="margin-bottom:12px;">
            <div class="ch"><span class="ct">üìã Auto-Created To-Dos</span></div>
            <div class="cb" style="padding:0;">
              <div id="inbox-auto-todos" style="max-height:250px;overflow-y:auto;padding:10px;font-size:.78rem;color:var(--t2);">Todos extracted from emails will appear here.</div>
            </div>
          </div>
          <div class="card">
            <div class="ch"><span class="ct">üìä Client Updates</span></div>
            <div class="cb" style="padding:0;">
              <div id="inbox-client-updates" style="max-height:250px;overflow-y:auto;padding:10px;font-size:.78rem;color:var(--t2);">Client history updates will appear here.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- QUICK EMAIL COMPOSER (kept) -->
    <div class="card" style="margin-top:14px;">
      <div class="ch"><span class="ct">Quick Email Composer</span><span style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">AI drafts ¬∑ opens in your email client</span></div>
      <div class="cb">
        <div class="fgrid" style="margin-bottom:10px;">
          <div class="fg"><label class="fl">Contact</label>
            <select class="fs" id="qe-contact" onchange="prefillQuickEmail()"><option value="">Select contact...</option><option value="c1">Mike Harrison ‚Äî Harrison Chevrolet</option><option value="c2">Sandra Lee ‚Äî Knoxville Injury Law</option><option value="c3">Tom Park ‚Äî Park HVAC Services</option><option value="c4">Amy Chen ‚Äî Chen Realty Group</option></select>
          </div>
          <div class="fg"><label class="fl">Email Type</label>
            <select class="fs" id="qe-type">
              <option value="followup">Follow-Up</option>
              <option value="proposal">Proposal Introduction</option>
              <option value="checkin">Check-In</option>
              <option value="cold">Cold Outreach</option>
              <option value="thankyou">Thank You</option>
              <option value="recap">Meeting Recap</option>
            </select>
          </div>
          <div class="fg full"><label class="fl">Context / Notes (optional)</label><input class="fi" id="qe-notes" placeholder="e.g. discussed CTV + Display, $4k/mo budget"></div>
        </div>
        <button class="btn btn-w" onclick="generateQuickEmail()">‚ú¶ Draft Email</button>
        <div id="qe-preview" style="display:none;margin-top:10px;">
          <input class="fi" id="qe-subject" placeholder="Subject line" style="margin-bottom:6px;">
          <textarea class="fta" id="qe-body" style="min-height:120px;"></textarea>
          <div style="display:flex;gap:7px;margin-top:7px;">
            <button class="btn btn-w" onclick="sendQuickEmail()">‚úâ Open in Email Client</button>
            <button class="btn" onclick="copyQuickEmail()">‚ßâ Copy</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MORNING BRIEFING (kept, compact) -->
    <div class="card" style="margin-top:14px;">
      <div class="ch"><span class="ct">Morning Briefing</span><span style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">AI-generated daily brief</span></div>
      <div class="cb">
        <div class="fgrid" style="margin-bottom:10px;">
          <div class="fg"><label class="fl">Your Name</label><input class="fi" id="int-name" placeholder="Your name" oninput="saveIntSettings()"></div>
          <div class="fg"><label class="fl">Your Email</label><input class="fi" id="int-email" placeholder="you@simplifi.com" type="email" oninput="saveIntSettings()"></div>
        </div>
        <div style="display:flex;gap:7px;">
          <button class="btn btn-w" onclick="previewBriefing()">‚ú¶ Generate Briefing</button>
          <button class="btn" onclick="openBriefingInMail()">‚úâ Open in Mail</button>
          <button class="btn" onclick="copyBriefingToClipboard()">‚ßâ Copy</button>
        </div>
        <div id="briefing-status" style="font-family:var(--mono);font-size:.63rem;color:var(--t3);margin-top:8px;"></div>
      </div>
    </div>

  </div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="topbar"><div class="tb-l"><div class="tb-title">Settings</div><div class="tb-sub">cold lead threshold, commission, products</div></div></div>
  <div class="content">
    <div class="card" style="margin-bottom:14px;">
      <div class="ch"><span class="ct">Pipeline Settings</span></div>
      <div class="cb">
        <div class="rate-row"><div class="rate-label">Cold Lead Threshold (days of silence)</div><input class="rate-input" id="set-cold" value="7" type="number"></div>
        <div class="rate-row"><div class="rate-label">Proposal Follow-Up Trigger (days without reply)</div><input class="rate-input" id="set-prop" value="3" type="number"></div>
        <div class="rate-row"><div class="rate-label">Your Name (for briefing email greeting)</div><input class="rate-input" id="set-name" value="" placeholder="Your name" style="width:160px;"></div>
        <div class="rate-row"><div class="rate-label">Your Email (briefing sent here)</div><input class="rate-input" id="set-email" value="" placeholder="you@simplifi.com" style="width:200px;"></div>
        <div style="margin-top:12px;"><button class="btn btn-w" onclick="saveSettings()">Save Settings</button></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:14px;">
      <div class="ch"><span class="ct">Manage Budget Products</span><span style="font-family:var(--mono);font-size:.55rem;color:var(--t3)">add/remove tactic lines</span></div>
      <div class="cb">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
          <div>
            <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Programmatic Products</div>
            <div id="prog-prod-list"></div>
            <div style="display:flex;gap:7px;margin-top:8px;"><input class="fi" id="new-prog" placeholder="New product..." style="flex:1"><button class="btn btn-sm btn-green" onclick="addProduct(&#39;prog&#39;)">+ Add</button></div>
          </div>
          <div>
            <div style="font-family:var(--mono);font-size:.6rem;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Omni / Social Products</div>
            <div id="omni-prod-list"></div>
            <div style="display:flex;gap:7px;margin-top:8px;"><input class="fi" id="new-omni" placeholder="New product..." style="flex:1"><button class="btn btn-sm" style="border-color:var(--blue);color:var(--blue);" onclick="addProduct(&#39;omni&#39;)">+ Add</button></div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="ch"><span class="ct">Data Management</span></div>
      <div class="cb" style="display:flex;gap:8px;">
        <button class="btn" onclick="exportData()">‚Üì Export All Data (JSON)</button>
        <button class="btn btn-danger" onclick="clearData()">‚ö† Clear All Data</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PROPOSAL BUILDER ‚ïê‚ïê‚ïê -->
<div class="page" id="page-proposal">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">Proposal Builder</div><div class="tb-sub">Build client-facing media plans ‚Üí export to Excel</div></div>
    <div class="tb-r">
      <button class="btn" onclick="clearProposal()">‚Ü∫ New Proposal</button>
      <button class="btn btn-w" onclick="exportProposalExcel()">‚¨á Export to Excel</button>
    </div>
  </div>
  <div class="content">
    <!-- CLIENT INFO -->
    <div class="card">
      <div class="ch"><span class="ct">Client &amp; Campaign Info</span></div>
      <div class="cb"><div class="fgrid">
        <div class="fg"><label class="fl">Advertiser Name *</label><input class="fi" id="pb-client" placeholder="e.g. Feels Like Summer Fest"></div>
        <div class="fg"><label class="fl">Vertical</label><select class="fs" id="pb-vertical"><option value="">Select...</option><option>Automotive</option><option>Legal</option><option>QSR / Restaurant</option><option>Multi-Location Franchise</option><option>Medical / Healthcare</option><option>Insurance</option><option>Tourism / Events</option><option>Home Services</option><option>Retail</option><option>Real Estate</option><option>Other</option></select></div>
        <div class="fg"><label class="fl">Primary KPI</label><select class="fs" id="pb-kpi"><option>Reach</option><option>Conversions</option><option>Foot Traffic</option><option>Brand Awareness</option><option>Leads / Form Fills</option><option>Website Traffic</option></select></div>
        <div class="fg"><label class="fl">Advertiser Website</label><input class="fi" id="pb-website" placeholder="https://"></div>
        <div class="fg"><label class="fl">Flight Start</label><input class="fi" id="pb-start" type="date"></div>
        <div class="fg"><label class="fl">Flight End</label><input class="fi" id="pb-end" type="date"></div>
        <div class="fg full"><label class="fl">Geography</label><select class="fs" id="pb-geo-type" onchange="toggleGeoInput()"><option value="dma">Knoxville DMA</option><option value="counties">East TN Counties</option><option value="zips">Custom Zip Code List</option><option value="custom">Custom Description</option></select></div>
        <div class="fg full" id="pb-geo-custom-wrap" style="display:none"><label class="fl">Custom Geo / Zip Codes</label><textarea class="fta" id="pb-geo-custom" placeholder="Paste zip codes or describe geography..."></textarea></div>
        <div class="fg full"><label class="fl">Proposal Notes (appears at bottom of plan)</label><textarea class="fta" id="pb-notes" style="min-height:60px">Once activated, campaign best practices would be to have fluid and flexible budgets between tactics/media types in order to maximize performance and delivery.
In order to retarget users via website retargeting and track conversions, a Simpli.fi pixel must be placed on the client's homepage.
Best practice for Addressable Geo-Fencing is to set the campaign-level geo to National in an effort to reach users even when they leave the initial radius (tighter geo is applied during audience curation).</textarea></div>
      </div></div>
    </div>

    <!-- BUDGET TIERS -->
    <div class="card">
      <div class="ch"><span class="ct">Budget Tiers</span><button class="btn btn-sm" onclick="addTier()" style="margin-left:auto">+ Add Tier</button></div>
      <div class="cb"><div id="pb-tiers-list"></div></div>
    </div>

    <!-- LINE ITEMS -->
    <div class="card">
      <div class="ch"><span class="ct">Media Plan Line Items</span><button class="btn btn-sm" onclick="addLineItem()" style="margin-left:auto">+ Add Line Item</button></div>
      <div class="cb">
        <div style="font-family:var(--mono);font-size:.6rem;color:var(--t2);margin-bottom:8px;">Add each tactic. Budget fields appear per tier. CPM √ó Budget = auto-calculated impressions.</div>
        <div id="pb-lines-wrap">
          <table class="tbl" id="pb-lines-tbl">
            <thead><tr id="pb-lines-hdr"></tr></thead>
            <tbody id="pb-lines-body"></tbody>
          </table>
        </div>
        <button class="btn btn-sm" onclick="addLineItem()" style="margin-top:8px">+ Add Line Item</button>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="card">
      <div class="ch"><span class="ct">Summary Preview</span><button class="btn btn-sm" onclick="renderProposalPreview()" style="margin-left:auto">‚Ü∫ Refresh Preview</button></div>
      <div class="cb" id="pb-preview" style="font-size:.8rem;color:var(--t2);">Fill in client info and line items, then click Refresh Preview.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê AI ASSISTANT / KNOWLEDGE BASE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-kb">
  <div class="topbar">
    <div class="tb-l"><div class="tb-title">AI Assistant</div><div class="tb-sub">Ask questions ‚Äî powered by your knowledge base</div></div>
    <div class="tb-r"><button class="btn" onclick="saveKB()">üíæ Save Knowledge Base</button></div>
  </div>
  <div class="content" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
    <!-- KNOWLEDGE BASE EDITOR -->
    <div>
      <div class="card">
        <div class="ch"><span class="ct">Knowledge Base</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t2);margin-left:auto">Paste anything ‚Äî talking points, rate info, objections, etc.</span></div>
        <div class="cb">
          <div id="kb-sections">
            <div style="margin-bottom:12px;">
              <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;">Products &amp; Capabilities</div>
              <textarea class="fta" id="kb-products" style="min-height:100px" placeholder="Paste product talking points, what each product does, when to recommend it...">CTV (Connected TV / OTT): Video ads served on streaming platforms (Hulu, Roku, etc.) on large screens. Best for brand awareness and reaching cord-cutters. CPMs typically $25-55.
Display: Banner ads across desktop, mobile, tablet. Uses keyword behavioral, geo-fencing, addressable, retargeting. CPMs typically $3-5.
Online Video (OLV): Pre-roll and mid-roll video on desktop/mobile. :15s and :30s. CPMs typically $11-15.
Audio: Streaming radio (Spotify, iHeart, Audacy) and podcasts. Companion display included. CPMs $7-30.
SEM: Google Search text ads. Pay per click. Great for high-intent buyers.
YouTube: In-stream TrueView ads. Skippable. CPM ~$4-5.
YouTube TV: Non-skippable ads on YouTube's live TV service. CPM ~$55.
Netflix: Display on ad-supported Netflix via DV360. Minimum $2,500/mo. CPM ~$22.
Native: Ads that match publisher look/feel. 6x response rate vs display.
DOOH: Digital out-of-home ‚Äî billboards, airport screens, theater screens. Min $1,500/mo.
Geo-Fencing: Target users who enter specific physical locations. Conversion zones track offline visits.
Addressable Geo-Fencing: Household-level targeting using plat line data and 3,000+ demographic variables.</textarea>
            </div>
            <div style="margin-bottom:12px;">
              <div style="font-family:var(--mono);font-size:.6rem;color:var(--yellow);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;">Territory &amp; Market Info</div>
              <textarea class="fta" id="kb-territory" style="min-height:80px" placeholder="Your East TN territory info, key markets, counties you cover...">Territory: East Tennessee ‚Äî Knoxville DMA
Key counties: Knox, Sevier, Blount, Anderson, Loudon, Union, Grainger, Hamblen, Jefferson, Cocke, Greene, Hawkins, Sullivan, Washington
Key markets: Knoxville, Maryville, Oak Ridge, Sevierville, Pigeon Forge, Gatlinburg, Morristown, Kingsport, Johnson City
Common geo approach: Either run Knoxville DMA broadly, or break out to specific county/zip lists for hyper-local clients.</textarea>
            </div>
            <div style="margin-bottom:12px;">
              <div style="font-family:var(--mono);font-size:.6rem;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;">Verticals &amp; Sales Notes</div>
              <textarea class="fta" id="kb-verticals" style="min-height:80px" placeholder="Notes on each vertical ‚Äî Auto, Legal, QSR, Medical, Insurance, Tourism...">Automotive: OTT + Display is the standard combo. Geo-fence competitor lots. SEM for high-intent. Emphasize conquest strategy.
Legal: Geo-fence courthouses, hospitals, competing law firms. OLV and CTV for credibility.
QSR/Restaurant: Geo-fence competitive locations. Lunch/dinner dayparting. Coupon/offer-based creative works well.
Medical: Addressable demographics are powerful (target specific patient profiles). HIPAA-compliant approach.
Insurance: Keyword behavioral (life events, home purchase, new baby). Geo-fence competitor agents.
Tourism: CTV + Audio for broad awareness. Geo-fence regional attractions. Seasonal flight dates critical.</textarea>
            </div>
            <div>
              <div style="font-family:var(--mono);font-size:.6rem;color:var(--purple);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;">Other Notes / Reference Info</div>
              <textarea class="fta" id="kb-other" style="min-height:80px" placeholder="Anything else ‚Äî objection handling, pricing minimums, internal notes...">Minimum spend: $500/mo per tactic typically.
Netflix minimum: $15K/90 days for custom deals, $2,500 genre/demo targeted.
LinkedIn: Highly restricted for political. Minimum $2,500/mo.
DOOH minimum: $1,500/mo.
Pixel required for site retargeting and conversion tracking ‚Äî always mention this.
Flexible budget language: 'Best practice is to have fluid and flexible budgets between tactics to maximize performance.'</textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI CHAT -->
    <div>
      <div class="card" style="position:sticky;top:16px;">
        <div class="ch"><span class="ct">‚ú¶ Ask the Assistant</span></div>
        <div class="cb">
          <div id="kb-chat-log" style="min-height:300px;max-height:450px;overflow-y:auto;margin-bottom:12px;padding:8px;background:var(--surface);border-radius:4px;border:1px solid var(--border);">
            <div style="color:var(--t2);font-size:.75rem;font-style:italic;">Ask me anything about Simpli.fi products, your territory, verticals, how to position a deal, what CPMs to expect, or what tactic to recommend for a client.</div>
          </div>
          <div style="display:flex;gap:8px;">
            <input class="fi" id="kb-q" placeholder="e.g. What tactic should I recommend for a car dealership?" style="flex:1" onkeydown="if(event.key===&#39;Enter&#39;)askKB()">
            <button class="btn btn-w" onclick="askKB()">Ask ‚ú¶</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn btn-sm" onclick="quickAsk(&#39;What CPMs should I expect for CTV?&#39;)">CTV CPMs</button>
            <button class="btn btn-sm" onclick="quickAsk(&#39;What products work best for auto dealers?&#39;)">Auto Vertical</button>
            <button class="btn btn-sm" onclick="quickAsk(&#39;What is the minimum spend for Netflix?&#39;)">Netflix Min</button>
            <button class="btn btn-sm" onclick="quickAsk(&#39;What geo targeting options do I have for East TN?&#39;)">East TN Geo</button>
            <button class="btn btn-sm" onclick="quickAsk(&#39;How do I handle a client who says digital advertising does not work?&#39;)">Objection Help</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
<div class="overlay" id="m-contact"><div class="modal"><div class="mh"><div class="mt" id="mc-title">Add Contact</div><button class="mc" onclick="closeM(&#39;m-contact&#39;)">‚úï</button></div><div class="mb"><div class="fgrid"><div class="fg"><label class="fl">First Name *</label><input class="fi" id="cf-fn"></div><div class="fg"><label class="fl">Last Name</label><input class="fi" id="cf-ln"></div><div class="fg full"><label class="fl">Company *</label><input class="fi" id="cf-co"></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="cf-ph"></div><div class="fg"><label class="fl">Email</label><input class="fi" id="cf-em" type="email"></div><div class="fg"><label class="fl">Vertical</label><select class="fs" id="cf-vt"><option value="">Select...</option><option>Automotive</option><option>Home Services</option><option>Healthcare</option><option>Legal</option><option>Real Estate</option><option>Restaurant</option><option>Retail</option><option>Finance/Insurance</option><option>Education</option><option>Agency</option><option>Other</option></select></div><div class="fg"><label class="fl">Stage</label><select class="fs" id="cf-st"><option value="Cold">Cold</option><option value="Attempted Contact">Attempted Contact</option><option value="Warm">Warm</option><option value="Follow-Up Scheduled">Follow-Up Scheduled</option><option value="Proposal Sent">Proposal Sent</option><option value="Proposal Revision">Proposal Revision</option><option value="At the Table">At the Table</option><option value="On Hold">On Hold</option><option value="Closed Won">Closed Won</option><option value="Closed Lost">Closed Lost</option><option value="Active Client">Active Client</option><option value="Agency Partner">Agency Partner</option></select></div><div class="fg"><label class="fl">Est. Budget</label><input class="fi" id="cf-bg" placeholder="$2,500/mo"></div><div class="fg"><label class="fl">Follow-Up</label><input class="fi" id="cf-fu" type="date"></div><div class="fg"><label class="fl">Source</label><select class="fs" id="cf-src"><option value="">How found?</option><option>Cold Call</option><option>Referral</option><option>Meta Scrubber</option><option>LinkedIn</option><option>Networking</option><option>Inbound</option><option>Agency Referral</option></select></div><div class="fg full"><label class="fl">Notes</label><textarea class="fta" id="cf-no"></textarea></div></div><input type="hidden" id="cf-id"></div><div class="mf"><button class="btn" onclick="closeM(&#39;m-contact&#39;)">Cancel</button><button class="btn btn-w" onclick="saveContact()">Save</button></div></div></div>

<div class="overlay" id="m-detail"><div class="modal wide"><div class="mh"><div class="mt" id="md-title">‚Äî</div><button class="mc" onclick="closeM(&#39;m-detail&#39;)">‚úï</button></div><div class="mb" id="md-body"></div><div class="mf" id="md-foot"></div></div></div>

<div class="overlay" id="m-log"><div class="modal"><div class="mh"><div class="mt">Log Call</div><button class="mc" onclick="closeM(&#39;m-log&#39;)">‚úï</button></div><div class="mb"><div class="fgrid"><div class="fg full"><input class="fi" id="lg-name" readonly="" style="color:var(--t2)"><input type="hidden" id="lg-id"></div><div class="fg"><label class="fl">Update Stage</label><select class="fs" id="lg-st"><option value="">Keep current</option><option value="Cold">Cold</option><option value="Attempted Contact">Attempted Contact</option><option value="Warm">Warm</option><option value="Follow-Up Scheduled">Follow-Up Scheduled</option><option value="Proposal Sent">Proposal Sent</option><option value="Proposal Revision">Proposal Revision</option><option value="At the Table">At the Table</option><option value="On Hold">On Hold</option><option value="Closed Won">Closed Won</option><option value="Closed Lost">Closed Lost</option><option value="Active Client">Active Client</option></select></div><div class="fg"><label class="fl">Next Follow-Up</label><input class="fi" id="lg-fu" type="date"></div><div class="fg full"><label class="fl">Notes</label><textarea class="fta" id="lg-no"></textarea></div></div><div class="ai-box" id="lg-ai" style="display:none"><div class="ai-l">AI Draft Follow-Up Email</div><div class="ai-out" id="lg-ai-out"></div></div></div><div class="mf"><button class="btn" onclick="genFollowUp()">‚ú¶ Draft Email</button><button class="btn" onclick="closeM(&#39;m-log&#39;)">Cancel</button><button class="btn btn-w" onclick="saveLog()">Save Log</button></div></div></div>

<div class="overlay" id="m-todo"><div class="modal"><div class="mh"><div class="mt">Add To-Do</div><button class="mc" onclick="closeM(&#39;m-todo&#39;)">‚úï</button></div><div class="mb"><div class="fgrid"><div class="fg full"><label class="fl">Task *</label><input class="fi" id="td-text"></div><div class="fg"><label class="fl">Due Date</label><input class="fi" id="td-due" type="date"></div><div class="fg"><label class="fl">Priority</label><select class="fs" id="td-pri"><option value="high">High</option><option value="medium" selected="">Medium</option><option value="low">Low</option></select></div><div class="fg full"><label class="fl">Linked Contact</label><select class="fs" id="td-lnk"><option value="">None</option></select></div></div></div><div class="mf"><button class="btn" onclick="closeM(&#39;m-todo&#39;)">Cancel</button><button class="btn btn-w" onclick="saveTodo()">Add</button></div></div></div>

<div class="overlay" id="m-agency"><div class="modal"><div class="mh"><div class="mt" id="ma-title">Add Agency</div><button class="mc" onclick="closeM(&#39;m-agency&#39;)">‚úï</button></div><div class="mb"><div class="fgrid"><div class="fg full"><label class="fl">Agency Name *</label><input class="fi" id="ag-nm"></div><div class="fg"><label class="fl">Contact</label><input class="fi" id="ag-ct"></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="ag-ph"></div><div class="fg"><label class="fl">Email</label><input class="fi" id="ag-em" type="email"></div><div class="fg"><label class="fl">Stage</label><select class="fs" id="ag-st"><option value="Agency Partner">Active Partner</option><option value="Warm">Warm</option><option value="Proposal Sent">Proposal Sent</option></select></div><div class="fg"><label class="fl">Monthly Value</label><input class="fi" id="ag-bg"></div><div class="fg full"><label class="fl">Notes</label><textarea class="fta" id="ag-no"></textarea></div></div><input type="hidden" id="ag-id"></div><div class="mf"><button class="btn" onclick="closeM(&#39;m-agency&#39;)">Cancel</button><button class="btn btn-w" onclick="saveAgency()">Save</button></div></div></div>

<div class="overlay" id="m-child"><div class="modal"><div class="mh"><div class="mt" id="mch-title">Add Client</div><button class="mc" onclick="closeM(&#39;m-child&#39;)">‚úï</button></div><div class="mb"><div class="fgrid"><div class="fg full"><label class="fl">Business Name *</label><input class="fi" id="ch-nm"></div><div class="fg"><label class="fl">Contact</label><input class="fi" id="ch-ct"></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="ch-ph"></div><div class="fg"><label class="fl">Email</label><input class="fi" id="ch-em" type="email"></div><div class="fg"><label class="fl">Vertical</label><select class="fs" id="ch-vt"><option value="">Select...</option><option>Automotive</option><option>Home Services</option><option>Healthcare</option><option>Legal</option><option>Real Estate</option><option>Restaurant</option><option>Retail</option><option>Finance/Insurance</option><option>Other</option></select></div><div class="fg"><label class="fl">Monthly Budget</label><input class="fi" id="ch-bg"></div><div class="fg full"><label class="fl">Campaign Notes</label><textarea class="fta" id="ch-no"></textarea></div><div class="fg full"><label class="fl">Report Email</label><input class="fi" id="ch-re" type="email"></div></div><input type="hidden" id="ch-par"><input type="hidden" id="ch-id"></div><div class="mf"><button class="btn" onclick="closeM(&#39;m-child&#39;)">Cancel</button><button class="btn btn-w" onclick="saveChild()">Save</button></div></div></div>

<div class="overlay" id="m-briefing"><div class="modal wide"><div class="mh"><div class="mt">Morning Briefing Email</div><button class="mc" onclick="closeM(&#39;m-briefing&#39;)">‚úï</button></div><div class="mb" id="mb-body"></div><div class="mf"><button class="btn btn-w" onclick="closeM(&#39;m-briefing&#39;)">Close</button></div></div></div>

<!-- ADD/EDIT BUDGET CLIENT -->
<div class="overlay" id="m-budget-client">
  <div class="modal wide">
    <div class="mh"><div class="mt" id="mbc-title">Add Budget Client</div><button class="mc" onclick="closeM(&#39;m-budget-client&#39;)">‚úï</button></div>
    <div class="mb">
      <div class="fgrid" style="margin-bottom:14px;">
        <div class="fg"><label class="fl">Client Name *</label><input class="fi" id="bc-name" placeholder="Client name"></div>
        <div class="fg"><label class="fl">Type</label><select class="fs" id="bc-type" onchange="toggleAgencyParent()"><option value="brand">Brand Direct</option><option value="agency">Agency (Parent)</option><option value="agency-child">Agency Client (Child)</option></select></div>
        <div class="fg" id="bc-parent-wrap" style="display:none"><label class="fl">Parent Agency</label><select class="fs" id="bc-parent"><option value="">‚Äî Select Agency ‚Äî</option></select></div>
        <div class="fg full"><label class="fl">Status</label><select class="fs" id="bc-status"><option value="active">Active</option><option value="pending">Pending</option><option value="paused">Paused</option></select></div>
      </div>
      <div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Programmatic Products to Track</div>
      <div id="bc-prog-checks" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;"></div>
      <div style="font-family:var(--mono);font-size:.6rem;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Omni Products to Track</div>
      <div id="bc-omni-checks" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;"></div>
      <input type="hidden" id="bc-id">
    </div>
    <div class="mf"><button class="btn" onclick="closeM(&#39;m-budget-client&#39;)">Cancel</button><button class="btn btn-w" onclick="saveBudgetClient()">Save Client</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function lsGet(key){try{const v=localStorage.getItem(key);return v?JSON.parse(v):null;}catch(e){return null;}}
function lsSet(key,val){try{localStorage.setItem(key,JSON.stringify(val));}catch(e){console.warn('save failed',e);}}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var contacts = [];
var agencies = [];
var todos = [];
var reportClients = [];
var mockProspects = [];
var budgetClients = [];
var PROG_PRODUCTS = ['CTV','Display','OLV','Native','Audio'];
var OMNI_PRODUCTS = ['SEM','LSA','YouTube','YouTube TV','Netflix','DOOH'];

var editCId = null;
var editAId = null;
var editChId = null;
var editBCId = null;
var pipeFilter = 'all';
var tdFilter = 'all';
var budgetM = new Date().getMonth();

var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
var CURM = new Date().getMonth();

var SC = {
  'Cold':'s-cold','Attempted Contact':'s-attempted','Warm':'s-warm',
  'Follow-Up Scheduled':'s-followup','Proposal Sent':'s-proposal',
  'Proposal Revision':'s-revision','At the Table':'s-table','On Hold':'s-hold',
  'Closed Won':'s-won','Closed Lost':'s-lost','Active Client':'s-active','Agency Partner':'s-agency'
};

// ‚îÄ‚îÄ‚îÄ SEED DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dAgo(n){var d=new Date();d.setDate(d.getDate()-n);return d.toISOString();}

function seedContacts(){return[
  {id:'c1',firstName:'Mike',lastName:'Harrison',company:'Harrison Chevrolet',phone:'(865) 555-0101',email:'mharrison@harrisonchev.com',vertical:'Automotive',stage:'Proposal Sent',budget:'$4,500/mo',followUp:'',notes:'OTT + display. Compete with Capitol Auto.',source:'Cold Call',lastContact:dAgo(3),createdAt:dAgo(14),callLog:[]},
  {id:'c2',firstName:'Sandra',lastName:'Lee',company:'Knoxville Injury Law',phone:'(865) 555-0202',email:'slee@kxlaw.com',vertical:'Legal',stage:'At the Table',budget:'$6,000/mo',followUp:'',notes:'Geo-fencing competitor law offices. Budget approved.',source:'Referral',lastContact:dAgo(1),createdAt:dAgo(21),callLog:[]},
  {id:'c3',firstName:'Tom',lastName:'Park',company:'Park HVAC Services',phone:'(865) 555-0303',email:'tpark@parkhvac.com',vertical:'Home Services',stage:'Warm',budget:'$1,500/mo',followUp:'',notes:'Call after spring season.',source:'Cold Call',lastContact:dAgo(9),createdAt:dAgo(30),callLog:[]},
  {id:'c4',firstName:'Amy',lastName:'Chen',company:'Chen Realty Group',phone:'(865) 555-0606',email:'achen@chenrealty.com',vertical:'Real Estate',stage:'Follow-Up Scheduled',budget:'$2,000/mo',followUp:'',notes:'Geo-fencing open houses.',source:'LinkedIn',lastContact:dAgo(2),createdAt:dAgo(8),callLog:[]},
];}

function seedAgencies(){return[
  {id:'a1',name:'Dickson Media Events',contact:'Lisa Monroe',phone:'(865) 555-0404',email:'lmonroe@dicksonmedia.com',stage:'Agency Partner',budget:'$15,000/mo',notes:'Active white-label. 3 clients.',lastContact:dAgo(5),createdAt:dAgo(60),children:[
    {id:'ch1',name:'Guardian Foundation Repair',contact:'Bob Harris',phone:'(865) 555-1111',email:'bob@guardianfr.com',vertical:'Home Services',budget:'$9,000/mo',notes:'Full funnel.',reportEmail:'bob@guardianfr.com',campaignStatus:'Active'},
    {id:'ch2',name:'Knox Smile Dental',contact:'Dr. Amy Foster',phone:'(865) 555-2222',email:'afoster@knoxsmile.com',vertical:'Healthcare',budget:'$1,800/mo',notes:'Display.',reportEmail:'afoster@knoxsmile.com',campaignStatus:'Active'}
  ]},
  {id:'a2',name:'Stone & Co Marketing',contact:'Brad Stone',phone:'(865) 555-0707',email:'brad@stonecomarketing.com',stage:'Agency Partner',budget:'$8,000/mo',notes:'2 year partner.',lastContact:dAgo(10),createdAt:dAgo(180),children:[
    {id:'ch3',name:'East TN Auto Spa',contact:'Dave Mullins',phone:'(865) 555-3333',email:'dave@etnauto.com',vertical:'Automotive',budget:'$1,200/mo',notes:'Display only.',reportEmail:'dave@etnauto.com',campaignStatus:'Active'}
  ]},
  {id:'a3',name:'Ridge Digital Media',contact:'Karen Webb',phone:'(865) 555-0808',email:'kwebb@ridgedigital.com',stage:'Warm',budget:'',notes:'Pitched 2/10.',lastContact:dAgo(9),createdAt:dAgo(20),children:[]}
];}

function seedTodos(){return[
  {id:'t1',text:'Send revised proposal to Harrison Chevrolet',done:false,auto:true,type:'proposal',contactId:'c1',due:'',priority:'high',createdAt:dAgo(1)},
  {id:'t2',text:'Re-engage Tom Park (Park HVAC) ‚Äî 9 days cold',done:false,auto:true,type:'cold',contactId:'c3',due:'',priority:'high',createdAt:new Date().toISOString()},
  {id:'t3',text:'Follow up ‚Äî Amy Chen (Chen Realty)',done:false,auto:true,type:'followup',contactId:'c4',due:'',priority:'medium',createdAt:new Date().toISOString()},
  {id:'t4',text:'Prepare Q1 commission summary',done:false,auto:false,type:'manual',contactId:'',due:'',priority:'medium',createdAt:dAgo(0)},
];}

function seedReports(){return[
  {id:'r1',clientName:'Guardian Foundation Repair',agencyName:'Dickson Media Events',email:'bob@guardianfr.com',schedule:'Weekly ‚Äî Mondays',lastSent:dAgo(7)},
  {id:'r2',clientName:'Knox Smile Dental',agencyName:'Dickson Media Events',email:'afoster@knoxsmile.com',schedule:'Weekly ‚Äî Mondays',lastSent:dAgo(7)},
  {id:'r3',clientName:'East TN Auto Spa',agencyName:'Stone & Co Marketing',email:'dave@etnauto.com',schedule:'Weekly ‚Äî Fridays',lastSent:dAgo(3)}
];}

function seedBudget(){return[
  {id:'b1',name:'All American Mattress',type:'brand',status:'active',prog:{CTV:[0,0,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000]},omni:{}},
  {id:'b2',name:'Apex Bank',type:'brand',status:'active',prog:{Display:[850,4350,4350,4350,850,850,850,850,850,850,850,850]},omni:{SEM:[2500,12000,4000,4000,2500,2500,2500,2500,2500,2500,2500,2500]}},
  {id:'b3',name:'Clearwater Plumbing',type:'brand',status:'active',prog:{CTV:[6300,950,6300,6300,6300,6300,6300,6300,6300,6300,6300,6300]},omni:{}},
  {id:'b4',name:'Delnero Group',type:'brand',status:'active',prog:{CTV:[4100,4100,6100,6100,6100,6100,6100,6100,6100,6100,6100,6100]},omni:{YouTube:[2000,2000,3500,3500,3500,3500,3500,3500,3500,3500,3500,3500]}},
  {id:'b5',name:'Dickson Media Group',type:'agency',status:'active',prog:{CTV:[3200,1100,6000,0,0,0,0,0,0,0,0,0]},omni:{SEM:[900,300,0,0,0,0,0,0,0,0,0,0]}},
  {id:'b6',name:'Echo Trace AI',type:'brand',status:'active',prog:{CTV:[0,0,20000,20000,20000,20000,20000,0,0,0,0,0]},omni:{}},
  {id:'b7',name:'Friendship Auto',type:'brand',status:'active',prog:{CTV:[26500,26500,40000,40000,40000,40000,40000,40000,40000,40000,40000,40000]},omni:{}},
  {id:'b8',name:'F Street Investments',type:'brand',status:'active',prog:{OLV:[0,2500,6800,6800,6800,6800,6800,6800,6800,6800,6800,6800]},omni:{}},
  {id:'b9',name:'Guardian Foundation Repair',type:'agency',status:'active',prog:{Display:[1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500]},omni:{SEM:[7500,3500,7500,7500,7500,7500,7500,7500,7500,7500,7500,7500]}},
  {id:'b10',name:'The Jenkins Agency',type:'agency',status:'active',prog:{CTV:[11600,10500,20000,13000,13000,13000,13000,13000,13000,13000,13000,13000]},omni:{}},
  {id:'b11',name:'Josh Hemphill State Farm',type:'brand',status:'pending',prog:{CTV:[0,0,2500,0,0,0,0,0,0,0,0,0]},omni:{}},
  {id:'b12',name:'Knoxville Wholesale Furniture',type:'brand',status:'active',prog:{CTV:[23000,23000,23000,23000,23000,23000,23000,23000,23000,23000,23000,23000]},omni:{SEM:[12000,12000,12000,12000,12000,12000,12000,12000,12000,12000,12000,12000]}},
  {id:'b13',name:'OEB Law',type:'brand',status:'active',prog:{Display:[0,0,1000,5000,5000,5000,5000,5000,5000,5000,5000,5000]},omni:{}},
  {id:'b14',name:'Lions Creative',type:'agency',status:'active',prog:{Display:[0,0,15000,15000,15000,15000,15000,15000,15000,15000,15000,15000]},omni:{}},
  {id:'b15',name:'McGuire Roofing',type:'brand',status:'active',prog:{CTV:[2500,2500,2500,2500,2500,2500,2500,2500,2500,2500,2500,2500]},omni:{}},
  {id:'b16',name:'Scott Adams',type:'brand',status:'pending',prog:{CTV:[0,0,5000,5000,0,0,0,0,0,0,0,0]},omni:{}},
  {id:'b17',name:'Oak Ridge Nissan',type:'brand',status:'pending',prog:{CTV:[0,0,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000]},omni:{}},
  {id:'b18',name:'ZC Productions',type:'brand',status:'active',prog:{Native:[1200,1600,2400,2400,3600,3600,3600,4800,4800,4800,4800,5600]},omni:{}},
];}

// ‚îÄ‚îÄ‚îÄ LOAD / SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadAll(){
  try {
    contacts     = lsGet('sc4_contacts')     || seedContacts();
    agencies     = lsGet('sc4_agencies')     || seedAgencies();
    todos        = lsGet('sc4_todos')        || seedTodos();
    reportClients= lsGet('sc4_reports')      || seedReports();
    budgetClients= lsGet('sc4_budget')       || seedBudget();
    var prods    = lsGet('sc4_products');
    if(prods){ PROG_PRODUCTS=prods.prog; OMNI_PRODUCTS=prods.omni; }
  } catch(e) {
    contacts=seedContacts(); agencies=seedAgencies();
    todos=seedTodos(); reportClients=seedReports(); budgetClients=seedBudget();
  }
  refreshAll();
}

function saveAll(){
  try {
    lsSet('sc4_contacts',  contacts);
    lsSet('sc4_agencies',  agencies);
    lsSet('sc4_todos',     todos);
    lsSet('sc4_reports',   reportClients);
    lsSet('sc4_budget',    budgetClients);
    lsSet('sc4_products',  {prog:PROG_PRODUCTS, omni:OMNI_PRODUCTS});
  } catch(e){ console.warn('save error',e); }
}

function saveBudgetData(){ saveAll(); toast('Budget saved','ok'); }

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function daysSince(iso){ if(!iso) return 999; return Math.floor((new Date()-new Date(iso))/864e5); }
function fmtDate(iso){ if(!iso) return '‚Äî'; return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric'}); }
function fmtM(n){ return n===0?'‚Äî':'$'+Math.round(n).toLocaleString(); }
function badge(s){ var c=SC[s]||'s-cold'; return '<span class="badge '+c+'"><span class="bdot" style="background:currentColor;opacity:.6"></span>'+s+'</span>'; }
function coldF(){ return '<span class="cold-f">COLD</span>'; }
function toast(msg,t){
  var el=document.getElementById('toast');
  el.textContent=msg;
  el.className='toast show '+(t==='err'?'err':t==='ok'?'ok':'');
  setTimeout(function(){el.classList.remove('show');},3200);
}
function closeM(id){ document.getElementById(id).classList.remove('open'); }
function openM(id){ document.getElementById(id).classList.add('open'); }
function getColdThreshold(){ var el=document.getElementById('set-cold'); return (el&&el.value)?parseInt(el.value)||7:7; }
function getPropThreshold(){ var el=document.getElementById('set-prop'); return (el&&el.value)?parseInt(el.value)||3:3; }

// ‚îÄ‚îÄ‚îÄ BUDGET CALC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getRates(){
  var pmEl=document.getElementById('r-prog-margin'); var pm=pmEl&&pmEl.value?parseFloat(pmEl.value):60;
  var pcEl=document.getElementById('r-prog-comm');  var pc=pcEl&&pcEl.value?parseFloat(pcEl.value):12;
  var omEl=document.getElementById('r-omni-margin'); var om=omEl&&omEl.value?parseFloat(omEl.value):35;
  var ocEl=document.getElementById('r-omni-comm');  var oc=ocEl&&ocEl.value?parseFloat(ocEl.value):12;
  return {pm:pm/100, pc:pc/100, om:om/100, oc:oc/100};
}
function getClientProgTotal(c,m){ return PROG_PRODUCTS.reduce(function(s,p){return s+(Number((c.prog&&c.prog[p]&&c.prog[p][m])||0));},0); }
function getClientOmniTotal(c,m){ return OMNI_PRODUCTS.reduce(function(s,p){return s+(Number((c.omni&&c.omni[p]&&c.omni[p][m])||0));},0); }
function getClientComm(c,m){ var r=getRates(); return (getClientProgTotal(c,m)*r.pm*r.pc)+(getClientOmniTotal(c,m)*r.om*r.oc); }
function getMonthTotal(m){ return budgetClients.reduce(function(s,c){return s+getClientProgTotal(c,m)+getClientOmniTotal(c,m);},0); }
function getMonthComm(m){ return budgetClients.reduce(function(s,c){return s+getClientComm(c,m);},0); }

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function nav(page){
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.ni').forEach(function(n){n.classList.remove('active');});
  var pg=document.getElementById('page-'+page);
  if(!pg){ console.error('No page found: page-'+page); return; }
  pg.classList.add('active');
  document.querySelectorAll('.ni').forEach(function(n){
    var oc=n.getAttribute('onclick')||'';
    if(oc.indexOf("'"+page+"'")!==-1) n.classList.add('active');
  });
  var renders={pipeline:renderPipe,contacts:renderContacts,agencies:renderAgencies,todos:renderTodos,reports:renderReports,digest:renderDigest,budget:renderBudget,settings:renderSettings,prospects:function(){},integrations:initIntegrations,proposal:initProposal,kb:initKB,accounts:initAccounts};
  if(renders[page]) renders[page]();
}

// ‚îÄ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick(){
  var n=new Date();
  document.getElementById('clock').textContent=n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('clock-sub').textContent=n.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  var dd=document.getElementById('d-date');
  if(dd) dd.textContent=n.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}

// ‚îÄ‚îÄ‚îÄ REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function refreshAll(){ renderDigest(); renderPipe(); renderContacts(); renderAgencies(); renderTodos(); renderReports(); renderBudget(); updateBadges(); populateEmailContacts(); }
function updateBadges(){
  var o=todos.filter(function(t){return !t.done;}).length;
  var nb=document.getElementById('nb-td');
  nb.textContent=o; nb.style.display=o?'':'none';
  var st=document.getElementById('ds-todos'); if(st) st.textContent=o;
}

// ‚îÄ‚îÄ‚îÄ DIGEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDigest(){
  var ct=getColdThreshold();
  var active=contacts.filter(function(c){return !['Closed Won','Closed Lost','Active Client','Agency Partner'].includes(c.stage);});
  var props=contacts.filter(function(c){return ['Proposal Sent','Proposal Revision'].includes(c.stage);});
  var cold=contacts.filter(function(c){return daysSince(c.lastContact)>=ct && !['Closed Won','Closed Lost'].includes(c.stage);});
  document.getElementById('ds-active').textContent=active.length;
  document.getElementById('ds-prop').textContent=props.length;
  document.getElementById('ds-cold').textContent=cold.length;

  var mt=getMonthTotal(CURM); var mc=getMonthComm(CURM);
  var annual=0; var annualComm=0;
  for(var m=0;m<12;m++){annual+=getMonthTotal(m);annualComm+=getMonthComm(m);}
  var bonusEl=document.getElementById('bonus-input');
  var bonus=(bonusEl&&bonusEl.value)?parseFloat(bonusEl.value)||2000:2000;
  var mlEl=document.getElementById('d-month-label'); if(mlEl) mlEl.textContent=MONTHS[CURM];
  var mtEl=document.getElementById('ds-month-total'); if(mtEl) mtEl.textContent=fmtM(mt);
  var mcEl=document.getElementById('ds-month-comm'); if(mcEl) mcEl.textContent=fmtM(mc);
  var aEl=document.getElementById('ds-annual'); if(aEl) aEl.textContent=fmtM(annual);
  var acEl=document.getElementById('ds-annual-comm'); if(acEl) acEl.textContent=fmtM(annualComm+bonus);

  var orderMap={'At the Table':0,'Proposal Sent':1,'Proposal Revision':2,'Follow-Up Scheduled':3};
  var pri=contacts.filter(function(c){return ['At the Table','Proposal Sent','Follow-Up Scheduled','Proposal Revision'].includes(c.stage);})
    .sort(function(a,b){return (orderMap[a.stage]!=null?orderMap[a.stage]:9)-(orderMap[b.stage]!=null?orderMap[b.stage]:9);}).slice(0,5);

  var priEl=document.getElementById('dg-pri');
  priEl.innerHTML=pri.length?pri.map(function(c,i){
    var actClass=c.stage==='At the Table'?'pa-call':c.stage.indexOf('Proposal')!==-1?'pa-prop':'pa-fu';
    var actLabel=c.stage==='At the Table'?'CALL':'ACTION';
    var ds=daysSince(c.lastContact)===0?'today':daysSince(c.lastContact)+'d ago';
    return '<div class="pri" onclick="openDetail(\''+c.id+'\')" style="cursor:pointer"><div class="pri-n">'+String(i+1).padStart(2,'0')+'</div><div class="pri-info"><div class="pri-name">'+c.firstName+' '+c.lastName+' ‚Äî '+c.company+'</div><div class="pri-reason">'+c.stage+' ¬∑ '+ds+'</div></div><div class="pri-act '+actClass+'">'+actLabel+'</div></div>';
  }).join(''):'<div class="empty">No urgent contacts</div>';

  var coldEl=document.getElementById('dg-cold');
  coldEl.innerHTML=cold.length?cold.slice(0,5).map(function(c,i){
    return '<div class="pri" onclick="openDetail(\''+c.id+'\')" style="cursor:pointer"><div class="pri-n">'+String(i+1).padStart(2,'0')+'</div><div class="pri-info"><div class="pri-name">'+c.firstName+' '+c.lastName+' ‚Äî '+c.company+'</div><div class="pri-reason">'+c.stage+' ¬∑ '+daysSince(c.lastContact)+'d silent</div></div><div class="pri-act pa-call">RE-ENGAGE</div></div>';
  }).join(''):'<div class="empty">No cold leads</div>';

  var ot=todos.filter(function(t){return !t.done;}).slice(0,4);
  var tdEl=document.getElementById('dg-td');
  tdEl.innerHTML=ot.length?ot.map(function(t){
    return '<div class="todo-item"><div class="tcb '+(t.done?'checked':'')+'" onclick="toggleTodo(\''+t.id+'\')"></div><div><div class="ttxt">'+t.text+'</div><div class="tmeta"><span class="ttag '+(t.auto?'tt-auto':'tt-man')+'">'+t.type.toUpperCase()+'</span></div></div></div>';
  }).join(''):'<div class="empty">All caught up</div>';
  updateBadges();
}

// ‚îÄ‚îÄ‚îÄ TODOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTodos(){
  var data=todos;
  if(tdFilter==='open') data=todos.filter(function(t){return !t.done;});
  else if(tdFilter==='auto') data=todos.filter(function(t){return t.auto&&!t.done;});
  else if(tdFilter==='manual') data=todos.filter(function(t){return !t.auto&&!t.done;});
  else if(tdFilter==='done') data=todos.filter(function(t){return t.done;});
  var el=document.getElementById('td-list');
  el.innerHTML=data.length?data.map(function(t){
    var lk=t.contactId?contacts.find(function(c){return c.id===t.contactId;}):null;
    return '<div class="todo-item"><div class="tcb '+(t.done?'checked':'')+'" onclick="toggleTodo(\''+t.id+'\')"></div><div style="flex:1"><div class="ttxt '+(t.done?'done':'')+'" >'+t.text+'</div><div class="tmeta"><span class="ttag '+(t.auto?'tt-auto':'tt-man')+'">'+t.type.toUpperCase()+'</span>'+(lk?' ¬∑ '+lk.firstName+' '+lk.lastName:'')+(t.due?' ¬∑ due '+fmtDate(t.due+'T00:00:00'):'')+'</div></div><div style="display:flex;gap:4px">'+(t.done?'':'<button class="btn btn-sm" onclick="toggleTodo(\''+t.id+'\')">‚úì</button>')+'<button class="btn btn-sm btn-danger" onclick="deleteTodo(\''+t.id+'\')">‚úï</button></div></div>';
  }).join(''):'<div class="empty">Nothing here</div>';
  updateBadges();
}
function filtTd(v,el){ tdFilter=v; document.querySelectorAll('#td-filters .filt').forEach(function(b){b.classList.remove('active');}); el.classList.add('active'); renderTodos(); }
function toggleTodo(id){ var t=todos.find(function(x){return x.id===id;}); if(t){t.done=!t.done; saveAll(); renderTodos(); renderDigest();} }
function deleteTodo(id){ todos=todos.filter(function(t){return t.id!==id;}); saveAll(); renderTodos(); updateBadges(); }
function openAddTodo(){
  var sel=document.getElementById('td-lnk');
  sel.innerHTML='<option value="">None</option>'+contacts.map(function(c){return '<option value="'+c.id+'">'+c.firstName+' '+c.lastName+' ‚Äî '+c.company+'</option>';}).join('');
  document.getElementById('td-text').value=''; document.getElementById('td-due').value='';
  openM('m-todo');
}
function saveTodo(){
  var t=document.getElementById('td-text').value.trim();
  if(!t){toast('Task required','err');return;}
  todos.unshift({id:uid(),text:t,done:false,auto:false,type:'manual',contactId:document.getElementById('td-lnk').value,due:document.getElementById('td-due').value,priority:document.getElementById('td-pri').value,createdAt:new Date().toISOString()});
  saveAll(); closeM('m-todo'); renderTodos(); updateBadges(); toast('Added','ok');
}
function runAutoTodos(){
  var added=0; var ct=getColdThreshold(); var pt=getPropThreshold();
  contacts.filter(function(c){return daysSince(c.lastContact)>=ct&&!['Closed Won','Closed Lost'].includes(c.stage);}).forEach(function(c){
    if(!todos.find(function(t){return t.contactId===c.id&&t.type==='cold'&&!t.done;})){
      todos.unshift({id:uid(),text:'Re-engage '+c.firstName+' '+c.lastName+' ('+c.company+') ‚Äî '+daysSince(c.lastContact)+'d cold',done:false,auto:true,type:'cold',contactId:c.id,due:'',priority:'high',createdAt:new Date().toISOString()}); added++;
    }
  });
  contacts.filter(function(c){return c.stage==='Proposal Sent'&&daysSince(c.lastContact)>=pt;}).forEach(function(c){
    if(!todos.find(function(t){return t.contactId===c.id&&t.type==='proposal'&&!t.done;})){
      todos.unshift({id:uid(),text:'Follow up on proposal ‚Äî '+c.firstName+' '+c.lastName+' ('+c.company+'), '+daysSince(c.lastContact)+'d ago',done:false,auto:true,type:'proposal',contactId:c.id,due:'',priority:'high',createdAt:new Date().toISOString()}); added++;
    }
  });
  saveAll(); renderTodos(); updateBadges(); toast(added?added+' new auto to-dos':'All up to date','ok');
}

// ‚îÄ‚îÄ‚îÄ PIPELINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filtPipe(v,el){ pipeFilter=v; document.querySelectorAll('#pf .filt').forEach(function(b){b.classList.remove('active');}); el.classList.add('active'); renderPipe(); }
function renderPipe(){
  var qEl=document.getElementById('pq'); var q=(qEl&&qEl.value)?qEl.value.toLowerCase():'';
  var ct=getColdThreshold();
  var data=pipeFilter==='all'?contacts.filter(function(c){return c.stage!=='Agency Partner';}):contacts.filter(function(c){return c.stage===pipeFilter;});
  if(q) data=data.filter(function(c){return (c.firstName+' '+c.lastName+' '+c.company+' '+(c.vertical||'')).toLowerCase().indexOf(q)!==-1;});
  var tb=document.getElementById('pipe-tb');
  tb.innerHTML=data.length?data.map(function(c){
    var isCold=daysSince(c.lastContact)>=ct&&!['Closed Won','Closed Lost'].includes(c.stage);
    return '<tr onclick="openDetail(\''+c.id+'\')" style="cursor:pointer"><td><div style="color:var(--white)">'+c.firstName+' '+c.lastName+'</div><div style="font-size:.7rem;color:var(--t2)">'+c.company+'</div></td><td style="color:var(--t2)">'+(c.vertical||'‚Äî')+'</td><td>'+badge(c.stage)+'</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">'+fmtDate(c.lastContact)+'</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">'+(c.followUp?fmtDate(c.followUp+'T00:00:00'):'‚Äî')+'</td><td>'+(isCold?coldF():'<span style="font-family:var(--mono);font-size:.58rem;color:var(--t3)">OK</span>')+'</td></tr>';
  }).join(''):'<tr><td colspan="6" style="text-align:center;color:var(--t3);font-family:var(--mono);font-size:.7rem;padding:24px">No contacts</td></tr>';
}

// ‚îÄ‚îÄ‚îÄ CONTACTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderContacts(){
  var qEl=document.getElementById('cq'); var q=(qEl&&qEl.value)?qEl.value.toLowerCase():'';
  var data=q?contacts.filter(function(c){return (c.firstName+' '+c.lastName+' '+c.company+' '+(c.stage||'')).toLowerCase().indexOf(q)!==-1;}):contacts;
  var countEl=document.getElementById('contacts-count'); if(countEl) countEl.textContent=data.length+' contacts';
  document.getElementById('con-tb').innerHTML=data.length?data.map(function(c){
    var missing=(!c.phone||!c.email);
    return '<tr><td style="color:var(--white)">'+c.firstName+' '+c.lastName+'</td><td style="color:var(--t2)">'+c.company+'</td><td style="font-family:var(--mono);font-size:.7rem;color:var(--t2)">'+(c.phone||'<span style="color:var(--red);font-size:.65rem;">missing</span>')+'</td><td style="font-size:.73rem;color:var(--t2)">'+(c.email||'<span style="color:var(--red);font-size:.65rem;">missing</span>')+'</td><td style="color:var(--t2)">'+(c.vertical||'‚Äî')+'</td><td>'+badge(c.stage)+'</td><td><div style="display:flex;gap:4px"><button class="btn btn-sm" onclick="openDetail(\''+c.id+'\')">View</button><button class="btn btn-sm" onclick="openLog(\''+c.id+'\')">Log</button>'+(missing?'<button class="btn btn-sm" style="border-color:var(--yellow);color:var(--yellow);" onclick="openEnrich(\''+c.id+'\')">‚ú¶</button>':'')+'<button class="btn btn-sm btn-danger" onclick="deleteContactInline(\''+c.id+'\')">‚úï</button></div></td></tr>';
  }).join(''):'<tr><td colspan="7" style="text-align:center;color:var(--t3);font-family:var(--mono);font-size:.7rem;padding:24px">No contacts</td></tr>';
}

// ‚îÄ‚îÄ‚îÄ CONTACT CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddContact(ds){
  editCId=null;
  document.getElementById('mc-title').textContent='Add Contact';
  ['cf-fn','cf-ln','cf-co','cf-ph','cf-em','cf-bg','cf-no'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('cf-vt').value=''; document.getElementById('cf-st').value=ds||'Cold';
  document.getElementById('cf-src').value=''; document.getElementById('cf-fu').value=''; document.getElementById('cf-id').value='';
  openM('m-contact');
}
function openEdit(id){
  var c=contacts.find(function(x){return x.id===id;}); if(!c)return;
  editCId=id; document.getElementById('mc-title').textContent='Edit Contact';
  document.getElementById('cf-fn').value=c.firstName; document.getElementById('cf-ln').value=c.lastName;
  document.getElementById('cf-co').value=c.company; document.getElementById('cf-ph').value=c.phone||'';
  document.getElementById('cf-em').value=c.email||''; document.getElementById('cf-vt').value=c.vertical||'';
  document.getElementById('cf-st').value=c.stage; document.getElementById('cf-bg').value=c.budget||'';
  document.getElementById('cf-fu').value=c.followUp||''; document.getElementById('cf-no').value=c.notes||'';
  document.getElementById('cf-src').value=c.source||''; document.getElementById('cf-id').value=id;
  openM('m-contact');
}
function saveContact(){
  var fn=document.getElementById('cf-fn').value.trim(); var co=document.getElementById('cf-co').value.trim();
  if(!fn||!co){toast('Name and company required','err');return;}
  var id=editCId||uid(); var ex=contacts.find(function(c){return c.id===id;});
  var c={id:id,firstName:fn,lastName:document.getElementById('cf-ln').value.trim(),company:co,phone:document.getElementById('cf-ph').value,email:document.getElementById('cf-em').value,vertical:document.getElementById('cf-vt').value,stage:document.getElementById('cf-st').value,budget:document.getElementById('cf-bg').value,followUp:document.getElementById('cf-fu').value,notes:document.getElementById('cf-no').value,source:document.getElementById('cf-src').value,lastContact:ex?ex.lastContact:new Date().toISOString(),createdAt:ex?ex.createdAt:new Date().toISOString(),callLog:ex?ex.callLog:[]};
  if(editCId){var i=contacts.findIndex(function(x){return x.id===editCId;}); contacts[i]=c;} else contacts.unshift(c);
  saveAll(); closeM('m-contact'); refreshAll(); toast(editCId?'Updated':'Added','ok');
}
function deleteContact(id){
  if(!confirm('Delete this contact?'))return;
  contacts=contacts.filter(function(c){return c.id!==id;}); saveAll(); closeM('m-detail'); refreshAll(); toast('Deleted','err');
}
function deleteContactInline(id){
  if(!confirm('Delete this contact?'))return;
  contacts=contacts.filter(function(c){return c.id!==id;}); saveAll(); refreshAll(); toast('Deleted','err');
}
function openDetail(id){
  var c=contacts.find(function(x){return x.id===id;}); if(!c)return;
  var ct=getColdThreshold(); var isCold=daysSince(c.lastContact)>=ct;
  document.getElementById('md-title').textContent=c.firstName+' '+c.lastName+' ‚Äî '+c.company;
  var fields=[['Phone',c.phone||'‚Äî'],['Email',c.email||'‚Äî'],['Budget',c.budget||'‚Äî'],['Source',c.source||'‚Äî'],['Last Contact',fmtDate(c.lastContact)+(c.lastContact?' ('+daysSince(c.lastContact)+'d ago)':'')],['Follow-Up',c.followUp?fmtDate(c.followUp+'T00:00:00'):'‚Äî']];
  var fieldHtml=fields.map(function(f){return '<div><div style="font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px">'+f[0]+'</div><div style="font-family:var(--mono);font-size:.72rem">'+f[1]+'</div></div>';}).join('');
  var logHtml=''; if(c.callLog&&c.callLog.length){logHtml='<div><div style="font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Call Log ('+c.callLog.length+')</div>'+c.callLog.slice().reverse().map(function(n){return '<div style="background:var(--s2);border:1px solid var(--b);border-radius:3px;padding:8px 10px;margin-bottom:6px"><div style="font-family:var(--mono);font-size:.58rem;color:var(--t3);margin-bottom:3px">'+new Date(n.date).toLocaleString()+(n.stageChange?' ¬∑ '+n.stageChange:'')+'</div><div style="font-size:.77rem;color:var(--t2);line-height:1.5">'+n.text+'</div></div>';}).join('')+'</div>';}
  document.getElementById('md-body').innerHTML='<div style="margin-bottom:14px"><div style="font-size:1rem;color:var(--white);font-weight:500">'+c.firstName+' '+c.lastName+'</div><div style="color:var(--t2);margin-top:2px">'+c.company+(c.vertical?' ¬∑ '+c.vertical:'')+'</div><div style="margin-top:7px;display:flex;gap:5px;flex-wrap:wrap">'+badge(c.stage)+(isCold?coldF():'')+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">'+fieldHtml+'</div>'+(c.notes?'<div style="margin-bottom:12px"><div style="font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Notes</div><div style="font-size:.77rem;color:var(--t2);background:var(--s2);padding:9px;border-radius:3px;border:1px solid var(--b);line-height:1.6">'+c.notes+'</div></div>':'')+logHtml;
  document.getElementById('md-foot').innerHTML='<button class="btn btn-danger" onclick="deleteContact(\''+id+'\')">Delete</button><button class="btn" onclick="closeM(\'m-detail\');openLog(\''+id+'\')">Log Call</button><button class="btn btn-w" onclick="closeM(\'m-detail\');openEdit(\''+id+'\')">Edit</button>';
  openM('m-detail');
}

// ‚îÄ‚îÄ‚îÄ LOG CALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLog(id){
  var c=contacts.find(function(x){return x.id===id;}); if(!c)return;
  document.getElementById('lg-name').value=c.firstName+' '+c.lastName+' ‚Äî '+c.company;
  document.getElementById('lg-id').value=id;
  ['lg-st','lg-no','lg-fu'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('lg-ai').style.display='none';
  openM('m-log');
}
function saveLog(){
  var id=document.getElementById('lg-id').value;
  var notes=document.getElementById('lg-no').value.trim();
  var stage=document.getElementById('lg-st').value;
  var fu=document.getElementById('lg-fu').value;
  var i=contacts.findIndex(function(c){return c.id===id;}); if(i===-1)return;
  if(notes){ if(!contacts[i].callLog) contacts[i].callLog=[]; contacts[i].callLog.push({date:new Date().toISOString(),text:notes,stageChange:stage||null}); }
  contacts[i].lastContact=new Date().toISOString();
  if(stage) contacts[i].stage=stage;
  if(fu) contacts[i].followUp=fu;
  todos.filter(function(t){return t.contactId===id&&t.type==='cold'&&!t.done;}).forEach(function(t){t.done=true;});
  saveAll(); closeM('m-log'); refreshAll(); toast('Logged','ok');
}
function genFollowUp(){
  var id=document.getElementById('lg-id').value;
  var notes=document.getElementById('lg-no').value.trim();
  var c=contacts.find(function(x){return x.id===id;});
  if(!c||!notes){toast('Add notes first','err');return;}
  var box=document.getElementById('lg-ai'); var out=document.getElementById('lg-ai-out');
  box.style.display='block'; out.innerHTML='Drafting...<span class="tcursor"></span>';
  fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:600,messages:[{role:"user",content:"Sales assistant for Simpli.fi Director, East Tennessee. Write a short professional follow-up email.\n\nContact: "+c.firstName+" "+c.lastName+", "+c.company+" ("+(c.vertical||'local business')+")\nStage: "+c.stage+"\nNotes: "+notes+"\n\nSubject + body. Under 120 words. Warm, specific, not salesy."}]})})
  .then(function(r){return r.json();})
  .then(function(d){out.innerHTML=(d.content||[]).map(function(x){return x.text||'';}).join('').replace(/\n/g,'<br>');})
  .catch(function(){out.innerHTML='AI unavailable ‚Äî note your talking points above and write manually.';});
}

// ‚îÄ‚îÄ‚îÄ AGENCIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAgencies(){
  var active=agencies.filter(function(a){return a.stage==='Agency Partner';}).length;
  var children=agencies.reduce(function(s,a){return s+(a.children?a.children.length:0);},0);
  var pitching=agencies.filter(function(a){return a.stage!=='Agency Partner';}).length;
  document.getElementById('ags1').textContent=active;
  document.getElementById('ags2').textContent=children;
  document.getElementById('ags3').textContent=pitching;
  var tree=document.getElementById('ag-tree');
  if(!agencies.length){tree.innerHTML='<div class="empty">No agencies yet</div>';return;}
  tree.innerHTML=agencies.map(function(a){
    var childRows=(a.children||[]).length?(a.children.map(function(ch){
      return '<div class="acr"><div class="acc"></div><div style="flex:1"><div style="color:var(--white)">'+ch.name+'</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">'+(ch.contact||'‚Äî')+' ¬∑ '+(ch.vertical||'‚Äî')+' ¬∑ '+(ch.budget||'‚Äî')+'</div></div><div style="display:flex;gap:4px;align-items:center"><span class="badge s-active"><span class="bdot" style="background:currentColor;opacity:.6"></span>Active</span><button class="btn btn-sm" onclick="openEditCh(\''+a.id+'\',\''+ch.id+'\')">Edit</button><button class="btn btn-sm btn-danger" onclick="delCh(\''+a.id+'\',\''+ch.id+'\')">‚úï</button></div></div>';
    }).join('')):'<div style="padding:10px 14px 10px 24px;font-family:var(--mono);font-size:.63rem;color:var(--t3)">No clients yet.</div>';
    return '<div class="ab"><div class="ar" onclick="toggleAg(\''+a.id+'\')"><div style="flex:1"><div style="color:var(--white);font-weight:500">'+a.name+'</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2);margin-top:1px">'+(a.contact||'')+(a.phone?' ¬∑ '+a.phone:'')+' ¬∑ Last: '+fmtDate(a.lastContact)+(a.budget?' ¬∑ '+a.budget:'')+'</div></div><div style="display:flex;align-items:center;gap:6px">'+badge(a.stage)+'<span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">'+(a.children?a.children.length:0)+' clients</span><button class="btn btn-sm" onclick="event.stopPropagation();openAddChild(\''+a.id+'\')">+ Client</button><button class="btn btn-sm" onclick="event.stopPropagation();openEditAg(\''+a.id+'\')">Edit</button><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteAgency(\''+a.id+'\')">‚úï</button><span class="chev" id="chev-'+a.id+'">‚ñ∂</span></div></div><div class="ach" id="ach-'+a.id+'" style="display:none">'+childRows+'</div></div>';
  }).join('');
}
function toggleAg(id){ var el=document.getElementById('ach-'+id); var chev=document.getElementById('chev-'+id); var open=el.style.display==='none'||el.style.display===''; el.style.display=open?'block':'none'; chev.classList.toggle('open',open); }
function openAddAgency(){ editAId=null; document.getElementById('ma-title').textContent='Add Agency'; ['ag-nm','ag-ct','ag-ph','ag-em','ag-bg','ag-no'].forEach(function(id){document.getElementById(id).value='';}); document.getElementById('ag-st').value='Agency Partner'; document.getElementById('ag-id').value=''; openM('m-agency'); }
function openEditAg(id){ var a=agencies.find(function(x){return x.id===id;}); if(!a)return; editAId=id; document.getElementById('ma-title').textContent='Edit Agency'; document.getElementById('ag-nm').value=a.name; document.getElementById('ag-ct').value=a.contact||''; document.getElementById('ag-ph').value=a.phone||''; document.getElementById('ag-em').value=a.email||''; document.getElementById('ag-st').value=a.stage; document.getElementById('ag-bg').value=a.budget||''; document.getElementById('ag-no').value=a.notes||''; document.getElementById('ag-id').value=id; openM('m-agency'); }
function saveAgency(){ var name=document.getElementById('ag-nm').value.trim(); if(!name){toast('Name required','err');return;} var id=editAId||uid(); var ex=agencies.find(function(a){return a.id===id;}); var ag={id:id,name:name,contact:document.getElementById('ag-ct').value,phone:document.getElementById('ag-ph').value,email:document.getElementById('ag-em').value,stage:document.getElementById('ag-st').value,budget:document.getElementById('ag-bg').value,notes:document.getElementById('ag-no').value,lastContact:ex?ex.lastContact:new Date().toISOString(),createdAt:ex?ex.createdAt:new Date().toISOString(),children:ex?ex.children:[]}; if(editAId){var i=agencies.findIndex(function(a){return a.id===editAId;});agencies[i]=ag;}else agencies.unshift(ag); saveAll(); closeM('m-agency'); renderAgencies(); toast(editAId?'Updated':'Added','ok'); }
function openAddChild(pid){ editChId=null; document.getElementById('mch-title').textContent='Add Client'; ['ch-nm','ch-ct','ch-ph','ch-em','ch-bg','ch-no','ch-re'].forEach(function(id){document.getElementById(id).value='';}); document.getElementById('ch-vt').value=''; document.getElementById('ch-par').value=pid; document.getElementById('ch-id').value=''; openM('m-child'); }
function openEditCh(pid,cid){ var a=agencies.find(function(x){return x.id===pid;}); if(!a)return; var ch=a.children.find(function(x){return x.id===cid;}); if(!ch)return; editChId=cid; document.getElementById('mch-title').textContent='Edit Client'; document.getElementById('ch-nm').value=ch.name; document.getElementById('ch-ct').value=ch.contact||''; document.getElementById('ch-ph').value=ch.phone||''; document.getElementById('ch-em').value=ch.email||''; document.getElementById('ch-vt').value=ch.vertical||''; document.getElementById('ch-bg').value=ch.budget||''; document.getElementById('ch-no').value=ch.notes||''; document.getElementById('ch-re').value=ch.reportEmail||''; document.getElementById('ch-par').value=pid; document.getElementById('ch-id').value=cid; openM('m-child'); }
function saveChild(){ var name=document.getElementById('ch-nm').value.trim(); if(!name){toast('Name required','err');return;} var pid=document.getElementById('ch-par').value; var a=agencies.find(function(x){return x.id===pid;}); if(!a)return; var id=editChId||uid(); var ch={id:id,name:name,contact:document.getElementById('ch-ct').value,phone:document.getElementById('ch-ph').value,email:document.getElementById('ch-em').value,vertical:document.getElementById('ch-vt').value,budget:document.getElementById('ch-bg').value,notes:document.getElementById('ch-no').value,reportEmail:document.getElementById('ch-re').value,campaignStatus:'Active'}; if(editChId){var i=a.children.findIndex(function(x){return x.id===editChId;});a.children[i]=ch;}else a.children.push(ch); saveAll(); closeM('m-child'); renderAgencies(); toast(editChId?'Updated':'Added','ok'); }
function delCh(pid,cid){ if(!confirm('Remove?'))return; var a=agencies.find(function(x){return x.id===pid;}); if(!a)return; a.children=a.children.filter(function(x){return x.id!==cid;}); saveAll(); renderAgencies(); toast('Removed','err'); }
function deleteAgency(id){ if(!confirm('Delete this agency and all its child clients?'))return; agencies=agencies.filter(function(x){return x.id!==id;}); saveAll(); renderAgencies(); toast('Agency deleted','err'); }

// ‚îÄ‚îÄ‚îÄ BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBudget(){
  document.getElementById('prog-tags').innerHTML=PROG_PRODUCTS.map(function(p){return '<span class="prod-tag pt-prog">'+p+'</span>';}).join('');
  document.getElementById('omni-tags').innerHTML=OMNI_PRODUCTS.map(function(p){return '<span class="prod-tag pt-omni">'+p+'</span>';}).join('');
  document.getElementById('budget-tabs').innerHTML=MONTHS.map(function(m,i){return '<div class="mtab '+(i===budgetM?'active':'')+'" onclick="switchBudgetMonth('+i+')">'+m.slice(0,3)+'</div>';}).join('');
  var annual=0; var ytd=0; var annualComm=0; var pending=0;
  for(var m=0;m<12;m++){var mt=getMonthTotal(m);annual+=mt;if(m<=CURM)ytd+=mt;annualComm+=getMonthComm(m);}
  pending=budgetClients.filter(function(c){return c.status==='pending';}).reduce(function(s,c){for(var m=0;m<12;m++)s+=getClientProgTotal(c,m)+getClientOmniTotal(c,m);return s;},0);
  var bonusEl=document.getElementById('bonus-input'); var bonus=(bonusEl&&bonusEl.value)?parseFloat(bonusEl.value)||2000:2000;
  document.getElementById('b-annual').textContent=fmtM(annual);
  document.getElementById('b-ytd').textContent=fmtM(ytd);
  document.getElementById('b-comm').textContent=fmtM(annualComm+bonus);
  document.getElementById('b-pending').textContent=fmtM(pending);
  document.getElementById('b-bonus').textContent=fmtM(bonus);
  renderMonthBudget(); renderCommBreakdown(); renderAnnualProj();
  var cml=document.getElementById('comm-month-label'); if(cml) cml.textContent=MONTHS[budgetM];
}
function switchBudgetMonth(m){ budgetM=m; renderBudget(); }
function renderMonthBudget(){
  var m=budgetM; var r=getRates();

  function buildHeader(includePct){
    var h='<thead><tr><th class="left" style="min-width:200px;position:sticky;left:0;background:var(--s2);">Client</th><th class="left">Status</th>';
    if(includePct) h+='<th class="left" style="color:var(--yellow);">Close %</th><th style="color:var(--yellow);">Weighted</th>';
    PROG_PRODUCTS.forEach(function(p){h+='<th class="group-prog">'+p+'</th>';});
    h+='<th class="group-prog">Prog Total</th>';
    OMNI_PRODUCTS.forEach(function(p){h+='<th class="group-omni">'+p+'</th>';});
    h+='<th class="group-omni">Omni Total</th><th class="group-total">Grand Total</th><th class="group-total">Margin</th><th class="group-total">Commission</th></tr></thead>';
    return h;
  }

  // Build a single combined table with all active/paused clients
  // Agency parents show ONLY their children's rollup ‚Äî no own spend
  // Children are hidden rows revealed on click
  // Direct brands show own spend
  function buildMainTable(clients, includePct){
    var html=''; var totProg=0; var totOmni=0; var totMargin=0; var totComm=0; var totWeighted=0;
    var progColTotals={}; var omniColTotals={};
    PROG_PRODUCTS.forEach(function(p){progColTotals[p]=0;});
    OMNI_PRODUCTS.forEach(function(p){omniColTotals[p]=0;});

    clients.forEach(function(c){
      var sc=c.status==='active'?'sc-active':c.status==='pending'?'sc-pending':'sc-paused';
      var isAgency=(c.type==='agency');
      var children=isAgency?budgetClients.filter(function(x){return x.agencyParent===c.id;}):[];

      // Calculate totals ‚Äî agency = sum of children only; brand = own spend
      var rowProg=0; var rowOmni=0;
      var perProdProg={}; var perProdOmni={};
      PROG_PRODUCTS.forEach(function(p){perProdProg[p]=0;});
      OMNI_PRODUCTS.forEach(function(p){perProdOmni[p]=0;});

      if(isAgency){
        children.forEach(function(ch){
          PROG_PRODUCTS.forEach(function(p){var v=Number((ch.prog&&ch.prog[p]&&ch.prog[p][m])||0);perProdProg[p]+=v;rowProg+=v;progColTotals[p]+=v;});
          OMNI_PRODUCTS.forEach(function(p){var v=Number((ch.omni&&ch.omni[p]&&ch.omni[p][m])||0);perProdOmni[p]+=v;rowOmni+=v;omniColTotals[p]+=v;});
        });
      } else {
        PROG_PRODUCTS.forEach(function(p){var v=Number((c.prog&&c.prog[p]&&c.prog[p][m])||0);perProdProg[p]+=v;rowProg+=v;progColTotals[p]+=v;});
        OMNI_PRODUCTS.forEach(function(p){var v=Number((c.omni&&c.omni[p]&&c.omni[p][m])||0);perProdOmni[p]+=v;rowOmni+=v;omniColTotals[p]+=v;});
      }

      var grand=rowProg+rowOmni;
      var margin=(rowProg*r.pm)+(rowOmni*r.om);
      var comm=(rowProg*r.pm*r.pc)+(rowOmni*r.om*r.oc);
      totProg+=rowProg; totOmni+=rowOmni; totMargin+=margin; totComm+=comm;
      if(includePct){totWeighted+=grand*(Number(c.closePct||50)/100);}

      // ‚îÄ‚îÄ PARENT / BRAND ROW ‚îÄ‚îÄ
      var rowBg=isAgency?'background:var(--s2);':'';
      var nameFw=isAgency?'font-weight:600;':'';
      html+='<tr>';
      html+='<td class="left" style="position:sticky;left:0;'+rowBg+nameFw+'">';
      if(isAgency){
        html+='<span id="bgchev-'+c.id+'" onclick="toggleBudgetGroup(\''+c.id+'\')" style="cursor:pointer;margin-right:6px;font-size:.8rem;display:inline-block;width:14px;">‚ñ∂</span>';
        html+='<span style="color:var(--blue);">'+escH(c.name)+'</span>';
        if(children.length) html+='<span style="font-family:var(--mono);font-size:.6rem;color:var(--t3);margin-left:6px;">'+children.length+' clients</span>';
      } else {
        html+='<span style="display:inline-block;width:20px;"></span>';
        html+='<span style="color:var(--white);">'+escH(c.name)+'</span>';
      }
      html+=' <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(\''+c.id+'\')">‚úé</button>';
      html+=' <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(\''+c.id+'\')">‚úï</button>';
      html+='</td>';
      html+='<td class="left"><span class="status-chip '+sc+'">'+c.status+'</span></td>';

      if(includePct){
        var pct=Number(c.closePct||50);
        html+='<td><input class="bi" style="width:50px;color:var(--yellow);" value="'+pct+'" onchange="updateClosePct(\''+c.id+'\',this.value)">%</td>';
        html+='<td style="color:var(--yellow);">'+(grand?fmtM(grand*(pct/100)):'‚Äî')+'</td>';
      }

      // Tactic columns ‚Äî agency shows rollup totals (read-only), brand shows editable inputs
      if(isAgency){
        PROG_PRODUCTS.forEach(function(p){html+='<td style="color:var(--green);font-weight:500;">'+(perProdProg[p]?fmtM(perProdProg[p]):'‚Äî')+'</td>';});
        html+='<td style="color:var(--green);font-weight:700;">'+(rowProg?fmtM(rowProg):'‚Äî')+'</td>';
        OMNI_PRODUCTS.forEach(function(p){html+='<td style="color:var(--blue);font-weight:500;">'+(perProdOmni[p]?fmtM(perProdOmni[p]):'‚Äî')+'</td>';});
        html+='<td style="color:var(--blue);font-weight:700;">'+(rowOmni?fmtM(rowOmni):'‚Äî')+'</td>';
      } else {
        PROG_PRODUCTS.forEach(function(p){var val=Number((c.prog&&c.prog[p]&&c.prog[p][m])||0);html+='<td><input class="bi" value="'+(val||'')+'" placeholder="‚Äî" onchange="updateBudgetCell(\''+c.id+'\',\'prog\',\''+p+'\','+m+',this.value)"></td>';});
        html+='<td style="color:var(--green);font-weight:500;">'+(rowProg?fmtM(rowProg):'‚Äî')+'</td>';
        OMNI_PRODUCTS.forEach(function(p){var val=Number((c.omni&&c.omni[p]&&c.omni[p][m])||0);html+='<td><input class="bi" value="'+(val||'')+'" placeholder="‚Äî" onchange="updateBudgetCell(\''+c.id+'\',\'omni\',\''+p+'\','+m+',this.value)"></td>';});
        html+='<td style="color:var(--blue);font-weight:500;">'+(rowOmni?fmtM(rowOmni):'‚Äî')+'</td>';
      }
      html+='<td style="color:var(--yellow);font-weight:'+(isAgency?'700':'500')+'">'+(grand?fmtM(grand):'‚Äî')+'</td>';
      html+='<td style="color:var(--t2);">'+(margin?fmtM(margin):'‚Äî')+'</td>';
      html+='<td style="color:var(--green);">'+(comm?'$'+comm.toFixed(0):'‚Äî')+'</td>';
      html+='</tr>';

      // ‚îÄ‚îÄ CHILD ROWS (hidden until expanded) ‚îÄ‚îÄ
      if(isAgency){
        children.forEach(function(ch){
          var sc2=ch.status==='active'?'sc-active':ch.status==='pending'?'sc-pending':'sc-paused';
          var crp=getClientProgTotal(ch,m); var cro=getClientOmniTotal(ch,m); var cgrand=crp+cro;
          var cm2=(crp*r.pm)+(cro*r.om); var cc2=(crp*r.pm*r.pc)+(cro*r.om*r.oc);
          html+='<tr class="budget-child-'+c.id+'" style="display:none;">';
          html+='<td class="left" style="position:sticky;left:0;background:var(--surface);">';
          html+='<span style="display:inline-block;width:20px;"></span>';
          html+='<span style="color:var(--t3);margin-right:5px;">‚îî</span>';
          html+='<span style="color:var(--t2);">'+escH(ch.name)+'</span>';
          html+=' <button class="btn btn-sm" style="font-size:.5rem;padding:1px 4px;margin-left:4px;" onclick="editBudgetClient(\''+ch.id+'\')">‚úé</button>';
          html+=' <button class="btn btn-sm btn-danger" style="font-size:.5rem;padding:1px 4px;" onclick="removeBudgetClient(\''+ch.id+'\')">‚úï</button>';
          html+='</td>';
          html+='<td class="left"><span class="status-chip '+sc2+'">'+ch.status+'</span></td>';
          if(includePct) html+='<td colspan="2" style="color:var(--t3);font-size:.65rem;">‚Äî</td>';
          PROG_PRODUCTS.forEach(function(p){var val=Number((ch.prog&&ch.prog[p]&&ch.prog[p][m])||0);html+='<td><input class="bi" value="'+(val||'')+'" placeholder="‚Äî" onchange="updateBudgetCell(\''+ch.id+'\',\'prog\',\''+p+'\','+m+',this.value)"></td>';});
          html+='<td style="color:var(--green);">'+(crp?fmtM(crp):'‚Äî')+'</td>';
          OMNI_PRODUCTS.forEach(function(p){var val=Number((ch.omni&&ch.omni[p]&&ch.omni[p][m])||0);html+='<td><input class="bi" value="'+(val||'')+'" placeholder="‚Äî" onchange="updateBudgetCell(\''+ch.id+'\',\'omni\',\''+p+'\','+m+',this.value)"></td>';});
          html+='<td style="color:var(--blue);">'+(cro?fmtM(cro):'‚Äî')+'</td>';
          html+='<td style="color:var(--yellow);">'+(cgrand?fmtM(cgrand):'‚Äî')+'</td>';
          html+='<td style="color:var(--t2);">'+(cm2?fmtM(cm2):'‚Äî')+'</td>';
          html+='<td style="color:var(--green);">'+(cc2?'$'+cc2.toFixed(0):'‚Äî')+'</td>';
          html+='</tr>';
        });
      }
    });

    // Grand footer
    var extraCols=includePct?'<td colspan="2" style="color:var(--yellow);font-weight:600;">Wtd: '+fmtM(totWeighted)+'</td>':'';
    html+='<tfoot><tr class="total-row"><td class="left" colspan="2" style="position:sticky;left:0;background:var(--s2);">TOTAL ‚Äî '+MONTHS[m]+'</td>'+extraCols;
    PROG_PRODUCTS.forEach(function(p){html+='<td style="color:var(--green);">'+(progColTotals[p]?fmtM(progColTotals[p]):'‚Äî')+'</td>';});
    html+='<td style="color:var(--green);font-weight:700;">'+fmtM(totProg)+'</td>';
    OMNI_PRODUCTS.forEach(function(p){html+='<td style="color:var(--blue);">'+(omniColTotals[p]?fmtM(omniColTotals[p]):'‚Äî')+'</td>';});
    html+='<td style="color:var(--blue);font-weight:700;">'+fmtM(totOmni)+'</td>';
    html+='<td style="color:var(--yellow);font-weight:700;">'+fmtM(totProg+totOmni)+'</td>';
    html+='<td style="color:var(--t2);">'+fmtM(totMargin)+'</td>';
    html+='<td style="color:var(--green);font-weight:700;">$'+totComm.toFixed(0)+'</td></tr></tfoot>';
    return html;
  }

  // Top-level clients: direct brands + agency parents (children render as sub-rows, not top-level)
  var activeClients=budgetClients.filter(function(c){
    return (c.status==='active'||c.status==='paused') && !c.agencyParent;
  });
  var pendingClients=budgetClients.filter(function(c){
    return c.status==='pending' && !c.agencyParent;
  });

  var out='';
  if(activeClients.length){
    out+='<div style="font-family:var(--mono);font-size:.65rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin:0 0 6px;">‚ñ∏ Active / Signed ‚Äî '+MONTHS[m]+'</div>';
    out+='<div class="tbl-wrap" style="margin-bottom:20px;"><table class="tbl">'+buildHeader(false)+'<tbody>'+buildMainTable(activeClients,false)+'</table></div>';
  }
  if(pendingClients.length){
    out+='<div style="font-family:var(--mono);font-size:.65rem;color:var(--yellow);text-transform:uppercase;letter-spacing:.1em;margin:8px 0 6px;">‚óå Pending ‚Äî Proposals Out</div>';
    out+='<div class="tbl-wrap"><table class="tbl">'+buildHeader(true)+'<tbody>'+buildMainTable(pendingClients,true)+'</table></div>';
  }

  document.getElementById('budget-tbl').innerHTML=out||'<div style="text-align:center;padding:30px;color:var(--t3);font-size:.8rem;">No clients. Click + Add Client to get started.</div>';
}

function toggleBudgetGroup(agencyId){
  var rows=document.querySelectorAll('.budget-child-'+agencyId);
  var chev=document.getElementById('bgchev-'+agencyId);
  var hidden=!rows.length||rows[0].style.display==='none';
  rows.forEach(function(r){r.style.display=hidden?'':'none';});
  if(chev) chev.textContent=hidden?'‚ñº':'‚ñ∂';
}
function updateClosePct(id,val){
  var c=budgetClients.find(function(x){return x.id===id;}); if(!c)return;
  c.closePct=Math.min(100,Math.max(0,parseFloat(val)||50));
  renderMonthBudget(); renderCommBreakdown(); renderAnnualProj(); saveAll();
}
function updateBudgetCell(clientId,field,product,month,value){
  var c=budgetClients.find(function(x){return x.id===clientId;}); if(!c)return;
  if(!c[field]) c[field]={};
  if(!c[field][product]) c[field][product]=new Array(12).fill(0);
  c[field][product][month]=parseFloat(String(value).replace(/[$,]/g,''))||0;
  // Rerender totals row only for performance ‚Äî then save
  renderMonthBudget(); renderCommBreakdown(); renderAnnualProj(); saveAll();
}
function toggleAgencyParent(){
  var t=document.getElementById('bc-type').value;
  var wrap=document.getElementById('bc-parent-wrap');
  if(wrap) wrap.style.display=(t==='agency-child')?'':'none';
  if(t==='agency-child'){
    var sel=document.getElementById('bc-parent');
    var parents=budgetClients.filter(function(x){return x.type==='agency';});
    sel.innerHTML='<option value="">‚Äî Select Agency ‚Äî</option>'+parents.map(function(a){return '<option value="'+a.id+'">'+escH(a.name)+'</option>';}).join('');
  }
}
function addBudgetClient(){
  editBCId=null;
  document.getElementById('mbc-title').textContent='Add Budget Client';
  document.getElementById('bc-name').value=''; document.getElementById('bc-type').value='brand'; document.getElementById('bc-status').value='active'; document.getElementById('bc-id').value='';
  document.getElementById('bc-parent-wrap').style.display='none';
  document.getElementById('bc-prog-checks').innerHTML=PROG_PRODUCTS.map(function(p){return '<label style="display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:.68rem;cursor:pointer;padding:4px 8px;border:1px solid var(--b2);border-radius:3px"><input type="checkbox" value="'+p+'" style="accent-color:var(--white)"> '+p+'</label>';}).join('');
  document.getElementById('bc-omni-checks').innerHTML=OMNI_PRODUCTS.map(function(p){return '<label style="display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:.68rem;cursor:pointer;padding:4px 8px;border:1px solid var(--b2);border-radius:3px"><input type="checkbox" value="'+p+'" style="accent-color:var(--white)"> '+p+'</label>';}).join('');
  openM('m-budget-client');
}
function editBudgetClient(id){
  var c=budgetClients.find(function(x){return x.id===id;}); if(!c)return;
  editBCId=id; document.getElementById('mbc-title').textContent='Edit Budget Client';
  document.getElementById('bc-name').value=c.name; document.getElementById('bc-type').value=c.type||'brand'; document.getElementById('bc-status').value=c.status||'active'; document.getElementById('bc-id').value=id;
  toggleAgencyParent();
  if(c.agencyParent){ var sel=document.getElementById('bc-parent'); if(sel) sel.value=c.agencyParent; }
  var progActive=Object.keys(c.prog||{}); var omniActive=Object.keys(c.omni||{});
  document.getElementById('bc-prog-checks').innerHTML=PROG_PRODUCTS.map(function(p){return '<label style="display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:.68rem;cursor:pointer;padding:4px 8px;border:1px solid var(--b2);border-radius:3px"><input type="checkbox" value="'+p+'" '+(progActive.indexOf(p)!==-1?'checked':'')+' style="accent-color:var(--white)"> '+p+'</label>';}).join('');
  document.getElementById('bc-omni-checks').innerHTML=OMNI_PRODUCTS.map(function(p){return '<label style="display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:.68rem;cursor:pointer;padding:4px 8px;border:1px solid var(--b2);border-radius:3px"><input type="checkbox" value="'+p+'" '+(omniActive.indexOf(p)!==-1?'checked':'')+' style="accent-color:var(--white)"> '+p+'</label>';}).join('');
  openM('m-budget-client');
}
function saveBudgetClient(){
  var name=document.getElementById('bc-name').value.trim(); if(!name){toast('Name required','err');return;}
  var type=document.getElementById('bc-type').value;
  var agencyParent=(type==='agency-child')?(document.getElementById('bc-parent')||{}).value||'':'';
  var progChecked=Array.from(document.querySelectorAll('#bc-prog-checks input:checked')).map(function(x){return x.value;});
  var omniChecked=Array.from(document.querySelectorAll('#bc-omni-checks input:checked')).map(function(x){return x.value;});
  if(editBCId){
    var c=budgetClients.find(function(x){return x.id===editBCId;}); if(!c)return;
    c.name=name; c.type=type; c.status=document.getElementById('bc-status').value; c.agencyParent=agencyParent;
    progChecked.forEach(function(p){if(!c.prog[p]) c.prog[p]=new Array(12).fill(0);});
    omniChecked.forEach(function(p){if(!c.omni[p]) c.omni[p]=new Array(12).fill(0);});
  } else {
    var prog={}; var omni={};
    progChecked.forEach(function(p){prog[p]=new Array(12).fill(0);});
    omniChecked.forEach(function(p){omni[p]=new Array(12).fill(0);});
    budgetClients.push({id:uid(),name:name,type:type,agencyParent:agencyParent,status:document.getElementById('bc-status').value,prog:prog,omni:omni});
  }
  saveAll(); closeM('m-budget-client'); renderBudget(); toast(editBCId?'Client updated':'Client added','ok');
}
function removeBudgetClient(id){ if(!confirm('Remove from budget?'))return; budgetClients=budgetClients.filter(function(x){return x.id!==id;}); saveAll(); renderBudget(); toast('Removed','err'); }
function renderCommBreakdown(){
  var m=budgetM; var r=getRates();
  var rows=budgetClients.map(function(c){var prog=getClientProgTotal(c,m);var omni=getClientOmniTotal(c,m);var comm=(prog*r.pm*r.pc)+(omni*r.om*r.oc);return {name:c.name,comm:comm};}).filter(function(x){return x.comm>0;}).sort(function(a,b){return b.comm-a.comm;});
  var total=rows.reduce(function(s,x){return s+x.comm;},0);
  document.getElementById('comm-breakdown').innerHTML=rows.map(function(x){return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.7rem"><span style="color:var(--t2)">'+x.name+'</span><span style="color:var(--green)">$'+x.comm.toFixed(0)+'</span></div>';}).join('')+'<div style="display:flex;justify-content:space-between;padding:8px 0;font-family:var(--mono);font-size:.78rem;font-weight:500"><span style="color:var(--white)">TOTAL</span><span style="color:var(--green)">$'+total.toFixed(0)+'</span></div>';
}
function renderAnnualProj(){
  var bonusEl=document.getElementById('bonus-input'); var bonus=(bonusEl&&bonusEl.value)?parseFloat(bonusEl.value)||2000:2000;
  var monthly=MONTHS.map(function(nm,m){return {nm:nm.slice(0,3),comm:getMonthComm(m)};});
  var maxComm=Math.max.apply(null,monthly.map(function(x){return x.comm;}).concat([1]));
  var annual=monthly.reduce(function(s,x){return s+x.comm;},0)+bonus;
  document.getElementById('annual-proj').innerHTML=monthly.map(function(x){return '<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b)"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t2)">'+x.nm+'</span><div style="display:flex;align-items:center;gap:9px"><div style="width:75px;height:3px;background:var(--b2);border-radius:2px"><div style="width:'+Math.min(100,(x.comm/maxComm)*100)+'%;height:100%;background:var(--white);border-radius:2px"></div></div><span style="font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:right;color:var(--white)">$'+x.comm.toFixed(0)+'</span></div></div>';}).join('')+'<div style="display:flex;justify-content:space-between;padding:8px 0;font-family:var(--mono);font-size:.78rem;font-weight:500"><span style="color:var(--white)">ANNUAL + BONUS</span><span style="color:var(--green)">$'+annual.toFixed(0)+'</span></div>';
}

// ‚îÄ‚îÄ‚îÄ PRODUCTS SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSettings(){
  document.getElementById('prog-prod-list').innerHTML=PROG_PRODUCTS.map(function(p){return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.72rem"><span style="color:var(--green)">'+p+'</span><button class="btn btn-sm btn-danger" onclick="removeProduct(\'prog\',\''+p+'\')">‚úï</button></div>';}).join('');
  document.getElementById('omni-prod-list').innerHTML=OMNI_PRODUCTS.map(function(p){return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b);font-family:var(--mono);font-size:.72rem"><span style="color:var(--blue)">'+p+'</span><button class="btn btn-sm btn-danger" onclick="removeProduct(\'omni\',\''+p+'\')">‚úï</button></div>';}).join('');
}
function addProduct(type){ var inp=document.getElementById('new-'+type); var val=inp.value.trim(); if(!val)return; if(type==='prog') PROG_PRODUCTS.push(val); else OMNI_PRODUCTS.push(val); inp.value=''; saveAll(); renderSettings(); renderBudget(); toast('Product added','ok'); }
function removeProduct(type,name){ if(type==='prog') PROG_PRODUCTS=PROG_PRODUCTS.filter(function(p){return p!==name;}); else OMNI_PRODUCTS=OMNI_PRODUCTS.filter(function(p){return p!==name;}); saveAll(); renderSettings(); renderBudget(); toast('Removed','ok'); }
function saveSettings(){ saveAll(); toast('Settings saved','ok'); }
function exportData(){ var data={contacts:contacts,agencies:agencies,todos:todos,budgetClients:budgetClients,PROG_PRODUCTS:PROG_PRODUCTS,OMNI_PRODUCTS:OMNI_PRODUCTS,exportedAt:new Date().toISOString()}; var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='simplifi-backup.json'; a.click(); toast('Exported','ok'); }
function clearData(){ if(!confirm('Delete ALL data?'))return; ['sc4_contacts','sc4_agencies','sc4_todos','sc4_reports','sc4_budget','sc4_products'].forEach(function(k){localStorage.removeItem(k);}); contacts=seedContacts(); agencies=seedAgencies(); todos=seedTodos(); reportClients=seedReports(); budgetClients=seedBudget(); saveAll(); refreshAll(); toast('Data cleared','err'); }

// ‚îÄ‚îÄ‚îÄ PROSPECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runScrubber(){
  document.getElementById('scrub-ts').textContent='Scanning...';
  setTimeout(function(){
    mockProspects=[{name:'Knox Spine & Rehab',contact:'Dr. Bill Andrews',vertical:'Healthcare',activity:'12 active Meta ads',spend:85,added:false},{name:'Smoky Mountain RV',contact:'Frank Douglas',vertical:'Automotive/RV',activity:'7 active Meta ads',spend:72,added:false},{name:'Appalachian Roofing Co.',contact:'Jake Turner',vertical:'Home Services',activity:'9 active Meta ads',spend:55,added:false},{name:'Knox Personal Injury Law',contact:'Scott Manning',vertical:'Legal',activity:'15 active Meta ads',spend:95,added:false},{name:'Marble City Kitchen',contact:'Angela Rivera',vertical:'Restaurant',activity:'3 active Meta ads',spend:40,added:false}];
    renderProspects(); document.getElementById('scrub-ts').textContent=new Date().toLocaleTimeString()+' ¬∑ '+mockProspects.length+' found';
  },1200);
}
function renderProspects(){
  var feed=document.getElementById('prospect-feed'); if(!mockProspects.length){feed.innerHTML='<div class="empty">Run scrubber to find prospects</div>';return;}
  feed.innerHTML='<div style="display:grid;grid-template-columns:1fr 120px 150px 70px 75px;padding:8px 14px;font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;background:var(--s2);border-bottom:1px solid var(--b)"><div>Business</div><div>Vertical</div><div>Activity</div><div>Signal</div><div>Action</div></div>'+mockProspects.map(function(p,i){return '<div style="display:grid;grid-template-columns:1fr 120px 150px 70px 75px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--b)"><div><div style="color:var(--white)">'+p.name+'</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">'+p.contact+'</div></div><div style="font-size:.77rem;color:var(--t2)">'+p.vertical+'</div><div style="font-family:var(--mono);font-size:.68rem">'+p.activity+'<div style="height:3px;background:var(--b2);border-radius:2px;margin-top:3px"><div style="width:'+p.spend+'%;height:100%;background:var(--white);border-radius:2px"></div></div></div><div style="font-family:var(--mono);font-size:.68rem;color:var(--t2)">'+p.spend+'%</div><div>'+(p.added?'<span style="font-family:var(--mono);font-size:.6rem;color:var(--green)">ADDED</span>':'<button class="btn btn-sm btn-w" onclick="addProspect('+i+')">+ Add</button>')+'</div></div>';}).join('');
}
function addProspect(i){ var p=mockProspects[i]; var parts=p.contact.split(' '); contacts.unshift({id:uid(),firstName:parts[0],lastName:parts.slice(1).join(' '),company:p.name,phone:'',email:'',vertical:p.vertical,stage:'Cold',budget:'',followUp:'',notes:'Meta Ad Library: '+p.activity,source:'Meta Scrubber',lastContact:new Date().toISOString(),createdAt:new Date().toISOString(),callLog:[]}); mockProspects[i].added=true; saveAll(); renderProspects(); refreshAll(); toast(p.name+' added','ok'); }

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReports(){
  var all=[]; agencies.forEach(function(a){(a.children||[]).forEach(function(ch){all.push({id:ch.id,label:ch.name+' ('+a.name+')',email:ch.reportEmail});});});
  document.getElementById('rpt-cl').innerHTML='<option value="">Choose...</option>'+all.map(function(c){return '<option value="'+c.id+'">'+c.label+'</option>';}).join('');
  document.getElementById('rpt-list').innerHTML=reportClients.length?reportClients.map(function(r){return '<div class="rpt-row"><div><div style="color:var(--white)">'+r.clientName+'</div><div style="font-family:var(--mono);font-size:.63rem;color:var(--t2)">'+r.agencyName+' ¬∑ '+r.email+'</div></div><div style="display:flex;align-items:center;gap:9px"><span style="font-family:var(--mono);font-size:.62rem;color:var(--t3)">'+r.schedule+'</span><span style="font-family:var(--mono);font-size:.6rem;color:var(--t3)">Last: '+fmtDate(r.lastSent)+'</span><button class="btn btn-sm btn-w" onclick="quickSend(\''+r.id+'\')">Send Now</button></div></div>';}).join(''):'<div class="empty">No report clients</div>';
}
function handlePdf(input){ var f=input.files[0]; if(!f)return; var st=document.getElementById('pdf-st'); st.style.display='block'; st.textContent='Uploaded: '+f.name; }
function genReport(){
  var cid=document.getElementById('rpt-cl').value; var period=document.getElementById('rpt-per').value;
  if(!cid){toast('Select a client','err');return;}
  var cName=''; var aName=''; var email='';
  agencies.forEach(function(a){(a.children||[]).forEach(function(ch){if(ch.id===cid){cName=ch.name;aName=a.name;email=ch.reportEmail||ch.email;}});});
  var prev=document.getElementById('rpt-prev'); prev.style.display='block';
  prev.innerHTML='<div class="card"><div class="ch"><span class="ct">Report Preview ‚Äî '+cName+'</span></div><div class="cb"><div class="ai-box"><div class="ai-l">AI ‚Äî Weekly Report</div><div class="ai-out" id="rpt-ai">Generating...<span class="tcursor"></span></div></div></div></div>';
  fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:900,messages:[{role:"user",content:"Write a weekly campaign performance report email.\nClient: "+cName+"\nAgency: "+aName+"\nPeriod: "+(period||'This week')+"\n\nInclude subject, greeting, performance summary with realistic programmatic numbers (impressions, CTR, conversions), key wins, next week optimization. Under 200 words. Professional."}]})})
  .then(function(r){return r.json();})
  .then(function(d){document.getElementById('rpt-ai').innerHTML=(d.content||[]).map(function(x){return x.text||'';}).join('').replace(/\n/g,'<br>');toast('Report ready for '+cName,'ok');})
  .catch(function(){document.getElementById('rpt-ai').innerHTML='AI unavailable.';});
}
function quickSend(id){ var r=reportClients.find(function(x){return x.id===id;}); if(r){toast('Report queued for '+r.clientName,'ok');r.lastSent=new Date().toISOString();saveAll();renderReports();} }

// ‚îÄ‚îÄ‚îÄ EMAIL TOOLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var lastBriefingText = '';

function saveIntSettings(){
  var n=document.getElementById('int-name'); var e=document.getElementById('int-email');
  if(n) lsSet('sc4_int_name', n.value);
  if(e) lsSet('sc4_int_email', e.value);
}

function loadIntSettings(){
  var n=lsGet('sc4_int_name'); var e=lsGet('sc4_int_email');
  var nEl=document.getElementById('int-name'); var eEl=document.getElementById('int-email');
  if(nEl&&n) nEl.value=n;
  if(eEl&&e) eEl.value=e;
  // also sync set-name/set-email on settings page
  var sn=document.getElementById('set-name'); var se=document.getElementById('set-email');
  if(sn&&n) sn.value=n;
  if(se&&e) se.value=e;
  // populate contact dropdowns
  populateEmailContacts();
}

function populateEmailContacts(){
  var opts='<option value="">Select contact...</option>'+contacts.map(function(c){return '<option value="'+c.id+'">'+c.firstName+' '+c.lastName+' ‚Äî '+c.company+'</option>';}).join('');
  var qe=document.getElementById('qe-contact'); if(qe) qe.innerHTML=opts;
  var li=document.getElementById('li-contact'); if(li) li.innerHTML=opts;
}

function openBriefingInMail(){
  if(!lastBriefingText){toast('Generate a briefing first','err');return;}
  var toEl=document.getElementById('int-email'); var to=toEl?toEl.value:'';
  var subject='Morning Briefing ‚Äî '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
  var mailto='mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(lastBriefingText);
  window.location.href=mailto;
  document.getElementById('briefing-status').textContent='Opened in your email client ‚úì';
}

function copyBriefingToClipboard(){
  if(!lastBriefingText){toast('Generate a briefing first','err');return;}
  navigator.clipboard.writeText(lastBriefingText).then(function(){
    toast('Briefing copied to clipboard','ok');
    document.getElementById('briefing-status').textContent='Copied to clipboard ‚Äî paste into any email ‚úì';
  }).catch(function(){
    toast('Copy failed ‚Äî try the email client button','err');
  });
}

function prefillQuickEmail(){
  var cid=document.getElementById('qe-contact').value;
  var c=contacts.find(function(x){return x.id===cid;});
  if(c&&c.notes){document.getElementById('qe-notes').value=c.notes.slice(0,120);}
}

function generateQuickEmail(){
  var cid=document.getElementById('qe-contact').value;
  var type=document.getElementById('qe-type').value;
  var notes=document.getElementById('qe-notes').value;
  if(!cid){toast('Select a contact first','err');return;}
  var c=contacts.find(function(x){return x.id===cid;});
  if(!c)return;
  var typeLabels={followup:'follow-up after previous conversation',proposal:'proposal introduction for Simpli.fi programmatic advertising',checkin:'friendly check-in',cold:'cold outreach introducing Simpli.fi programmatic advertising services',thankyou:'thank you after a meeting',recap:'meeting recap summarizing what was discussed'};
  var prev=document.getElementById('qe-preview'); prev.style.display='block';
  document.getElementById('qe-subject').value='Generating...';
  document.getElementById('qe-body').value='Drafting...';
  var nameEl=document.getElementById('int-name'); var myName=nameEl?nameEl.value:'';
  var prompt='Write a short professional sales email.\n\nFrom: '+myName+' (Simpli.fi Sales Director, East Tennessee)\nTo: '+c.firstName+' '+c.lastName+', '+c.company+(c.vertical?' ('+c.vertical+')':'')+'\nEmail type: '+typeLabels[type]+'\nContact stage: '+c.stage+'\nNotes/context: '+(notes||c.notes||'none')+'\nProduct: Simpli.fi programmatic advertising (CTV, Display, OLV) and Omni/Social (SEM, YouTube, etc)\n\nReturn ONLY:\nSUBJECT: [subject line]\nBODY:\n[email body]\n\nUnder 120 words. Warm, specific, professional. No fluff.';
  fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:500,messages:[{role:"user",content:prompt}]})})
  .then(function(r){return r.json();})
  .then(function(d){
    var text=(d.content||[]).map(function(x){return x.text||'';}).join('');
    var subMatch=text.match(/SUBJECT:\s*(.+)/); var bodyMatch=text.match(/BODY:\s*([\s\S]+)/);
    document.getElementById('qe-subject').value=subMatch?subMatch[1].trim():'Follow-up from Simpli.fi';
    document.getElementById('qe-body').value=bodyMatch?bodyMatch[1].trim():text;
    toast('Email drafted','ok');
  })
  .catch(function(){toast('AI unavailable','err');});
}

function sendQuickEmail(){
  var cid=document.getElementById('qe-contact').value; var c=contacts.find(function(x){return x.id===cid;});
  var subject=document.getElementById('qe-subject').value;
  var body=document.getElementById('qe-body').value;
  var to=c?c.email:'';
  window.location.href='mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
  toast('Opened in email client','ok');
}

function copyQuickEmail(){
  var subject=document.getElementById('qe-subject').value;
  var body=document.getElementById('qe-body').value;
  navigator.clipboard.writeText('Subject: '+subject+'\n\n'+body).then(function(){toast('Copied','ok');});
}

function logQuickEmail(){
  var cid=document.getElementById('qe-contact').value; if(!cid){toast('Select a contact','err');return;}
  var body=document.getElementById('qe-body').value.slice(0,200);
  var i=contacts.findIndex(function(c){return c.id===cid;}); if(i===-1)return;
  if(!contacts[i].callLog) contacts[i].callLog=[];
  contacts[i].callLog.push({date:new Date().toISOString(),text:'Email sent: '+body,stageChange:null});
  contacts[i].lastContact=new Date().toISOString();
  saveAll(); toast('Logged as contact activity','ok');
}

function processInboundEmail(){
  var cid=document.getElementById('li-contact').value; var text=document.getElementById('li-text').value.trim(); var stage=document.getElementById('li-stage').value;
  if(!cid){toast('Select a contact','err');return;}
  if(!text){toast('Paste an email first','err');return;}
  var c=contacts.find(function(x){return x.id===cid;});
  var res=document.getElementById('li-result'); res.style.display='block';
  res.innerHTML='<div class="ai-box"><div class="ai-l">Extracting...</div><div class="ai-out" id="li-ai">Reading email...<span class="tcursor"></span></div></div>';
  var prompt='You are a CRM assistant. Extract key info from this inbound email and summarize it as a brief CRM note (2-3 sentences max). Focus on: what they said, any objections, next steps, buying signals, or concerns.\n\nContact: '+c.firstName+' '+c.lastName+', '+c.company+'\nEmail text:\n'+text+'\n\nReturn ONLY the CRM note. No preamble.';
  fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:300,messages:[{role:"user",content:prompt}]})})
  .then(function(r){return r.json();})
  .then(function(d){
    var note=(d.content||[]).map(function(x){return x.text||'';}).join('').trim();
    document.getElementById('li-ai').innerHTML=note;
    // Update the contact
    var i=contacts.findIndex(function(x){return x.id===cid;}); if(i===-1)return;
    if(!contacts[i].callLog) contacts[i].callLog=[];
    contacts[i].callLog.push({date:new Date().toISOString(),text:'Inbound email: '+note,stageChange:stage||null});
    contacts[i].lastContact=new Date().toISOString();
    if(stage) contacts[i].stage=stage;
    saveAll(); refreshAll();
    res.innerHTML+='<div style="font-family:var(--mono);font-size:.63rem;color:var(--green);margin-top:8px;">‚úì Contact updated ‚Äî last contact set to today'+(stage?' ¬∑ stage ‚Üí '+stage:'')+'</div>';
    toast('Email logged & contact updated','ok');
  })
  .catch(function(){document.getElementById('li-ai').innerHTML='AI unavailable.';});
}

// ‚îÄ‚îÄ‚îÄ BRIEFING EMAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function previewBriefing(){
  var body=document.getElementById('mb-body');
  body.innerHTML='<div class="ai-box"><div class="ai-l">Generating...</div><div class="ai-out">Building your morning briefing...<span class="tcursor"></span></div></div>';
  openM('m-briefing');
  var ct=getColdThreshold();
  var cold=contacts.filter(function(c){return daysSince(c.lastContact)>=ct&&!['Closed Won','Closed Lost'].includes(c.stage);});
  var pri=contacts.filter(function(c){return ['At the Table','Proposal Sent','Follow-Up Scheduled'].includes(c.stage);}).slice(0,4);
  var ot=todos.filter(function(t){return !t.done;}).slice(0,5);
  var mt=getMonthTotal(CURM); var mc=getMonthComm(CURM);
  var annual=0; for(var m=0;m<12;m++) annual+=getMonthTotal(m);
  var nameEl=document.getElementById('set-name'); var name=nameEl?nameEl.value:'';
  var prompt="You are the personal sales assistant for "+(name||'a')+" Simpli.fi Sales Director in East Tennessee. Generate their morning briefing email.\n\nToday: "+new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})+"\n\n"+MONTHS[CURM]+" on the books: $"+mt.toLocaleString()+" | Monthly commission: $"+mc.toFixed(0)+"\nAnnual contracted: $"+annual.toLocaleString()+"\n\nPriority contacts:\n"+pri.map(function(c){return '- '+c.firstName+' '+c.lastName+', '+c.company+' ('+c.stage+'): '+(c.notes||'').slice(0,80);}).join('\n')+"\n\nCold leads ("+ct+"+ days):\n"+cold.map(function(c){return '- '+c.firstName+' '+c.lastName+', '+c.company+' ‚Äî '+daysSince(c.lastContact)+' days';}).join('\n')+"\n\nOpen to-dos: "+ot.map(function(t){return t.text;}).join('; ')+"\n\nWrite plain-text briefing: subject line, greeting, today's calendar (1-2 realistic meetings), priority contacts with specific talking points, cold leads, budget snapshot, to-do list. ~300 words. Direct, professional.";
  fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1500,messages:[{role:"user",content:prompt}]})})
  .then(function(r){return r.json();})
  .then(function(d){var text=(d.content||[]).map(function(x){return x.text||'';}).join(''); lastBriefingText=text; body.innerHTML='<div style="background:var(--s2);border:1px solid var(--b);border-radius:3px;padding:14px;font-family:var(--mono);font-size:.7rem;line-height:1.85;color:var(--t2);white-space:pre-wrap">'+text+'</div><div style="display:flex;gap:7px;margin-top:10px;"><button class="btn btn-w" onclick="openBriefingInMail()">‚úâ Open in Email Client</button><button class="btn" onclick="copyBriefingToClipboard()">‚ßâ Copy</button></div>';})
  .catch(function(){body.innerHTML='<p style="color:var(--t3);font-family:var(--mono);font-size:.72rem">AI unavailable ‚Äî check your internet connection.</p>';});
}

// ‚îÄ‚îÄ‚îÄ OVERLAY CLOSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.overlay').forEach(function(o){
  o.addEventListener('click',function(e){if(e.target===o) o.classList.remove('open');});
});


// ‚îÄ‚îÄ‚îÄ PROPOSAL BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var pbTiers=[];
var pbLines=[];
var pbInited=false;

var PLACEMENT_OPTS=[
  'DISPLAY: Desktop, Laptop, Tablet, Mobile',
  'ONLINE VIDEO: Desktop, Laptop, Tablet, Mobile',
  'OTT/CTV: Large Screen',
  'AUDIO + COMPANION DISPLAY ADS',
  'In-stream TrueView (YouTube)',
  'Non-Skippable Ads (YouTube TV)',
  'Display & Video (Meta: Facebook & Instagram)',
  'Netflix (Always-On/PMP)',
  'Digital Out-of-Home (DOOH)',
  'Google SEM',
  'LinkedIn',
  'Custom'
];
var TARGETING_OPTS=[
  'Keyword-Level Behavioral (General and/or Competitor Terms)',
  'Website Retargeting',
  'Addressable Geo-Fencing (Addressable Audience Curated Demos)',
  'Premium Allowlist',
  'Geo-Fencing & Conversion Zone Tracking',
  'Premium Publisher - Disney',
  'Premium Publishers - Family Friendly Content',
  'Audio Publisher Direct Deals - Streaming',
  'Audio Deals - Podcast',
  'Parents & Family Vacationers',
  'Keyword Contextual',
  'CRM / First Party Data',
  'Custom'
];
var ADSIZE_OPTS=[
  '160x600, 300x250, 728x90, 320x50, 300x50, 300x600, 320x480',
  ':15s & :30s Video',
  ':06s & :15s & :30s',
  ':6s, :10s, :15s & :30s + 300x250, 300x600, 500x500',
  'Non-Skippable :30s',
  'Varied Display & Video',
  ':15s',
  'Text Ad'
];

function initProposal(){
  if(pbInited) return;
  pbInited=true;
  var saved=lsGet('sc4_proposal');
  if(saved){ pbTiers=saved.tiers||[]; pbLines=saved.lines||[]; }
  if(!pbTiers.length) pbTiers=[{id:uid(),label:'Option A',budget:15000},{id:uid(),label:'Option B',budget:20000},{id:uid(),label:'Option C',budget:25000}];
  if(!pbLines.length) addLineItem(true);
  renderPBTiers(); renderPBLines(); renderProposalPreview();
}

function toggleGeoInput(){
  var v=document.getElementById('pb-geo-type').value;
  document.getElementById('pb-geo-custom-wrap').style.display=(v==='zips'||v==='custom')?'block':'none';
}

function getGeoText(){
  var v=document.getElementById('pb-geo-type').value;
  if(v==='dma') return 'Knoxville DMA';
  if(v==='counties') return 'Knox County, TN\nSevier County, TN\nBlount County, TN\nAnderson County, TN\nLoudon County, TN\nHamblen County, TN\nJefferson County, TN\nCocke County, TN\nGrainger County, TN\nGreene County, TN';
  return (document.getElementById('pb-geo-custom')||{}).value||'';
}

function addTier(){
  pbTiers.push({id:uid(),label:'Option '+String.fromCharCode(65+pbTiers.length),budget:5000});
  renderPBTiers(); renderPBLines(); savePB();
}

function renderPBTiers(){
  var el=document.getElementById('pb-tiers-list'); if(!el)return;
  var h='';
  pbTiers.forEach(function(t){
    h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">';
    h+='<input class="fi" style="width:120px" value="'+t.label+'" placeholder="Label" onchange="pbTierField(\''+t.id+'\',\'label\',this.value)">';
    h+='<input class="fi" style="width:120px" value="'+t.budget+'" placeholder="Budget" onchange="pbTierField(\''+t.id+'\',\'budget\',parseFloat(this.value)||0)">';
    h+='<button class="btn btn-sm btn-danger" onclick="removeTier(\''+t.id+'\')">‚úï</button>';
    h+='</div>';
  });
  el.innerHTML=h;
}

function pbTierField(id,field,val){ var t=pbTiers.find(function(x){return x.id===id;}); if(t){t[field]=val;} renderPBLines(); renderProposalPreview(); savePB(); }
function removeTier(id){ pbTiers=pbTiers.filter(function(t){return t.id!==id;}); renderPBTiers(); renderPBLines(); savePB(); }

function addLineItem(silent){
  pbLines.push({id:uid(),placement:'DISPLAY: Desktop, Laptop, Tablet, Mobile',targeting:'Keyword-Level Behavioral (General and/or Competitor Terms)',details:'',cpm:4.00,adsize:'160x600, 300x250, 728x90, 320x50, 300x50, 300x600, 320x480',budgets:{}});
  pbTiers.forEach(function(t){ pbLines[pbLines.length-1].budgets[t.id]=0; });
  if(!silent){ renderPBLines(); renderProposalPreview(); savePB(); }
}

function renderPBLines(){
  var hdrEl=document.getElementById('pb-lines-hdr'); var bodyEl=document.getElementById('pb-lines-body'); if(!hdrEl||!bodyEl)return;
  var hdr='<th class="left" style="min-width:160px">Placement</th><th class="left" style="min-width:160px">Targeting</th><th class="left" style="min-width:180px">Details</th><th class="left">Ad Sizes</th><th>CPM</th>';
  pbTiers.forEach(function(t){ hdr+='<th style="color:var(--yellow)">'+t.label+' Budget</th><th style="color:var(--t2)">Impressions</th>'; });
  hdr+='<th></th>';
  hdrEl.innerHTML=hdr;
  var rows='';
  pbLines.forEach(function(ln,i){
    rows+='<tr>';
    // Placement dropdown
    rows+='<td><select class="fs" style="font-size:.7rem;width:155px" onchange="pbLineField(\''+ln.id+'\',\'placement\',this.value)">';
    PLACEMENT_OPTS.forEach(function(o){ rows+='<option'+(ln.placement===o?' selected':'')+'>'+o+'</option>'; });
    rows+='</select></td>';
    // Targeting dropdown
    rows+='<td><select class="fs" style="font-size:.7rem;width:155px" onchange="pbLineField(\''+ln.id+'\',\'targeting\',this.value)">';
    TARGETING_OPTS.forEach(function(o){ rows+='<option'+(ln.targeting===o?' selected':'')+'>'+o+'</option>'; });
    rows+='</select></td>';
    // Details
    rows+='<td><input class="bi" style="width:175px" value="'+ln.details+'" placeholder="Description..." onchange="pbLineField(\''+ln.id+'\',\'details\',this.value)"></td>';
    // Ad sizes
    rows+='<td><select class="fs" style="font-size:.65rem;width:130px" onchange="pbLineField(\''+ln.id+'\',\'adsize\',this.value)">';
    ADSIZE_OPTS.forEach(function(o){ rows+='<option'+(ln.adsize===o?' selected':'')+'>'+o+'</option>'; });
    rows+='<option'+(ADSIZE_OPTS.indexOf(ln.adsize)===-1?' selected':'')+'>'+ln.adsize+'</option>';
    rows+='</select></td>';
    // CPM
    rows+='<td><input class="bi" style="width:55px" value="'+ln.cpm+'" placeholder="CPM" onchange="pbLineField(\''+ln.id+'\',\'cpm\',parseFloat(this.value)||0)"></td>';
    // Per-tier budget + impressions
    pbTiers.forEach(function(t){
      var bgt=Number(ln.budgets[t.id]||0);
      var impr=ln.cpm>0&&bgt>0?Math.round(bgt/ln.cpm*1000):0;
      rows+='<td><input class="bi" style="width:80px;color:var(--yellow)" value="'+(bgt||'')+'" placeholder="$0" onchange="pbLineBudget(\''+ln.id+'\',\''+t.id+'\',this.value)"></td>';
      rows+='<td style="color:var(--t2);font-size:.7rem">'+(impr?impr.toLocaleString():'‚Äî')+'</td>';
    });
    rows+='<td><button class="btn btn-sm btn-danger" onclick="removeLine(\''+ln.id+'\')">‚úï</button></td>';
    rows+='</tr>';
  });
  bodyEl.innerHTML=rows;
}

function pbLineField(id,field,val){ var ln=pbLines.find(function(x){return x.id===id;}); if(ln){ln[field]=val;} renderPBLines(); renderProposalPreview(); savePB(); }
function pbLineBudget(lnId,tierId,val){
  var ln=pbLines.find(function(x){return x.id===lnId;}); if(!ln)return;
  if(!ln.budgets)ln.budgets={};
  ln.budgets[tierId]=parseFloat(String(val).replace(/[$,]/g,''))||0;
  renderPBLines(); renderProposalPreview(); savePB();
}
function removeLine(id){ pbLines=pbLines.filter(function(l){return l.id!==id;}); renderPBLines(); renderProposalPreview(); savePB(); }
function savePB(){ lsSet('sc4_proposal',{tiers:pbTiers,lines:pbLines}); }
function clearProposal(){ if(!confirm('Clear this proposal and start fresh?'))return; pbTiers=[{id:uid(),label:'Option A',budget:15000},{id:uid(),label:'Option B',budget:20000},{id:uid(),label:'Option C',budget:25000}]; pbLines=[]; addLineItem(true); renderPBTiers(); renderPBLines(); renderProposalPreview(); savePB(); toast('Proposal cleared','err'); }

function renderProposalPreview(){
  var el=document.getElementById('pb-preview'); if(!el)return;
  var client=document.getElementById('pb-client')?document.getElementById('pb-client').value:'';
  var website=document.getElementById('pb-website')?document.getElementById('pb-website').value:'';
  var kpi=document.getElementById('pb-kpi')?document.getElementById('pb-kpi').value:'Reach';
  var start=document.getElementById('pb-start')?document.getElementById('pb-start').value:'';
  var end=document.getElementById('pb-end')?document.getElementById('pb-end').value:'';
  var geo=getGeoText();
  if(!client){el.innerHTML='<span style="color:var(--t2);font-style:italic">Enter client name to see preview.</span>'; return;}
  var html='<div style="font-family:var(--mono);font-size:.65rem;color:var(--green);margin-bottom:12px;text-transform:uppercase;letter-spacing:.1em;">MEDIA PLAN PREVIEW ‚Äî '+client+'</div>';
  html+='<div style="display:grid;grid-template-columns:repeat('+Math.min(pbTiers.length,3)+',1fr);gap:12px;margin-bottom:16px;">';
  pbTiers.forEach(function(t){
    var total=pbLines.reduce(function(s,ln){return s+(Number(ln.budgets[t.id])||0);},0);
    var totImpr=pbLines.reduce(function(s,ln){var b=Number(ln.budgets[t.id]||0);return s+(ln.cpm>0&&b>0?Math.round(b/ln.cpm*1000):0);},0);
    var blendCPM=totImpr>0?(total/(totImpr/1000)):0;
    html+='<div class="card" style="padding:12px;">';
    html+='<div style="color:var(--yellow);font-weight:600;margin-bottom:6px;">'+t.label+' ‚Äî $'+Number(total).toLocaleString()+'</div>';
    html+='<div style="color:var(--t2);font-size:.7rem;">'+totImpr.toLocaleString()+' Impressions</div>';
    html+='<div style="color:var(--t2);font-size:.7rem;">Blended CPM: $'+blendCPM.toFixed(2)+'</div>';
    html+='</div>';
  });
  html+='</div>';
  html+='<div style="overflow-x:auto;"><table class="tbl" style="font-size:.7rem;">';
  html+='<thead><tr><th class="left">Placement</th><th class="left">Targeting</th><th class="left">Geo</th><th>Flight</th><th>Ad Sizes</th>';
  pbTiers.forEach(function(t){html+='<th style="color:var(--yellow)">Impressions ('+t.label+')</th><th>CPM</th><th style="color:var(--yellow)">Budget ('+t.label+')</th>';});
  html+='</tr></thead><tbody>';
  pbLines.forEach(function(ln){
    html+='<tr><td class="left">'+ln.placement+'</td><td class="left">'+ln.targeting+'</td>';
    html+='<td class="left" style="font-size:.6rem;color:var(--t2)">'+geo.split('\n').slice(0,3).join(', ')+(geo.split('\n').length>3?' ...':'')+'</td>';
    html+='<td style="font-size:.6rem">'+(start&&end?start+' ‚Äì '+end:'TBD')+'</td>';
    html+='<td style="font-size:.6rem;color:var(--t2)">'+ln.adsize+'</td>';
    pbTiers.forEach(function(t){
      var b=Number(ln.budgets[t.id]||0);
      var impr=ln.cpm>0&&b>0?Math.round(b/ln.cpm*1000):0;
      html+='<td>'+(impr?impr.toLocaleString():'‚Äî')+'</td><td>$'+Number(ln.cpm).toFixed(2)+'</td><td style="color:var(--yellow)">'+(b?'$'+b.toLocaleString():'‚Äî')+'</td>';
    });
    html+='</tr>';
  });
  html+='</tbody></table></div>';
  if(website) html+='<div style="margin-top:10px;font-size:.7rem;color:var(--t2)"><strong>Website:</strong> '+website+'</div>';
  if(kpi) html+='<div style="font-size:.7rem;color:var(--t2)"><strong>Primary KPI:</strong> '+kpi+'</div>';
  el.innerHTML=html;
}

function exportProposalExcel(){
  var client=(document.getElementById('pb-client')||{}).value||'Media Plan';
  var website=(document.getElementById('pb-website')||{}).value||'';
  var kpi=(document.getElementById('pb-kpi')||{}).value||'Reach';
  var start=(document.getElementById('pb-start')||{}).value||'';
  var end=(document.getElementById('pb-end')||{}).value||'';
  var notes=(document.getElementById('pb-notes')||{}).value||'';
  var geo=getGeoText();
  var flight=start&&end?start+' ‚Äì '+end:'TBD';
  var today=new Date().toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'numeric'}).replace(/\//g,'_');

  // Build CSV content for each tier as a separate sheet (we'll use a multi-CSV approach via a zip ‚Äî but since we can't do real xlsx here without a library, we'll build a proper xlsx via backend)
  // Actually let's build a real multi-sheet xlsx using Python
  lsSet('sc4_proposal_export',{client:client,website:website,kpi:kpi,flight:flight,notes:notes,geo:geo,tiers:pbTiers,lines:pbLines,today:today});
  toast('Generating Excel file...','ok');

  // Send all data to a server-side export via fetch to our bash ‚Äî but we're in browser. Instead, trigger download via base64 xlsx
  // We'll generate via a hidden form post approach ‚Äî simpler: encode as a data URL blob
  generateXLSXDownload(client,website,kpi,flight,notes,geo,pbTiers,pbLines,today);
}

function generateXLSXDownload(client,website,kpi,flight,notes,geo,tiers,lines,today){
  // Build XML-based xlsx (Open XML format) ‚Äî multi-sheet
  // We'll create one sheet per tier + a summary sheet
  function escXML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function cell(col,row,val,bold,color){
    var t=typeof val==='number'?'n':'s';
    var v=typeof val==='number'?val:escXML(val);
    var style=bold?'1':'0';
    return '<c r="'+col+row+'" t="'+(t==='s'?'inlineStr':'n')+'" s="'+style+'">'+(t==='s'?'<is><t>'+v+'</t></is>':'<v>'+v+'</v>')+'</c>';
  }

  // Since proper XLSX generation in-browser without a library is very complex,
  // let's use SheetJS-style approach via loading it dynamically
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onload=function(){
    var wb=XLSX.utils.book_new();

    tiers.forEach(function(t){
      var aoa=[];
      // Header rows
      aoa.push(['MEDIA PLAN','','','','',client+' | '+today]);
      aoa.push([]);
      aoa.push(['PLACEMENT','TARGETING','DETAILS','GEO','FLIGHT','AD SIZES','IMPRESSIONS','CPM','TOTAL BUDGET']);
      aoa.push(['BRANDING/AWARENESS']);

      lines.forEach(function(ln){
        var bgt=Number(ln.budgets[t.id]||0);
        var impr=ln.cpm>0&&bgt>0?Math.round(bgt/ln.cpm*1000):0;
        aoa.push([ln.placement,ln.targeting,ln.details,geo,flight,ln.adsize,impr,Number(ln.cpm),bgt]);
      });

      // Totals
      var totBgt=lines.reduce(function(s,ln){return s+(Number(ln.budgets[t.id]||0));},0);
      var totImpr=lines.reduce(function(s,ln){var b=Number(ln.budgets[t.id]||0);return s+(ln.cpm>0&&b>0?Math.round(b/ln.cpm*1000):0);},0);
      var blendCPM=totImpr>0?(totBgt/(totImpr/1000)):0;
      aoa.push([]);
      aoa.push(['','','','','','TOTAL',totImpr,blendCPM,totBgt]);
      aoa.push([]);
      aoa.push(['PRIMARY KPI:',kpi]);
      aoa.push(['ADVERTISER WEBSITE:',website]);
      aoa.push([]);
      if(notes){
        var noteLines=notes.split('\n');
        aoa.push(['ADDITIONAL NOTES:',noteLines[0]]);
        for(var ni=1;ni<noteLines.length;ni++) aoa.push(['',noteLines[ni]]);
      }

      var ws=XLSX.utils.aoa_to_sheet(aoa);
      // Column widths
      ws['!cols']=[{wch:30},{wch:35},{wch:40},{wch:25},{wch:15},{wch:30},{wch:14},{wch:8},{wch:14}];
      XLSX.utils.book_append_sheet(wb,ws,t.label+' ($'+Number(totBgt/1000).toFixed(0)+'K)');
    });

    // Summary sheet
    var sum=[['PROPOSAL SUMMARY ‚Äî '+client]];
    sum.push([]);
    sum.push(['Tier','Total Budget','Total Impressions','Blended CPM']);
    tiers.forEach(function(t){
      var totBgt=lines.reduce(function(s,ln){return s+(Number(ln.budgets[t.id]||0));},0);
      var totImpr=lines.reduce(function(s,ln){var b=Number(ln.budgets[t.id]||0);return s+(ln.cpm>0&&b>0?Math.round(b/ln.cpm*1000):0);},0);
      var blendCPM=totImpr>0?(totBgt/(totImpr/1000)):0;
      sum.push([t.label,totBgt,totImpr,blendCPM]);
    });
    sum.push([]); sum.push(['Flight:',flight]); sum.push(['Geography:',geo.split('\n').slice(0,3).join(', ')]); sum.push(['Primary KPI:',kpi]); sum.push(['Website:',website]); sum.push(['Date:',today]);
    var wsSummary=XLSX.utils.aoa_to_sheet(sum);
    wsSummary['!cols']=[{wch:20},{wch:16},{wch:18},{wch:14}];
    XLSX.utils.book_append_sheet(wb,wsSummary,'Summary');

    var fname=client.replace(/[^a-zA-Z0-9 ]/g,'_').replace(/\s+/g,'_')+'_Media_Plan_'+today+'.xlsx';
    XLSX.writeFile(wb,fname);
    toast('Excel file downloaded!','ok');
  };
  s.onerror=function(){ toast('Could not load Excel library. Check network.','err'); };
  document.head.appendChild(s);
}


// ‚îÄ‚îÄ‚îÄ AI KNOWLEDGE BASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var kbInited=false;
function initKB(){
  if(kbInited)return; kbInited=true;
  var saved=lsGet('sc4_kb');
  if(saved){
    if(saved.products&&document.getElementById('kb-products')) document.getElementById('kb-products').value=saved.products;
    if(saved.territory&&document.getElementById('kb-territory')) document.getElementById('kb-territory').value=saved.territory;
    if(saved.verticals&&document.getElementById('kb-verticals')) document.getElementById('kb-verticals').value=saved.verticals;
    if(saved.other&&document.getElementById('kb-other')) document.getElementById('kb-other').value=saved.other;
  }
}

function saveKB(){
  var data={
    products:(document.getElementById('kb-products')||{}).value||'',
    territory:(document.getElementById('kb-territory')||{}).value||'',
    verticals:(document.getElementById('kb-verticals')||{}).value||'',
    other:(document.getElementById('kb-other')||{}).value||''
  };
  lsSet('sc4_kb',data);
  toast('Knowledge base saved','ok');
}

function getKBText(){
  return [
    '=== PRODUCTS & CAPABILITIES ===\n'+((document.getElementById('kb-products')||{}).value||''),
    '=== TERRITORY & MARKET INFO ===\n'+((document.getElementById('kb-territory')||{}).value||''),
    '=== VERTICALS & SALES NOTES ===\n'+((document.getElementById('kb-verticals')||{}).value||''),
    '=== OTHER REFERENCE INFO ===\n'+((document.getElementById('kb-other')||{}).value||'')
  ].join('\n\n');
}

function quickAsk(q){ var el=document.getElementById('kb-q'); if(el){el.value=q;} askKB(); }

function askKB(){
  var qEl=document.getElementById('kb-q'); if(!qEl)return;
  var q=qEl.value.trim(); if(!q)return;
  var log=document.getElementById('kb-chat-log'); if(!log)return;
  qEl.value='';

  // Append user message
  log.innerHTML+='<div style="margin-bottom:10px;"><div style="font-family:var(--mono);font-size:.6rem;color:var(--t2);margin-bottom:2px;">YOU</div><div style="background:var(--s2);border-radius:4px;padding:8px 10px;font-size:.78rem;color:var(--white)">'+escH(q)+'</div></div>';
  var loadId='kbl'+uid();
  log.innerHTML+='<div id="'+loadId+'" style="margin-bottom:10px;"><div style="font-family:var(--mono);font-size:.6rem;color:var(--green);margin-bottom:2px;">‚ú¶ ASSISTANT</div><div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:8px 10px;font-size:.78rem;color:var(--t2);font-style:italic;">Thinking...</div></div>';
  log.scrollTop=log.scrollHeight;

  var kb=getKBText();
  var systemPrompt='You are a knowledgeable digital advertising assistant for a Simpli.fi Sales Director covering East Tennessee. You have access to their internal knowledge base below. Answer concisely and practically. When relevant, cite specific products, CPMs, or tactics from the knowledge base. Be direct ‚Äî this person is a sales professional who needs fast, actionable answers.\n\nKNOWLEDGE BASE:\n'+kb;

  fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,system:systemPrompt,messages:[{role:'user',content:q}]})})
  .then(function(r){return r.json();})
  .then(function(data){
    var text=(data.content&&data.content[0]&&data.content[0].text)||'No response.';
    var el=document.getElementById(loadId);
    if(el) el.querySelector('div:last-child').innerHTML='<span style="color:var(--white);font-style:normal">'+text.replace(/\n/g,'<br>')+'</span>';
    log.scrollTop=log.scrollHeight;
  })
  .catch(function(e){
    var el=document.getElementById(loadId);
    if(el) el.querySelector('div:last-child').textContent='Error: '+e.message;
  });
}

function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }



// ‚îÄ‚îÄ‚îÄ ACCOUNT HUB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var accounts=[];
var activeAccountId=null;
var ioLines=[];
var actOmniLines=[];

function seedAccounts(){
  return [
    {id:uid(),name:'F Street Investments',orgId:'556090',contact:'Peter Studer',email:'peter@fstreet.com',phone:'2628930355',vertical:'Finance / Banking',status:'active',startDate:'2026-01-27',notes:'Open IO client. Flexible spend ‚Äî started at $2,500/mo, growing.',ios:[{id:uid(),type:'open',name:'F Street Annual Open IO',total:75000,ioDate:'2026-01-27',start:'2026-02-01',end:'2026-12-31',docId:'80EC3DCA-3BD3-4487-A33E-D15304DDD4F0',status:'active',lines:[{desc:'DISPLAY',targeting:'ALL TACTICS',imps:9375000,cpm:4,cost:37500,tacticType:'prog'},{desc:'VIDEO',targeting:'ALL TACTICS',imps:3125000,cpm:12,cost:37500,tacticType:'prog'}]}],actuals:[{month:1,year:2026,progGross:1179.02,progNet:1016.55,omni:[]}],history:[{date:dAgo(23),type:'io',note:'Signed Open IO ‚Äî $75K credit limit, Display + Video'},{date:dAgo(23),type:'call',note:'Onboarding call with Peter. Starting small at $2,500/mo to test.'}]},
    {id:uid(),name:'Friendship Automotive Group',orgId:'445236',contact:'',email:'',phone:'',vertical:'Automotive',status:'active',startDate:'2025-01-01',notes:'Largest account. Y-O-Y down 40% ‚Äî need to protect and grow.',ios:[],actuals:[{month:1,year:2026,progGross:26431.85,progNet:14077.88,omni:[]},{month:2,year:2026,progGross:12104.14,progNet:6063.56,omni:[]}],history:[{date:dAgo(3),type:'note',note:'Feb pacing slower than Jan. Check with CS on delivery.'}]},
    {id:uid(),name:'Knoxville Wholesale Furniture',orgId:'558440',contact:'',email:'',phone:'',vertical:'Retail',status:'active',startDate:'2025-06-01',notes:'Strong account, 30% M-O-M growth.',ios:[],actuals:[{month:1,year:2026,progGross:22994.70,progNet:14292.08,omni:[]},{month:2,year:2026,progGross:14690.57,progNet:8721.18,omni:[]}],history:[]},
    {id:uid(),name:'The Jenkins Agency',orgId:'553083',contact:'',email:'',phone:'',vertical:'Other',status:'active',startDate:'2025-01-01',notes:'Agency partner ‚Äî manages multiple sub-clients.',ios:[],actuals:[{month:1,year:2026,progGross:11560.61,progNet:6760.48,omni:[]},{month:2,year:2026,progGross:6350.06,progNet:3718.10,omni:[]}],history:[]},
    {id:uid(),name:'Clearwater Plumbing LLC',orgId:'548862',contact:'',email:'',phone:'',vertical:'Home Services',status:'active',startDate:'2025-01-01',notes:'High margin account (73%). Down 72% M-O-M ‚Äî follow up.',ios:[],actuals:[{month:1,year:2026,progGross:6300.68,progNet:4599.37,omni:[]},{month:2,year:2026,progGross:924.99,progNet:672.91,omni:[]}],history:[]},
    {id:uid(),name:'Apex Bank',orgId:'535591',contact:'',email:'',phone:'',vertical:'Finance / Banking',status:'active',startDate:'2025-01-01',notes:'1,949% M-O-M growth ‚Äî new campaign launched.',ios:[],actuals:[{month:1,year:2026,progGross:799.59,progNet:625.25,omni:[]},{month:2,year:2026,progGross:984.44,progNet:788.29,omni:[]}],history:[]}
  ];
}

function initAccounts(){
  accounts=lsGet('sc4_accounts')||seedAccounts();
  renderAccountList();
}

function saveAccounts(){ lsSet('sc4_accounts',accounts); }

function renderAccountList(){
  var el=document.getElementById('acct-list'); if(!el)return;
  var q=(document.getElementById('acct-search')||{}).value||'';
  var filtered=accounts.filter(function(a){ return !q||a.name.toLowerCase().includes(q.toLowerCase())||a.orgId.includes(q); });
  if(!filtered.length){ el.innerHTML='<div style="padding:16px;text-align:center;color:var(--t3);font-size:.75rem;">No accounts found</div>'; return; }
  var html='';
  filtered.forEach(function(a){
    var isActive=a.id===activeAccountId;
    var statusColor=a.status==='active'?'var(--green)':a.status==='pending'?'var(--yellow)':'var(--t3)';
    var latestActual=getLatestActual(a);
    var mtdComm=latestActual?calcCommission(latestActual):0;
    html+='<div onclick="selectAccount(\''+a.id+'\')" style="padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;background:'+(isActive?'var(--s2)':'transparent')+';transition:background .15s;">';
    html+='<div style="display:flex;justify-content:space-between;align-items:flex-start;">';
    html+='<div style="font-size:.78rem;color:var(--white);font-weight:'+(isActive?'600':'400')+';line-height:1.3;">'+escH(a.name)+'</div>';
    html+='<div style="font-size:.6rem;color:'+statusColor+';margin-left:6px;white-space:nowrap;">'+a.status+'</div></div>';
    html+='<div style="display:flex;justify-content:space-between;margin-top:3px;">';
    html+='<div style="font-size:.65rem;color:var(--t3);">'+escH(a.vertical||'')+(a.orgId?' ¬∑ ID:'+a.orgId:'')+'</div>';
    html+='<div style="font-size:.65rem;color:var(--green);">'+(mtdComm?'$'+mtdComm.toFixed(0)+' comm':'')+'</div></div>';
    html+='</div>';
  });
  el.innerHTML=html;
}

function selectAccount(id){
  activeAccountId=id;
  renderAccountList();
  renderAccountDetail(id);
}

function getLatestActual(a){
  if(!a.actuals||!a.actuals.length)return null;
  return a.actuals.sort(function(x,y){return (y.year*12+y.month)-(x.year*12+x.month);})[0];
}

function calcCommission(actual){
  if(!actual)return 0;
  var progComm=(actual.progNet||0)*0.12;
  var omniComm=(actual.omni||[]).reduce(function(s,o){return s+(o.gross||0)*0.35*0.12;},0);
  return progComm+omniComm;
}

function renderAccountDetail(id){
  var a=accounts.find(function(x){return x.id===id;}); if(!a)return;
  var el=document.getElementById('acct-detail'); if(!el)return;

  // Commission totals
  var totalComm2026=(a.actuals||[]).filter(function(x){return x.year===2026;}).reduce(function(s,x){return s+calcCommission(x);},0);
  var totalGross2026=(a.actuals||[]).filter(function(x){return x.year===2026;}).reduce(function(s,x){return s+(x.progGross||0)+(x.omni||[]).reduce(function(os,o){return os+(o.gross||0);},0);},0);

  // IO summary
  var activeIOs=(a.ios||[]).filter(function(i){return i.status==='active';});
  var totalIOValue=activeIOs.reduce(function(s,i){return s+(i.total||0);},0);
  var totalSpentUnderIO=(a.actuals||[]).reduce(function(s,x){return s+(x.progGross||0)+(x.omni||[]).reduce(function(os,o){return os+(o.gross||0);},0);},0);

  var html='';

  // HEADER CARD
  html+='<div class="card" style="margin-bottom:12px;">';
  html+='<div class="ch"><span class="ct" style="font-size:1rem;">'+escH(a.name)+'</span>';
  html+='<span style="font-family:var(--mono);font-size:.6rem;color:var(--t3);margin-left:8px;">'+escH(a.vertical||'')+(a.orgId?' ¬∑ Billing Org: '+a.orgId:'')+'</span>';
  html+='<div style="margin-left:auto;display:flex;gap:6px;">';
  html+='<button class="btn btn-sm" onclick="editAccount(\''+id+'\')">‚úé Edit</button>';
  html+='<button class="btn btn-sm" onclick="addHistoryNote(\''+id+'\')">+ Note</button>';
  html+='<button class="btn btn-sm btn-danger" onclick="deleteAccount(\''+id+'\')">‚úï</button>';
  html+='</div></div>';
  html+='<div class="cb"><div class="sg s4" style="margin:0;">';
  html+='<div class="stat"><div class="sl">2026 Gross Spend</div><div class="sv">'+fmtM(totalGross2026)+'</div><div class="ss">all tactics YTD</div></div>';
  html+='<div class="stat"><div class="sl">2026 Commission</div><div class="sv" style="color:var(--green);">'+fmtM(totalComm2026)+'</div><div class="ss">your 12% YTD</div></div>';
  html+='<div class="stat"><div class="sl">Active IOs</div><div class="sv" style="color:var(--yellow);">'+activeIOs.length+'</div><div class="ss">'+fmtM(totalIOValue)+' total value</div></div>';
  html+='<div class="stat"><div class="sl">Client Since</div><div class="sv" style="font-size:.9rem;">'+(a.startDate?new Date(a.startDate).toLocaleDateString('en-US',{month:'short',year:'numeric'}):'‚Äî')+'</div><div class="ss">relationship start</div></div>';
  html+='</div></div></div>';

  // TABS
  html+='<div style="display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border);">';
  ['ios','pacing','history','inbox'].forEach(function(tab,i){
    var labels={ios:'üìÑ IOs',pacing:'üìä Pacing & Billing',history:'üïê History',inbox:'‚úâ Emails'};
    html+='<button onclick="showAcctTab(\''+id+'\',\''+tab+'\')" id="acct-tab-'+tab+'" style="padding:8px 16px;background:none;border:none;border-bottom:2px solid '+(i===0?'var(--white)':'transparent')+';color:'+(i===0?'var(--white)':'var(--t2)')+';font-size:.75rem;cursor:pointer;font-family:var(--mono);">'+labels[tab]+'</button>';
  });
  html+='</div>';
  html+='<div id="acct-tab-content"></div>';

  el.innerHTML=html;
  renderAcctTab(id,'ios');
}

function showAcctTab(id,tab){
  ['ios','pacing','history','inbox'].forEach(function(t){
    var el=document.getElementById('acct-tab-'+t); if(!el)return;
    el.style.borderBottomColor=t===tab?'var(--white)':'transparent';
    el.style.color=t===tab?'var(--white)':'var(--t2)';
  });
  renderAcctTab(id,tab);
}

function renderAcctTab(id,tab){
  var a=accounts.find(function(x){return x.id===id;}); if(!a)return;
  var el=document.getElementById('acct-tab-content'); if(!el)return;
  if(tab==='ios') el.innerHTML=renderIOsTab(a);
  else if(tab==='pacing') el.innerHTML=renderPacingTab(a);
  else if(tab==='history') el.innerHTML=renderHistoryTab(a);
  else if(tab==='inbox') el.innerHTML=renderInboxTab(a);
}

function renderIOsTab(a){
  var html='<div style="display:flex;justify-content:flex-end;margin-bottom:10px;"><button class="btn btn-sm btn-w" onclick="openNewIO(\''+a.id+'\')">+ Add IO</button></div>';
  if(!a.ios||!a.ios.length) return html+'<div class="card" style="text-align:center;padding:24px;color:var(--t3);font-size:.78rem;">No IOs on file. Click + Add IO to log one.</div>';
  a.ios.forEach(function(io){
    var typeColor=io.type==='open'?'var(--yellow)':'var(--green)';
    var typeLabel=io.type==='open'?'OPEN IO':'CAMPAIGN IO';
    var totalSpent=(a.actuals||[]).reduce(function(s,x){return s+(x.progGross||0)+(x.omni||[]).reduce(function(os,o){return os+(o.gross||0);},0);},0);
    var pctUsed=io.total>0?Math.min(100,(totalSpent/io.total*100)):0;
    html+='<div class="card" style="margin-bottom:10px;">';
    html+='<div class="ch"><span class="ct">'+escH(io.name||'IO')+'</span>';
    html+='<span style="font-family:var(--mono);font-size:.6rem;color:'+typeColor+';margin-left:8px;border:1px solid '+typeColor+';padding:1px 6px;border-radius:3px;">'+typeLabel+'</span>';
    html+='<span style="font-family:var(--mono);font-size:.6rem;color:var(--t3);margin-left:8px;">'+escH(io.status||'')+'</span>';
    html+='<div style="margin-left:auto;display:flex;gap:6px;"><button class="btn btn-sm" onclick="editIO(\''+a.id+'\',\''+io.id+'\')">‚úé</button><button class="btn btn-sm btn-danger" onclick="deleteIO(\''+a.id+'\',\''+io.id+'\')">‚úï</button></div></div>';
    html+='<div class="cb">';
    // IO summary stats
    html+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;">';
    html+='<div><div style="font-size:.6rem;color:var(--t3);font-family:var(--mono);">TOTAL VALUE</div><div style="font-size:.9rem;color:var(--white);font-weight:600;">'+fmtM(io.total||0)+'</div></div>';
    html+='<div><div style="font-size:.6rem;color:var(--t3);font-family:var(--mono);">IO DATE</div><div style="font-size:.8rem;color:var(--white);">'+(io.ioDate?new Date(io.ioDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî')+'</div></div>';
    html+='<div><div style="font-size:.6rem;color:var(--t3);font-family:var(--mono);">FLIGHT</div><div style="font-size:.75rem;color:var(--white);">'+(io.start||'?')+' ‚Üí '+(io.end||'?')+'</div></div>';
    if(io.type==='open'){
      html+='<div><div style="font-size:.6rem;color:var(--t3);font-family:var(--mono);">CREDIT USED</div><div style="font-size:.8rem;color:var(--yellow);">'+pctUsed.toFixed(1)+'%</div></div>';
      html+='</div>';
      // Progress bar
      html+='<div style="background:var(--s2);border-radius:4px;height:6px;margin-bottom:12px;"><div style="background:var(--yellow);height:6px;border-radius:4px;width:'+pctUsed+'%;transition:width .3s;"></div></div>';
      html+='<div style="font-size:.7rem;color:var(--t3);">'+fmtM(totalSpent)+' spent of '+fmtM(io.total)+' credit limit. Remaining: '+fmtM(Math.max(0,(io.total||0)-totalSpent))+'</div>';
    } else {
      html+='</div>';
    }
    // Tactic lines
    if(io.lines&&io.lines.length){
      html+='<div style="margin-top:12px;"><div style="font-family:var(--mono);font-size:.6rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">Tactic Lines</div>';
      html+='<table class="tbl" style="font-size:.72rem;"><thead><tr><th class="left">Tactic</th><th class="left">Targeting</th><th>Type</th><th>Impressions</th><th>CPM</th><th>Media Cost</th></tr></thead><tbody>';
      io.lines.forEach(function(ln){
        var tc=ln.tacticType==='omni'?'var(--blue)':'var(--green)';
        html+='<tr><td class="left">'+escH(ln.desc||'')+'</td><td class="left" style="color:var(--t2);">'+escH(ln.targeting||'')+'</td>';
        html+='<td><span style="font-size:.6rem;color:'+tc+';border:1px solid '+tc+';padding:1px 5px;border-radius:3px;">'+(ln.tacticType==='omni'?'OMNI':'PROG')+'</span></td>';
        html+='<td>'+(ln.imps?(Number(ln.imps)).toLocaleString():'‚Äî')+'</td><td>$'+(ln.cpm||0)+'</td><td style="color:var(--yellow);">'+fmtM(ln.cost||0)+'</td></tr>';
      });
      var lineTotal=io.lines.reduce(function(s,l){return s+(l.cost||0);},0);
      html+='<tr class="total-row"><td colspan="5" class="left">TOTAL</td><td style="color:var(--yellow);font-weight:600;">'+fmtM(lineTotal)+'</td></tr>';
      html+='</tbody></table></div>';
    }
    if(io.docId) html+='<div style="margin-top:8px;font-size:.65rem;color:var(--t3);">DocuSign ID: '+escH(io.docId)+'</div>';
    html+='</div></div>';
  });
  return html;
}

function renderPacingTab(a){
  var html='<div style="display:flex;justify-content:flex-end;margin-bottom:10px;gap:6px;">';
  html+='<button class="btn btn-sm btn-w" onclick="openActuals(\''+a.id+'\')">+ Log Monthly Actuals</button>';
  html+='</div>';
  if(!a.actuals||!a.actuals.length) return html+'<div class="card" style="text-align:center;padding:24px;color:var(--t3);font-size:.78rem;">No actuals logged yet. Click + Log Monthly Actuals to enter numbers from Looker.</div>';

  html+='<div class="card"><div class="cb" style="padding:0;overflow-x:auto;"><table class="tbl" style="font-size:.75rem;">';
  html+='<thead><tr><th class="left">Month</th><th>Prog Gross</th><th>Prog Net (Looker)</th><th>Prog Margin %</th><th>Omni Gross</th><th>Omni Mgmt Fee</th><th style="color:var(--green);">Your Commission</th><th></th></tr></thead><tbody>';

  var sortedActuals=(a.actuals||[]).slice().sort(function(x,y){return (y.year*12+y.month)-(x.year*12+x.month);});
  var yearComm={}; var yearGross={};
  sortedActuals.forEach(function(act){
    var omniGross=(act.omni||[]).reduce(function(s,o){return s+(o.gross||0);},0);
    var omniMgmt=omniGross*0.35;
    var comm=calcCommission(act);
    var pct=act.progGross>0?((act.progNet/act.progGross)*100):0;
    var monthLabel=MONTHS[act.month]+' '+act.year;
    yearComm[act.year]=(yearComm[act.year]||0)+comm;
    yearGross[act.year]=(yearGross[act.year]||0)+(act.progGross||0)+omniGross;
    html+='<tr>';
    html+='<td class="left" style="font-weight:500;">'+monthLabel+'</td>';
    html+='<td>'+fmtM(act.progGross||0)+'</td>';
    html+='<td>'+fmtM(act.progNet||0)+'</td>';
    html+='<td style="color:'+(pct>=55?'var(--green)':pct>=45?'var(--yellow)':'var(--red)')+';">'+(act.progGross>0?pct.toFixed(0)+'%':'‚Äî')+'</td>';
    html+='<td>'+(omniGross?fmtM(omniGross):'‚Äî')+'</td>';
    html+='<td>'+(omniMgmt?fmtM(omniMgmt):'‚Äî')+'</td>';
    html+='<td style="color:var(--green);font-weight:600;">$'+comm.toFixed(2)+'</td>';
    html+='<td><button class="btn btn-sm btn-danger" style="font-size:.55rem;" onclick="deleteActual(\''+a.id+'\','+act.month+','+act.year+')">‚úï</button></td>';
    html+='</tr>';
  });
  html+='</tbody></table></div>';

  // YTD summary
  html+='<div class="ch" style="border-top:1px solid var(--border);"><span class="ct">YTD Summary</span></div>';
  html+='<div class="cb"><div class="sg s3" style="margin:0;">';
  Object.keys(yearGross).sort().reverse().forEach(function(yr){
    html+='<div class="stat"><div class="sl">'+yr+' Gross</div><div class="sv">'+fmtM(yearGross[yr])+'</div></div>';
    html+='<div class="stat"><div class="sl">'+yr+' Commission</div><div class="sv" style="color:var(--green);">'+fmtM(yearComm[yr])+'</div></div>';
  });
  html+='</div></div></div>';
  return html;
}

function renderHistoryTab(a){
  var html='<div style="display:flex;justify-content:flex-end;margin-bottom:10px;"><button class="btn btn-sm" onclick="addHistoryNote(\''+a.id+'\')">+ Add Note</button></div>';
  var hist=(a.history||[]).slice().sort(function(x,y){return new Date(y.date)-new Date(x.date);});
  if(!hist.length) return html+'<div class="card" style="text-align:center;padding:24px;color:var(--t3);font-size:.78rem;">No history yet. Notes, emails, and IO events will appear here.</div>';
  html+='<div class="card"><div class="cb" style="padding:0;">';
  hist.forEach(function(h,i){
    var typeIcon={io:'üìÑ',call:'üìû',email:'‚úâ',note:'üìù',alert:'üî¥',ai:'‚ú¶'}[h.type]||'üìù';
    var typeColor={io:'var(--yellow)',call:'var(--green)',email:'var(--blue)',note:'var(--t2)',alert:'var(--red)',ai:'var(--purple)'}[h.type]||'var(--t2)';
    html+='<div style="padding:12px 14px;border-bottom:'+(i<hist.length-1?'1px solid var(--border)':'none')+';display:flex;gap:10px;">';
    html+='<div style="font-size:1rem;margin-top:1px;">'+typeIcon+'</div>';
    html+='<div style="flex:1;">';
    html+='<div style="font-size:.72rem;color:var(--t3);margin-bottom:3px;">'+new Date(h.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'})+'</div>';
    html+='<div style="font-size:.78rem;color:var(--white);line-height:1.5;">'+escH(h.note||'')+'</div>';
    html+='</div></div>';
  });
  html+='</div></div>';
  return html;
}

function renderInboxTab(a){
  var html='<div class="card">';
  html+='<div class="ch"><span class="ct">Email History ‚Äî '+escH(a.name)+'</span><button class="btn btn-sm" onclick="pasteEmailForAccount(\''+a.id+'\')" style="margin-left:auto;">+ Paste Email</button></div>';
  html+='<div class="cb">';
  var emailHistory=(a.history||[]).filter(function(h){return h.type==='email'||h.type==='ai';});
  if(!emailHistory.length){
    html+='<div style="text-align:center;padding:20px;color:var(--t3);font-size:.78rem;">No emails logged yet.<br>Paste emails using the <strong style="color:var(--white)">‚ú¶ Paste Emails</strong> button at the top, or paste directly for this account.</div>';
  } else {
    emailHistory.slice().sort(function(x,y){return new Date(y.date)-new Date(x.date);}).forEach(function(h){
      html+='<div style="padding:10px 0;border-bottom:1px solid var(--border);">';
      html+='<div style="font-size:.65rem;color:var(--t3);">'+new Date(h.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+'</div>';
      html+='<div style="font-size:.78rem;color:var(--white);margin-top:3px;line-height:1.5;">'+escH(h.note)+'</div>';
      html+='</div>';
    });
  }
  html+='</div></div>';
  return html;
}

// Account CRUD
function openNewAccount(){
  document.getElementById('m-account-title').textContent='New Account';
  document.getElementById('ac-id').value='';
  ['ac-name','ac-orgid','ac-contact','ac-email','ac-phone','ac-notes'].forEach(function(id){ var el=document.getElementById(id); if(el)el.value=''; });
  document.getElementById('ac-status').value='active';
  openM('m-account');
}

function editAccount(id){
  var a=accounts.find(function(x){return x.id===id;}); if(!a)return;
  document.getElementById('m-account-title').textContent='Edit Account';
  document.getElementById('ac-id').value=a.id;
  document.getElementById('ac-name').value=a.name||'';
  document.getElementById('ac-orgid').value=a.orgId||'';
  document.getElementById('ac-contact').value=a.contact||'';
  document.getElementById('ac-email').value=a.email||'';
  document.getElementById('ac-phone').value=a.phone||'';
  document.getElementById('ac-notes').value=a.notes||'';
  document.getElementById('ac-status').value=a.status||'active';
  document.getElementById('ac-vertical').value=a.vertical||'Other';
  if(a.startDate) document.getElementById('ac-start').value=a.startDate;
  openM('m-account');
}

function saveAccount(){
  var id=document.getElementById('ac-id').value;
  var name=document.getElementById('ac-name').value.trim();
  if(!name){toast('Account name required','err');return;}
  if(id){
    var a=accounts.find(function(x){return x.id===id;}); if(!a)return;
    a.name=name; a.orgId=document.getElementById('ac-orgid').value.trim();
    a.contact=document.getElementById('ac-contact').value.trim();
    a.email=document.getElementById('ac-email').value.trim();
    a.phone=document.getElementById('ac-phone').value.trim();
    a.notes=document.getElementById('ac-notes').value.trim();
    a.status=document.getElementById('ac-status').value;
    a.vertical=document.getElementById('ac-vertical').value;
    a.startDate=document.getElementById('ac-start').value;
  } else {
    accounts.push({id:uid(),name:name,orgId:document.getElementById('ac-orgid').value.trim(),contact:document.getElementById('ac-contact').value.trim(),email:document.getElementById('ac-email').value.trim(),phone:document.getElementById('ac-phone').value.trim(),vertical:document.getElementById('ac-vertical').value,status:document.getElementById('ac-status').value,startDate:document.getElementById('ac-start').value,notes:document.getElementById('ac-notes').value.trim(),ios:[],actuals:[],history:[]});
  }
  saveAccounts(); closeM('m-account'); renderAccountList();
  if(id) renderAccountDetail(id);
  toast(id?'Account updated':'Account created','ok');
}

function deleteAccount(id){
  if(!confirm('Delete this account and all its data?'))return;
  accounts=accounts.filter(function(x){return x.id!==id;});
  activeAccountId=null;
  document.getElementById('acct-detail').innerHTML='<div class="card" style="text-align:center;padding:40px;color:var(--t3);"><div style="font-size:2rem;margin-bottom:12px;">‚óâ</div><div style="font-family:var(--mono);font-size:.75rem;">Select an account to view details</div></div>';
  saveAccounts(); renderAccountList(); toast('Deleted','err');
}

// IO Management
function openNewIO(acctId){
  document.getElementById('m-io-title').textContent='Add Insertion Order';
  document.getElementById('io-acct-id').value=acctId;
  document.getElementById('io-id').value='';
  ['io-name','io-total','io-date','io-start','io-end','io-docid'].forEach(function(id){var el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('io-type').value='open';
  document.getElementById('io-status').value='active';
  ioLines=[];
  renderIOLines();
  renderIOTypeHint();
  openM('m-io');
}

function editIO(acctId,ioId){
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  var io=(a.ios||[]).find(function(x){return x.id===ioId;}); if(!io)return;
  document.getElementById('m-io-title').textContent='Edit IO';
  document.getElementById('io-acct-id').value=acctId;
  document.getElementById('io-id').value=ioId;
  document.getElementById('io-type').value=io.type||'open';
  document.getElementById('io-name').value=io.name||'';
  document.getElementById('io-total').value=io.total||'';
  document.getElementById('io-date').value=io.ioDate||'';
  document.getElementById('io-start').value=io.start||'';
  document.getElementById('io-end').value=io.end||'';
  document.getElementById('io-docid').value=io.docId||'';
  document.getElementById('io-status').value=io.status||'active';
  ioLines=JSON.parse(JSON.stringify(io.lines||[]));
  renderIOLines(); renderIOTypeHint(); openM('m-io');
}

function renderIOTypeHint(){
  var t=document.getElementById('io-type').value;
  var el=document.getElementById('io-type-hint');
  if(el) el.textContent=t==='open'?'Open IO: Credit limit only ‚Äî actual monthly spend will vary. Great for long-term relationships with flexible budgets.':'Campaign IO: Exact tactic lines below must match what runs. Pacing tracked against these numbers.';
}

function addIOLine(){
  ioLines.push({id:uid(),desc:'DISPLAY',targeting:'ALL TACTICS',imps:'',cpm:'',cost:'',tacticType:'prog'});
  renderIOLines();
}

function renderIOLines(){
  var el=document.getElementById('io-lines'); if(!el)return;
  if(!ioLines.length){el.innerHTML='<div style="color:var(--t3);font-size:.72rem;padding:6px 0;">No tactic lines yet.</div>';return;}
  var html='';
  ioLines.forEach(function(ln){
    html+='<div style="display:grid;grid-template-columns:1fr 1fr auto auto auto auto auto;gap:6px;align-items:center;margin-bottom:6px;">';
    html+='<input class="fi" style="font-size:.72rem;" value="'+escH(ln.desc)+'" placeholder="DISPLAY/VIDEO/CTV..." onchange="ioLineField(\''+ln.id+'\',\'desc\',this.value)">';
    html+='<input class="fi" style="font-size:.72rem;" value="'+escH(ln.targeting)+'" placeholder="Targeting" onchange="ioLineField(\''+ln.id+'\',\'targeting\',this.value)">';
    html+='<select class="fs" style="font-size:.65rem;width:70px;" onchange="ioLineField(\''+ln.id+'\',\'tacticType\',this.value)"><option value="prog"'+(ln.tacticType==='prog'?' selected':'')+'>PROG</option><option value="omni"'+(ln.tacticType==='omni'?' selected':'')+'>OMNI</option></select>';
    html+='<input class="fi" style="font-size:.72rem;width:90px;" value="'+(ln.imps||'')+'" placeholder="Imps" onchange="ioLineField(\''+ln.id+'\',\'imps\',this.value)">';
    html+='<input class="fi" style="font-size:.72rem;width:65px;" value="'+(ln.cpm||'')+'" placeholder="CPM" onchange="ioLineField(\''+ln.id+'\',\'cpm\',this.value)">';
    html+='<input class="fi" style="font-size:.72rem;width:90px;" value="'+(ln.cost||'')+'" placeholder="Cost" onchange="ioLineField(\''+ln.id+'\',\'cost\',this.value)">';
    html+='<button class="btn btn-sm btn-danger" onclick="removeIOLine(\''+ln.id+'\')">‚úï</button>';
    html+='</div>';
  });
  el.innerHTML=html;
}

function ioLineField(id,field,val){ var ln=ioLines.find(function(x){return x.id===id;}); if(ln)ln[field]=val; }
function removeIOLine(id){ ioLines=ioLines.filter(function(x){return x.id!==id;}); renderIOLines(); }

function saveIO(){
  var acctId=document.getElementById('io-acct-id').value;
  var ioId=document.getElementById('io-id').value;
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  var io={id:ioId||uid(),type:document.getElementById('io-type').value,name:document.getElementById('io-name').value.trim(),total:parseFloat(document.getElementById('io-total').value)||0,ioDate:document.getElementById('io-date').value,start:document.getElementById('io-start').value,end:document.getElementById('io-end').value,docId:document.getElementById('io-docid').value.trim(),status:document.getElementById('io-status').value,lines:JSON.parse(JSON.stringify(ioLines))};
  if(!a.ios)a.ios=[];
  if(ioId){ var idx=a.ios.findIndex(function(x){return x.id===ioId;}); if(idx>=0)a.ios[idx]=io; else a.ios.push(io); }
  else { a.ios.push(io); a.history=a.history||[]; a.history.push({date:new Date().toISOString(),type:'io',note:'IO logged: '+io.name+' ‚Äî '+fmtM(io.total)+' ('+(io.type==='open'?'Open IO':'Campaign IO')+')'}); }
  saveAccounts(); closeM('m-io'); renderAccountDetail(acctId); toast('IO saved','ok');
}

function deleteIO(acctId,ioId){
  if(!confirm('Delete this IO?'))return;
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  a.ios=(a.ios||[]).filter(function(x){return x.id!==ioId;});
  saveAccounts(); renderAccountDetail(acctId); toast('IO deleted','err');
}

// Actuals
function openActuals(acctId){
  document.getElementById('act-acct-id').value=acctId;
  var now=new Date();
  document.getElementById('act-month').value=now.getMonth();
  document.getElementById('act-year').value=now.getFullYear();
  document.getElementById('act-prog-gross').value='';
  document.getElementById('act-prog-net').value='';
  document.getElementById('act-looker-paste').value='';
  actOmniLines=[];
  renderActOmniLines();
  updateCommPreview();
  openM('m-actuals');
}

function parseLookerPaste(){
  var raw=document.getElementById('act-looker-paste').value;
  var nums=raw.match(/\$[\d,]+\.?\d*/g);
  if(nums&&nums.length>=2){
    var gross=parseFloat(nums[0].replace(/[$,]/g,''));
    var net=parseFloat(nums[1].replace(/[$,]/g,''));
    document.getElementById('act-prog-gross').value=gross;
    document.getElementById('act-prog-net').value=net;
    updateCommPreview();
  }
}

function addActualOmniLine(){
  actOmniLines.push({id:uid(),tactic:'YouTube',gross:0});
  renderActOmniLines();
}

function renderActOmniLines(){
  var el=document.getElementById('act-omni-lines'); if(!el)return;
  if(!actOmniLines.length){el.innerHTML='<div style="color:var(--t3);font-size:.72rem;padding:4px 0;">No Omni spend this month ‚Äî add if client ran YouTube, Netflix, SEM, Meta, DOOH, etc.</div>';return;}
  var omniTactics=['YouTube','YouTube TV','Netflix','Meta (Facebook/Instagram)','Google SEM','LinkedIn','DOOH','Other'];
  var html='';
  actOmniLines.forEach(function(ln){
    html+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">';
    html+='<select class="fs" style="flex:1;" onchange="omniLineField(\''+ln.id+'\',\'tactic\',this.value)">';
    omniTactics.forEach(function(t){html+='<option'+(ln.tactic===t?' selected':'')+'>'+t+'</option>';});
    html+='</select>';
    html+='<input class="fi" style="width:120px;" value="'+(ln.gross||'')+'" placeholder="Gross spend" type="number" onchange="omniLineField(\''+ln.id+'\',\'gross\',parseFloat(this.value)||0);updateCommPreview()">';
    html+='<button class="btn btn-sm btn-danger" onclick="removeOmniLine(\''+ln.id+'\')">‚úï</button>';
    html+='</div>';
  });
  el.innerHTML=html;
}

function omniLineField(id,field,val){ var ln=actOmniLines.find(function(x){return x.id===id;}); if(ln)ln[field]=val; }
function removeOmniLine(id){ actOmniLines=actOmniLines.filter(function(x){return x.id!==id;}); renderActOmniLines(); updateCommPreview(); }

function updateCommPreview(){
  var progGross=parseFloat(document.getElementById('act-prog-gross').value)||0;
  var progNet=parseFloat(document.getElementById('act-prog-net').value)||0;
  var omniGross=actOmniLines.reduce(function(s,o){return s+(o.gross||0);},0);
  var omniMgmt=omniGross*0.35;
  var progComm=progNet*0.12;
  var omniComm=omniMgmt*0.12;
  var total=progComm+omniComm;
  var el=document.getElementById('act-comm-preview'); if(!el)return;
  el.innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">'
    +'<div><div style="font-size:.6rem;color:var(--t3);">PROG COMMISSION</div><div style="color:var(--green);">$'+progComm.toFixed(2)+'</div><div style="font-size:.6rem;color:var(--t3);">'+fmtM(progNet)+' net √ó 12%</div></div>'
    +'<div><div style="font-size:.6rem;color:var(--t3);">OMNI COMMISSION</div><div style="color:var(--blue);">$'+omniComm.toFixed(2)+'</div><div style="font-size:.6rem;color:var(--t3);">'+fmtM(omniGross)+' √ó 35% √ó 12%</div></div>'
    +'<div><div style="font-size:.6rem;color:var(--t3);">TOTAL YOUR COMM</div><div style="color:var(--yellow);font-size:1.1rem;font-weight:600;">$'+total.toFixed(2)+'</div></div>'
    +'</div>';
}

function saveActuals(){
  var acctId=document.getElementById('act-acct-id').value;
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  var month=parseInt(document.getElementById('act-month').value);
  var year=parseInt(document.getElementById('act-year').value);
  var progGross=parseFloat(document.getElementById('act-prog-gross').value)||0;
  var progNet=parseFloat(document.getElementById('act-prog-net').value)||0;
  if(!a.actuals)a.actuals=[];
  var existing=a.actuals.find(function(x){return x.month===month&&x.year===year;});
  var entry={month:month,year:year,progGross:progGross,progNet:progNet,omni:JSON.parse(JSON.stringify(actOmniLines))};
  if(existing){Object.assign(existing,entry);}else{a.actuals.push(entry);}
  var comm=calcCommission(entry);
  a.history=a.history||[];
  a.history.push({date:new Date().toISOString(),type:'note',note:MONTHS[month]+' '+year+' actuals logged ‚Äî Prog: '+fmtM(progGross)+' gross / '+fmtM(progNet)+' net. Commission: $'+comm.toFixed(2)});
  saveAccounts(); closeM('m-actuals'); renderAccountDetail(acctId); toast('Actuals saved','ok');
}

function deleteActual(acctId,month,year){
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  a.actuals=(a.actuals||[]).filter(function(x){return !(x.month===month&&x.year===year);});
  saveAccounts(); renderAccountDetail(acctId); toast('Removed','err');
}

// History / Notes
function addHistoryNote(acctId){
  var note=prompt('Add a note for this account:'); if(!note)return;
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  a.history=a.history||[];
  a.history.push({date:new Date().toISOString(),type:'note',note:note.trim()});
  saveAccounts(); renderAccountDetail(acctId); toast('Note added','ok');
}

// Paste Inbox
function pasteInboxEmails(){ openM('m-paste-inbox'); document.getElementById('paste-inbox-text').value=''; document.getElementById('paste-inbox-result').style.display='none'; }
function pasteEmailForAccount(acctId){ openM('m-paste-inbox'); document.getElementById('paste-inbox-text').value=''; document.getElementById('paste-inbox-result').style.display='none'; document.getElementById('m-paste-inbox').setAttribute('data-acct',acctId); }

function runPasteInboxAI(){
  var text=document.getElementById('paste-inbox-text').value.trim();
  if(!text){toast('Paste some email text first','err');return;}
  var resultEl=document.getElementById('paste-inbox-result');
  resultEl.style.display='';
  resultEl.innerHTML='<div style="color:var(--t2);font-size:.78rem;font-style:italic;">‚ú¶ Analyzing emails...</div>';

  var acctId=document.getElementById('m-paste-inbox').getAttribute('data-acct')||'';
  var knownAccounts=accounts.map(function(a){return a.name+(a.orgId?' (ID:'+a.orgId+')':'');}).join(', ');
  var prompt='You are an AI assistant for a Simpli.fi Sales Director in East Tennessee. Analyze the following email(s) and return ONLY valid JSON.\n\nKNOWN ACCOUNTS: '+knownAccounts+'\n\nEMAILS:\n'+text+'\n\nReturn ONLY this JSON structure:\n{\n  "summary": "2-3 sentence plain English summary of what these emails are about",\n  "urgent": [{"subject":"email subject or topic","from":"sender","action":"what needs to happen","priority":"high/medium"}],\n  "todos": [{"text":"action item","priority":"high/medium/low","account":"matched account name or null"}],\n  "accountUpdates": [{"accountName":"matched account name","update":"what happened or was discussed","type":"email"}],\n  "suggestedReplies": [{"to":"recipient","subject":"subject","reply":"suggested short reply"}]\n}';

  fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,messages:[{role:'user',content:prompt}]})})
  .then(function(r){return r.json();})
  .then(function(data){
    var raw=(data.content&&data.content[0]&&data.content[0].text)||'{}';
    try {
      var result=JSON.parse(raw.replace(/```json|```/g,'').trim());
      applyPasteInboxResult(result,acctId);
    } catch(e){ resultEl.innerHTML='<div style="color:var(--red);">Parse error. Raw: '+escH(raw.substring(0,300))+'</div>'; }
  })
  .catch(function(e){ resultEl.innerHTML='<div style="color:var(--red);">Error: '+escH(e.message)+'</div>'; });
}

function applyPasteInboxResult(result,acctId){
  var resultEl=document.getElementById('paste-inbox-result');
  var html='<div style="padding:12px;background:var(--s2);border-radius:6px;">';
  html+='<div style="font-family:var(--mono);font-size:.6rem;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">‚ú¶ AI Analysis Complete</div>';
  if(result.summary) html+='<div style="font-size:.78rem;color:var(--white);margin-bottom:12px;line-height:1.6;">'+escH(result.summary)+'</div>';

  // Urgent
  if(result.urgent&&result.urgent.length){
    html+='<div style="font-family:var(--mono);font-size:.6rem;color:var(--red);margin-bottom:6px;">üî¥ URGENT</div>';
    result.urgent.forEach(function(u){ html+='<div style="background:rgba(255,59,48,.1);border:1px solid rgba(255,59,48,.3);border-radius:4px;padding:8px;margin-bottom:6px;font-size:.75rem;"><strong style="color:var(--white);">'+escH(u.subject||'')+'</strong><br><span style="color:var(--t2);">From: '+escH(u.from||'')+'</span><br><span style="color:var(--red);">‚Üí '+escH(u.action||'')+'</span></div>'; });
  }

  // Todos
  if(result.todos&&result.todos.length){
    html+='<div style="font-family:var(--mono);font-size:.6rem;color:var(--yellow);margin:10px 0 6px;">ACTION ITEMS</div>';
    result.todos.forEach(function(t){
      html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);">';
      html+='<div><div style="font-size:.75rem;color:var(--white);">'+escH(t.text||'')+'</div>'+(t.account?'<div style="font-size:.65rem;color:var(--t2);">'+escH(t.account)+'</div>':'')+'</div>';
      html+='<button class="btn btn-sm" onclick="addInboxTodo(\''+escH(t.text||'').replace(/'/g,"\\'")+'\')" style="font-size:.6rem;white-space:nowrap;">+ To-Do</button>';
      html+='</div>';
    });
  }

  // Account updates
  if(result.accountUpdates&&result.accountUpdates.length){
    html+='<div style="font-family:var(--mono);font-size:.6rem;color:var(--blue);margin:10px 0 6px;">ACCOUNT UPDATES</div>';
    result.accountUpdates.forEach(function(u){
      var matched=accounts.find(function(a){return a.name.toLowerCase().includes((u.accountName||'').toLowerCase())||(u.accountName||'').toLowerCase().includes(a.name.toLowerCase());});
      html+='<div style="padding:6px 0;border-bottom:1px solid var(--border);">';
      html+='<div style="font-size:.72rem;color:var(--green);">'+escH(u.accountName||'')+(matched?' ‚úì':' (no match)')+'</div>';
      html+='<div style="font-size:.75rem;color:var(--white);margin-top:2px;">'+escH(u.update||'')+'</div>';
      if(matched) html+='<button class="btn btn-sm" style="margin-top:4px;font-size:.6rem;" onclick="applyAccountHistoryUpdate(\''+matched.id+'\',\''+escH(u.update||'').replace(/'/g,"\\'")+'\')" >‚úì Save to '+escH(matched.name)+'</button>';
      html+='</div>';
    });
  }

  // Suggested replies
  if(result.suggestedReplies&&result.suggestedReplies.length){
    html+='<div style="font-family:var(--mono);font-size:.6rem;color:var(--purple);margin:10px 0 6px;">SUGGESTED REPLIES</div>';
    result.suggestedReplies.forEach(function(r){
      html+='<div style="padding:8px;background:rgba(130,80,255,.08);border:1px solid rgba(130,80,255,.2);border-radius:4px;margin-bottom:6px;font-size:.73rem;">';
      html+='<div style="color:var(--t2);">To: '+escH(r.to||'')+'  |  Subject: '+escH(r.subject||'')+'</div>';
      html+='<div style="color:var(--white);margin-top:4px;">'+escH(r.reply||'')+'</div>';
      html+='<button class="btn btn-sm" style="margin-top:6px;font-size:.6rem;" onclick="copyToClipboard(\''+escH(r.reply||'').replace(/'/g,"\\'")+'\')" >‚ßâ Copy Reply</button>';
      html+='</div>';
    });
  }

  html+='</div>';
  resultEl.innerHTML=html;

  // Auto-apply account updates
  if(result.accountUpdates){
    result.accountUpdates.forEach(function(u){
      if(acctId){
        var a=accounts.find(function(x){return x.id===acctId;});
        if(a){ a.history=a.history||[]; a.history.push({date:new Date().toISOString(),type:'email',note:u.update||''}); }
      }
    });
    saveAccounts();
  }
}

function applyAccountHistoryUpdate(acctId,update){
  var a=accounts.find(function(x){return x.id===acctId;}); if(!a)return;
  a.history=a.history||[];
  a.history.push({date:new Date().toISOString(),type:'email',note:update});
  saveAccounts();
  if(activeAccountId===acctId) renderAccountDetail(acctId);
  toast('Saved to '+a.name,'ok');
}

function copyToClipboard(text){ navigator.clipboard.writeText(text).then(function(){toast('Copied','ok');}); }


// ‚îÄ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var csvParsedRows=[];
var csvMappings={};

// Field definitions with aliases for fuzzy matching
var CSV_FIELDS=[
  {key:'firstName', label:'First Name', aliases:['first','firstname','first_name','fname','given name','given_name','forename']},
  {key:'lastName',  label:'Last Name',  aliases:['last','lastname','last_name','lname','surname','family name','family_name']},
  {key:'company',   label:'Company',    aliases:['company','organization','organisation','org','account','employer','business','firm','company name','account name']},
  {key:'phone',     label:'Phone',      aliases:['phone','tel','telephone','mobile','cell','direct','work phone','phone number','direct phone','mobile phone']},
  {key:'email',     label:'Email',      aliases:['email','e-mail','email address','work email','business email']},
  {key:'vertical',  label:'Vertical',   aliases:['vertical','industry','sector','category','niche']},
  {key:'stage',     label:'Stage',      aliases:['stage','status','lead status','pipeline stage','crm stage']},
  {key:'budget',    label:'Budget',     aliases:['budget','est budget','estimated budget','monthly budget','spend']},
  {key:'source',    label:'Source',     aliases:['source','lead source','how found','origin']},
  {key:'notes',     label:'Notes',      aliases:['notes','note','comments','comment','description','details']}
];

function fuzzyMatchField(header){
  var h=header.toLowerCase().trim().replace(/[^a-z0-9 _]/g,'');
  for(var i=0;i<CSV_FIELDS.length;i++){
    var f=CSV_FIELDS[i];
    if(f.aliases.indexOf(h)!==-1) return f.key;
    // partial match
    for(var j=0;j<f.aliases.length;j++){
      if(h.includes(f.aliases[j])||f.aliases[j].includes(h)) return f.key;
    }
  }
  return '';
}

function parseCSV(text){
  var lines=text.trim().split(/\r?\n/);
  if(lines.length<2) return null;
  // Detect delimiter
  var delim=text.indexOf('\t')!==-1&&text.split('\t').length>text.split(',').length?'\t':',';
  function splitLine(line){
    var result=[]; var cur=''; var inQ=false;
    for(var i=0;i<line.length;i++){
      var ch=line[i];
      if(ch==='"'){inQ=!inQ;}
      else if(ch===delim&&!inQ){result.push(cur.trim());cur='';}
      else{cur+=ch;}
    }
    result.push(cur.trim());
    return result;
  }
  var headers=splitLine(lines[0]);
  var rows=[];
  for(var i=1;i<lines.length;i++){
    if(!lines[i].trim()) continue;
    var vals=splitLine(lines[i]);
    var row={};
    headers.forEach(function(h,idx){row[h]=vals[idx]||'';});
    rows.push(row);
  }
  return {headers:headers, rows:rows};
}

function handleCSVFile(input){
  var file=input.files[0]; if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){ processCSVText(e.target.result); };
  reader.readAsText(file);
}

function parseCSVFromPaste(){
  var text=document.getElementById('csv-paste-text').value;
  if(!text.trim()){toast('Paste CSV text first','err');return;}
  processCSVText(text);
}

function processCSVText(text){
  var parsed=parseCSV(text);
  if(!parsed||!parsed.rows.length){toast('Could not parse CSV ‚Äî check format','err');return;}
  csvParsedRows=parsed.rows;
  // Auto-map columns
  csvMappings={};
  parsed.headers.forEach(function(h){ var match=fuzzyMatchField(h); if(match) csvMappings[h]=match; });
  showCSVStep2(parsed.headers);
}

function showCSVStep2(headers){
  document.getElementById('csv-step-1').style.display='none';
  document.getElementById('csv-step-2').style.display='';
  document.getElementById('csv-import-btn').style.display='';

  // Build mapping grid
  var fieldOptions=CSV_FIELDS.map(function(f){return '<option value="'+f.key+'">'+f.label+'</option>';}).join('');
  var html='';
  headers.forEach(function(h){
    var mapped=csvMappings[h]||'';
    html+='<div style="display:flex;align-items:center;gap:6px;">';
    html+='<div style="font-family:var(--mono);font-size:.7rem;color:var(--white);min-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="'+escH(h)+'">'+escH(h)+'</div>';
    html+='<span style="color:var(--t3);">‚Üí</span>';
    html+='<select class="fs" style="font-size:.7rem;flex:1;" data-csv-col="'+escH(h)+'" onchange="csvMappings[\''+escH(h).replace(/'/g,"\\'")+'\']=this.value">';
    html+='<option value="">‚Äî Skip ‚Äî</option>'+fieldOptions;
    html+='</select>';
    html+='</div>';
    // Set the selected value after render (done via JS below)
  });
  document.getElementById('csv-mapping-grid').innerHTML=html;

  // Set selected values
  headers.forEach(function(h){
    var sel=document.querySelector('[data-csv-col="'+escH(h)+'"]');
    if(sel&&csvMappings[h]) sel.value=csvMappings[h];
  });

  // Preview
  var previewRows=csvParsedRows.slice(0,3);
  var pHtml='<table style="border-collapse:collapse;width:100%"><thead><tr>'+headers.map(function(h){return '<th style="text-align:left;padding:3px 6px;font-family:var(--mono);font-size:.6rem;color:var(--t3);border-bottom:1px solid var(--border);">'+escH(h)+'</th>';}).join('')+'</tr></thead><tbody>';
  previewRows.forEach(function(row){
    pHtml+='<tr>'+headers.map(function(h){return '<td style="padding:3px 6px;font-size:.68rem;color:var(--t2);border-bottom:1px solid var(--border);white-space:nowrap;max-width:150px;overflow:hidden;text-overflow:ellipsis;">'+escH((row[h]||'').substring(0,40))+'</td>';}).join('')+'</tr>';
  });
  pHtml+='</tbody></table>';
  document.getElementById('csv-preview').innerHTML=pHtml;
  document.getElementById('csv-import-status').textContent=csvParsedRows.length+' rows detected';
}

function runCSVImport(){
  var skipDupes=document.getElementById('csv-skip-dupes').checked;
  var added=0; var skipped=0; var dupes=0;

  // Re-read current mappings from selects
  document.querySelectorAll('[data-csv-col]').forEach(function(sel){
    var col=sel.getAttribute('data-csv-col');
    csvMappings[col]=sel.value;
  });

  csvParsedRows.forEach(function(row){
    var c={id:uid(),firstName:'',lastName:'',company:'',phone:'',email:'',vertical:'',stage:'Cold',budget:'',source:'CSV Import',notes:'',lastContact:new Date().toISOString(),createdAt:new Date().toISOString(),callLog:[]};
    Object.keys(csvMappings).forEach(function(col){
      var field=csvMappings[col]; if(!field)return;
      var val=(row[col]||'').trim();
      if(val) c[field]=val;
    });

    // Must have at least a name or company
    if(!c.firstName&&!c.lastName&&!c.company){skipped++;return;}

    // Handle full name in firstName field
    if(c.firstName&&!c.lastName&&c.firstName.includes(' ')){
      var parts=c.firstName.trim().split(' ');
      c.firstName=parts[0];
      c.lastName=parts.slice(1).join(' ');
    }

    // Normalize stage
    var validStages=['Cold','Attempted Contact','Warm','Follow-Up Scheduled','Proposal Sent','Proposal Revision','At the Table','On Hold','Closed Won','Closed Lost','Active Client','Agency Partner'];
    if(!validStages.includes(c.stage)) c.stage='Cold';

    // Duplicate check
    if(skipDupes){
      var isDupe=contacts.some(function(x){
        return (x.firstName+' '+x.lastName).toLowerCase()===(c.firstName+' '+c.lastName).toLowerCase()&&x.company.toLowerCase()===c.company.toLowerCase();
      });
      if(isDupe){dupes++;return;}
    }

    contacts.push(c);
    added++;
  });

  saveAll(); refreshAll();

  // Show results
  document.getElementById('csv-step-2').style.display='none';
  document.getElementById('csv-step-3').style.display='';
  document.getElementById('csv-import-btn').style.display='none';
  var resHtml='<div style="text-align:center;padding:20px;">';
  resHtml+='<div style="font-size:2rem;margin-bottom:12px;">‚úì</div>';
  resHtml+='<div style="font-size:1rem;color:var(--white);font-weight:600;margin-bottom:8px;">Import Complete</div>';
  resHtml+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:16px 0;">';
  resHtml+='<div style="padding:12px;background:var(--s2);border-radius:6px;"><div style="font-size:1.4rem;color:var(--green);font-weight:700;">'+added+'</div><div style="font-size:.7rem;color:var(--t2);">Imported</div></div>';
  resHtml+='<div style="padding:12px;background:var(--s2);border-radius:6px;"><div style="font-size:1.4rem;color:var(--yellow);font-weight:700;">'+dupes+'</div><div style="font-size:.7rem;color:var(--t2);">Duplicates Skipped</div></div>';
  resHtml+='<div style="padding:12px;background:var(--s2);border-radius:6px;"><div style="font-size:1.4rem;color:var(--t3);font-weight:700;">'+skipped+'</div><div style="font-size:.7rem;color:var(--t2);">Rows Skipped</div></div>';
  resHtml+='</div>';
  resHtml+='<button class="btn btn-w" onclick="closeM(\'m-import-csv\');resetCSVImport()">Done</button>';
  resHtml+='</div>';
  document.getElementById('csv-import-results').innerHTML=resHtml;
  document.getElementById('csv-modal-footer').style.display='none';
}

function resetCSVImport(){
  csvParsedRows=[]; csvMappings={};
  document.getElementById('csv-step-1').style.display='';
  document.getElementById('csv-step-2').style.display='none';
  document.getElementById('csv-step-3').style.display='none';
  document.getElementById('csv-import-btn').style.display='none';
  document.getElementById('csv-modal-footer').style.display='';
  var fi=document.getElementById('csv-file-input'); if(fi) fi.value='';
  var pt=document.getElementById('csv-paste-text'); if(pt) pt.value='';
}

function openImportCSV(){ resetCSVImport(); openM('m-import-csv'); }

// Drag and drop
document.addEventListener('DOMContentLoaded',function(){
  var dz=document.getElementById('csv-drop-zone');
  if(!dz)return;
  dz.addEventListener('dragover',function(e){e.preventDefault();dz.style.borderColor='var(--white)';});
  dz.addEventListener('dragleave',function(){dz.style.borderColor='var(--border)';});
  dz.addEventListener('drop',function(e){
    e.preventDefault(); dz.style.borderColor='var(--border)';
    var file=e.dataTransfer.files[0]; if(!file)return;
    var reader=new FileReader();
    reader.onload=function(ev){processCSVText(ev.target.result);};
    reader.readAsText(file);
  });
});

// ‚îÄ‚îÄ‚îÄ AI ENRICHMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var enrichData={};

function openEnrich(contactId){
  var c=contacts.find(function(x){return x.id===contactId;}); if(!c)return;
  document.getElementById('enrich-contact-id').value=contactId;
  document.getElementById('enrich-contact-info').innerHTML='<strong>'+escH(c.firstName+' '+c.lastName)+'</strong> ¬∑ '+escH(c.company)+(c.vertical?' ¬∑ '+escH(c.vertical):'')+'<div style="margin-top:6px;font-size:.72rem;color:var(--t2);">Missing: '+((!c.phone&&!c.email)?'phone, email':!c.phone?'phone':'email')+'</div>';
  document.getElementById('enrich-status').textContent='Click Enrich to search for missing contact information.';
  document.getElementById('enrich-results').style.display='none';
  document.getElementById('enrich-save-btn').style.display='none';
  enrichData={};
  openM('m-enrich');
}

function runEnrich(){
  var contactId=document.getElementById('enrich-contact-id').value;
  var c=contacts.find(function(x){return x.id===contactId;}); if(!c)return;
  document.getElementById('enrich-status').textContent='‚ú¶ Searching for contact info...';

  var prompt='You are a B2B sales research assistant. Find publicly available contact information for this person.\n\nName: '+c.firstName+' '+c.lastName+'\nCompany: '+c.company+(c.vertical?'\nIndustry: '+c.vertical:'')+'\n\nReturn ONLY valid JSON (no markdown):\n{\n  "phone": "best guess direct phone or null",\n  "email": "best guess work email based on company domain and name patterns or null",\n  "emailConfidence": "high/medium/low",\n  "phoneConfidence": "high/medium/low",\n  "title": "their likely job title or null",\n  "notes": "any relevant info found (LinkedIn URL, company details, etc) or null",\n  "sources": "where this info likely comes from"\n}';

  fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:500,messages:[{role:'user',content:prompt}]})})
  .then(function(r){return r.json();})
  .then(function(data){
    var raw=(data.content&&data.content[0]&&data.content[0].text)||'{}';
    try{
      enrichData=JSON.parse(raw.replace(/```json|```/g,'').trim());
      showEnrichResults(enrichData,c);
    }catch(e){
      document.getElementById('enrich-status').textContent='Could not parse AI response. Try again.';
    }
  })
  .catch(function(e){
    document.getElementById('enrich-status').textContent='Error: '+e.message;
  });
}

function showEnrichResults(data,c){
  document.getElementById('enrich-status').textContent='Review the info below ‚Äî edit anything before saving.';
  document.getElementById('enrich-results').style.display='';
  document.getElementById('enrich-save-btn').style.display='';

  var confColor=function(conf){return conf==='high'?'var(--green)':conf==='medium'?'var(--yellow)':'var(--red)';};
  var html='';

  if(data.phone){
    html+='<div class="fg"><label class="fl">Phone <span style="font-size:.6rem;color:'+confColor(data.phoneConfidence)+';">‚óè '+( data.phoneConfidence||'?')+' confidence</span></label>';
    html+='<input class="fi" id="enrich-phone" value="'+escH(data.phone||'')+'" placeholder="Phone"></div>';
  }
  if(data.email){
    html+='<div class="fg"><label class="fl">Email <span style="font-size:.6rem;color:'+confColor(data.emailConfidence)+';">‚óè '+(data.emailConfidence||'?')+' confidence</span></label>';
    html+='<input class="fi" id="enrich-email" value="'+escH(data.email||'')+'" placeholder="Email"></div>';
  }
  if(data.title){
    html+='<div class="fg"><label class="fl">Title (found)</label>';
    html+='<input class="fi" id="enrich-title" value="'+escH(data.title||'')+'" placeholder="Title"></div>';
  }
  if(data.notes){
    html+='<div class="fg full"><label class="fl">Additional Notes</label>';
    html+='<textarea class="fta" id="enrich-notes" style="min-height:50px;">'+escH(data.notes||'')+'</textarea></div>';
  }
  if(!html) html='<div style="color:var(--t3);font-size:.78rem;padding:8px;">No additional info found for this contact. Try adding their title or more company detail manually.</div>';

  if(data.sources) html+='<div class="fg full"><div style="font-size:.65rem;color:var(--t3);padding:4px 0;">Source basis: '+escH(data.sources)+'</div></div>';

  document.getElementById('enrich-fields').innerHTML=html;
}

function saveEnrichedContact(){
  var contactId=document.getElementById('enrich-contact-id').value;
  var c=contacts.find(function(x){return x.id===contactId;}); if(!c)return;
  var phoneEl=document.getElementById('enrich-phone');
  var emailEl=document.getElementById('enrich-email');
  var notesEl=document.getElementById('enrich-notes');
  if(phoneEl&&phoneEl.value.trim()) c.phone=phoneEl.value.trim();
  if(emailEl&&emailEl.value.trim()) c.email=emailEl.value.trim();
  if(notesEl&&notesEl.value.trim()) c.notes=(c.notes?c.notes+'\n':'')+notesEl.value.trim();
  saveAll(); refreshAll(); closeM('m-enrich'); toast('Contact enriched','ok');
}

// ‚îÄ‚îÄ‚îÄ GMAIL SMART INBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var GMAIL_SCOPES='https://www.googleapis.com/auth/gmail.readonly';
var gmailToken=null;
var gmailEmails=[];
var inboxFilter='all';
var gapiLoaded=false;

function gmailConnect(){
  var clientId=(document.getElementById('gmail-client-id')||{}).value||lsGet('sc4_gmail_client_id')||'';
  if(!clientId){
    toast('Paste your Google Client ID first','err');
    return;
  }
  lsSet('sc4_gmail_client_id',clientId);

  // Load Google Identity Services
  if(!document.getElementById('gis-script')){
    var s=document.createElement('script');
    s.id='gis-script';
    s.src='https://accounts.google.com/gsi/client';
    s.onload=function(){ startGmailOAuth(clientId); };
    s.onerror=function(){ toast('Could not load Google auth. Check network/URL.','err'); };
    document.head.appendChild(s);
  } else {
    startGmailOAuth(clientId);
  }
}

function startGmailOAuth(clientId){
  try {
    var client=google.accounts.oauth2.initTokenClient({
      client_id:clientId,
      scope:GMAIL_SCOPES,
      callback:function(resp){
        if(resp.error){ toast('Auth failed: '+resp.error,'err'); return; }
        gmailToken=resp.access_token;
        lsSet('sc4_gmail_connected',true);
        onGmailConnected();
      }
    });
    client.requestAccessToken();
  } catch(e){
    toast('OAuth error: '+e.message+' ‚Äî Make sure you are on a hosted URL, not a local file.','err');
  }
}

function onGmailConnected(){
  document.getElementById('btn-gmail-connect').style.display='none';
  document.getElementById('btn-inbox-scan').style.display='';
  document.getElementById('btn-gmail-disconnect').style.display='';
  document.getElementById('inbox-setup-banner').style.display='none';
  document.getElementById('inbox-feed-wrap').style.display='';
  document.getElementById('inbox-status-bar').textContent='Gmail connected ‚Äî ready to scan';
  var addr=(document.getElementById('gmail-address')||{}).value||'your inbox';
  toast('Gmail connected: '+addr,'ok');
  // Auto-scan on connect
  gmailScan();
}

function gmailDisconnect(){
  gmailToken=null; gmailEmails=[];
  lsSet('sc4_gmail_connected',false);
  document.getElementById('btn-gmail-connect').style.display='';
  document.getElementById('btn-inbox-scan').style.display='none';
  document.getElementById('btn-gmail-disconnect').style.display='none';
  document.getElementById('inbox-feed-wrap').style.display='none';
  document.getElementById('inbox-setup-banner').style.display='';
  document.getElementById('inbox-status-bar').textContent='Disconnected';
  toast('Disconnected from Gmail','err');
}

function gmailScan(){
  if(!gmailToken){ toast('Connect Gmail first','err'); return; }
  document.getElementById('inbox-status-bar').textContent='Scanning inbox...';
  // Fetch last 30 messages
  fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=30&labelIds=INBOX',{
    headers:{Authorization:'Bearer '+gmailToken}
  })
  .then(function(r){ if(!r.ok) throw new Error('Gmail API: '+r.status); return r.json(); })
  .then(function(data){
    var msgs=data.messages||[];
    if(!msgs.length){ document.getElementById('inbox-status-bar').textContent='Inbox empty or no messages found'; return; }
    document.getElementById('inbox-status-bar').textContent='Loading '+msgs.length+' messages...';
    // Fetch each message (batch via Promise.all, max 30)
    var fetches=msgs.map(function(m){
      return fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/'+m.id+'?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date',{
        headers:{Authorization:'Bearer '+gmailToken}
      }).then(function(r){return r.json();});
    });
    return Promise.all(fetches);
  })
  .then(function(messages){
    if(!messages)return;
    gmailEmails=messages.map(function(m){
      var headers={}; (m.payload&&m.payload.headers||[]).forEach(function(h){ headers[h.name]=h.value; });
      return {
        id:m.id,
        subject:headers.Subject||'(no subject)',
        from:headers.From||'Unknown',
        date:headers.Date||'',
        snippet:m.snippet||'',
        threadId:m.threadId,
        labelIds:m.labelIds||[]
      };
    });
    document.getElementById('inbox-email-count').textContent=gmailEmails.length+' emails loaded';
    document.getElementById('inbox-status-bar').textContent='Scanned '+gmailEmails.length+' emails ‚Äî running AI analysis...';
    renderInboxList();
    runInboxAI();
  })
  .catch(function(e){
    document.getElementById('inbox-status-bar').textContent='Error: '+e.message;
    toast('Scan error: '+e.message,'err');
    if(e.message.includes('401')) { gmailToken=null; toast('Session expired ‚Äî reconnect Gmail','err'); }
  });
}

function renderInboxList(){
  var el=document.getElementById('inbox-email-list'); if(!el)return;
  var filtered=gmailEmails.filter(function(e){
    if(inboxFilter==='all') return true;
    if(inboxFilter==='urgent') return e._urgent;
    if(inboxFilter==='client') return e._isClient;
    if(inboxFilter==='internal') return !e._isClient;
    return true;
  });
  if(!filtered.length){ el.innerHTML='<div style="padding:20px;text-align:center;color:var(--t3);font-size:.78rem;">No emails match this filter.</div>'; return; }
  var html='';
  filtered.forEach(function(em){
    var urgentStyle=em._urgent?'border-left:3px solid var(--red);':'';
    var clientBadge=em._isClient?'<span style="background:var(--green);color:#000;font-size:.55rem;padding:1px 5px;border-radius:3px;margin-left:5px;">CLIENT</span>':'';
    var urgentBadge=em._urgent?'<span style="background:var(--red);color:#fff;font-size:.55rem;padding:1px 5px;border-radius:3px;margin-left:5px;">URGENT</span>':'';
    var fromName=em.from.replace(/<.*>/,'').trim()||em.from;
    var dateStr=''; try{ dateStr=new Date(em.date).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }catch(e){}
    html+='<div style="padding:12px 14px;border-bottom:1px solid var(--border);'+urgentStyle+'">';
    html+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">';
    html+='<div style="font-size:.78rem;color:var(--white);font-weight:500">'+escH(em.subject)+urgentBadge+clientBadge+'</div>';
    html+='<div style="font-size:.65rem;color:var(--t3);white-space:nowrap;margin-left:10px;">'+dateStr+'</div></div>';
    html+='<div style="font-size:.72rem;color:var(--t2);margin-bottom:4px;">'+escH(fromName)+'</div>';
    html+='<div style="font-size:.72rem;color:var(--t3);line-height:1.5;">'+escH((em.snippet||'').substring(0,140))+'...</div>';
    if(em._aiNote) html+='<div style="margin-top:6px;padding:6px 8px;background:var(--s2);border-radius:4px;font-size:.72rem;color:var(--yellow);">‚ú¶ '+escH(em._aiNote)+'</div>';
    if(em._suggestedReply) html+='<div style="margin-top:4px;display:flex;gap:6px;"><button class="btn btn-sm" onclick="showSuggestedReply(\''+em.id+'\')">‚ú¶ View Suggested Reply</button></div>';
    html+='</div>';
  });
  el.innerHTML=html;
}

function filterInbox(f){
  inboxFilter=f;
  ['all','urgent','client','internal'].forEach(function(k){
    var el=document.getElementById('if-'+k);
    if(el){ el.style.borderColor=k===f?'var(--white)':''; el.style.color=k===f?'var(--white)':''; }
  });
  renderInboxList();
}

function runInboxAI(){
  if(!gmailEmails.length) return;
  // Build context: list of contacts for matching
  var contactNames=contacts.map(function(c){return c.firstName+' '+c.lastName+' ('+c.company+')';}).join(', ');
  var emailSummaries=gmailEmails.slice(0,20).map(function(e,i){
    return (i+1)+'. FROM: '+e.from+' | SUBJECT: '+e.subject+' | DATE: '+e.date+'\nSNIPPET: '+e.snippet;
  }).join('\n\n');

  var prompt='You are an AI assistant for a Simpli.fi Sales Director in East Tennessee. Analyze these '+gmailEmails.length+' recent emails and return a JSON object.\n\nKNOWN CLIENTS/CONTACTS: '+contactNames+'\n\nEMAILS:\n'+emailSummaries+'\n\nReturn ONLY valid JSON (no markdown, no explanation):\n{\n  "summary": "2-3 sentence plain English summary of what is happening across the inbox today",\n  "urgentCount": number,\n  "emails": [\n    {\n      "index": 1,\n      "urgent": true/false,\n      "isClient": true/false,\n      "clientName": "matched contact name or null",\n      "aiNote": "one-sentence insight about this email, or null",\n      "actionNeeded": "brief action item or null",\n      "suggestedReply": "one short suggested reply sentence or null",\n      "updateHistory": true/false\n    }\n  ],\n  "todos": [\n    {"text": "action item", "priority": "high/medium/low", "contactName": "or null"}\n  ],\n  "clientUpdates": [\n    {"clientName": "name", "update": "what changed or was discussed"}\n  ]\n}';

  fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,messages:[{role:'user',content:prompt}]})})
  .then(function(r){return r.json();})
  .then(function(data){
    var raw=(data.content&&data.content[0]&&data.content[0].text)||'{}';
    var clean=raw.replace(/```json|```/g,'').trim();
    try {
      var result=JSON.parse(clean);
      applyInboxAI(result);
    } catch(e) {
      document.getElementById('inbox-ai-summary').textContent='AI analysis complete ‚Äî '+gmailEmails.length+' emails scanned. (Parse error ‚Äî raw: '+clean.substring(0,200)+')';
    }
  })
  .catch(function(e){
    document.getElementById('inbox-ai-summary').textContent='AI analysis error: '+e.message;
  });
}

function applyInboxAI(result){
  // Apply AI insights back to email objects
  if(result.emails){
    result.emails.forEach(function(aiE){
      var idx=(aiE.index||1)-1;
      if(gmailEmails[idx]){
        gmailEmails[idx]._urgent=!!aiE.urgent;
        gmailEmails[idx]._isClient=!!aiE.isClient;
        gmailEmails[idx]._clientName=aiE.clientName||null;
        gmailEmails[idx]._aiNote=aiE.aiNote||null;
        gmailEmails[idx]._suggestedReply=aiE.suggestedReply||null;
        gmailEmails[idx]._actionNeeded=aiE.actionNeeded||null;
      }
    });
  }

  // Summary
  var summaryEl=document.getElementById('inbox-ai-summary');
  if(summaryEl) summaryEl.innerHTML='<span style="color:var(--white)">'+escH(result.summary||'Analysis complete.')+'</span>';

  // Urgent alerts
  var urgentEmails=gmailEmails.filter(function(e){return e._urgent;});
  var urgentWrap=document.getElementById('inbox-urgent');
  var urgentList=document.getElementById('inbox-urgent-list');
  if(urgentEmails.length&&urgentWrap&&urgentList){
    urgentWrap.style.display='';
    var uHtml='';
    urgentEmails.forEach(function(e){
      uHtml+='<div style="background:rgba(255,59,48,.08);border:1px solid rgba(255,59,48,.3);border-radius:6px;padding:10px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">';
      uHtml+='<div><div style="font-size:.8rem;color:var(--white);font-weight:600;">'+escH(e.subject)+'</div>';
      uHtml+='<div style="font-size:.72rem;color:var(--t2);margin-top:2px;">'+escH(e.from.replace(/<.*>/,'').trim())+'</div>';
      if(e._actionNeeded) uHtml+='<div style="font-size:.72rem;color:var(--red);margin-top:4px;">‚Üí '+escH(e._actionNeeded)+'</div>';
      uHtml+='</div>';
      if(e._suggestedReply) uHtml+='<button class="btn btn-sm" style="border-color:var(--red);color:var(--red);" onclick="showSuggestedReply(\''+e.id+'\')">‚ú¶ Reply</button>';
      uHtml+='</div>';
    });
    urgentList.innerHTML=uHtml;
    // Update badge
    var badge=document.getElementById('nb-inbox');
    if(badge){ badge.textContent=urgentEmails.length; badge.style.display=''; }
  }

  // Auto-created Todos
  var todoEl=document.getElementById('inbox-auto-todos');
  if(todoEl&&result.todos&&result.todos.length){
    var tHtml='';
    result.todos.forEach(function(t){
      var prioColor=t.priority==='high'?'var(--red)':t.priority==='medium'?'var(--yellow)':'var(--t3)';
      tHtml+='<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">';
      tHtml+='<div><div style="font-size:.76rem;color:var(--white);">'+escH(t.text)+'</div>';
      if(t.contactName) tHtml+='<div style="font-size:.65rem;color:var(--t2);">'+escH(t.contactName)+'</div>';
      tHtml+='</div>';
      tHtml+='<div style="display:flex;align-items:center;gap:6px;">';
      tHtml+='<span style="font-size:.6rem;color:'+prioColor+';">'+t.priority+'</span>';
      tHtml+='<button class="btn btn-sm" onclick="addInboxTodo(\''+escH(t.text).replace(/'/g,"\\'")+'\')" style="font-size:.6rem;">+ Add</button>';
      tHtml+='</div></div>';
    });
    todoEl.innerHTML=tHtml;
  }

  // Client updates
  var cuEl=document.getElementById('inbox-client-updates');
  if(cuEl&&result.clientUpdates&&result.clientUpdates.length){
    var cuHtml='';
    result.clientUpdates.forEach(function(u){
      cuHtml+='<div style="padding:8px 0;border-bottom:1px solid var(--border);">';
      cuHtml+='<div style="font-size:.76rem;color:var(--green);font-weight:500;">'+escH(u.clientName||'Unknown')+'</div>';
      cuHtml+='<div style="font-size:.73rem;color:var(--t2);margin-top:2px;">'+escH(u.update||'')+'</div>';
      // Auto-update contact lastContact if we find a match
      var match=contacts.find(function(c){ return (c.firstName+' '+c.lastName).toLowerCase().includes((u.clientName||'').toLowerCase())||c.company.toLowerCase().includes((u.clientName||'').toLowerCase()); });
      if(match){
        cuHtml+='<div style="font-size:.65rem;color:var(--t3);margin-top:2px;">‚Ü≥ Matched: '+match.firstName+' '+match.lastName+' ('+match.company+')</div>';
        cuHtml+='<button class="btn btn-sm" style="margin-top:4px;font-size:.6rem;" onclick="applyClientUpdate(\''+match.id+'\',\''+escH(u.update||'').replace(/'/g,"\\'")+'\')" >‚úì Update Contact History</button>';
      }
      cuHtml+='</div>';
    });
    cuEl.innerHTML=cuHtml;
    // Update status bar
    document.getElementById('inbox-status-bar').textContent='Analysis complete ‚Äî '+urgentEmails.length+' urgent, '+(result.todos||[]).length+' action items, '+(result.clientUpdates||[]).length+' client updates';
  } else if(cuEl){
    cuEl.innerHTML='<div style="color:var(--t3);font-size:.75rem;">No client-specific updates found in this batch.</div>';
    document.getElementById('inbox-status-bar').textContent='Analysis complete ‚Äî '+urgentEmails.length+' urgent, '+(result.todos||[]).length+' action items';
  }

  renderInboxList();
}

function showSuggestedReply(emailId){
  var em=gmailEmails.find(function(e){return e.id===emailId;});
  if(!em||!em._suggestedReply) return;
  alert('Suggested reply:\n\n'+em._suggestedReply+'\n\nYou can copy this and paste into Gmail.');
}

function addInboxTodo(text){
  todos.unshift({id:uid(),text:text,done:false,auto:true,type:'inbox',due:'',priority:'high',createdAt:new Date().toISOString()});
  saveAll(); updateBadges(); toast('To-do added','ok');
}

function applyClientUpdate(contactId,update){
  var c=contacts.find(function(x){return x.id===contactId;}); if(!c)return;
  c.lastContact=new Date().toISOString();
  c.notes=(c.notes?c.notes+'\n':'')+('[Inbox '+new Date().toLocaleDateString()+']: '+update);
  saveAll(); toast('Contact updated','ok');
}

function generateInboxSummary(){ if(gmailEmails.length) runInboxAI(); else toast('Scan inbox first','err'); }

function initIntegrations(){
  loadIntSettings();
  // Check if previously connected
  var wasConnected=lsGet('sc4_gmail_connected');
  var savedClientId=lsGet('sc4_gmail_client_id');
  if(savedClientId&&document.getElementById('gmail-client-id')) document.getElementById('gmail-client-id').value=savedClientId;
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
tick();
setInterval(tick, 1000);
budgetM = CURM;
loadAll();
loadIntSettings();

</script>

</body></html>
